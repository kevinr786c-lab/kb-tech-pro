<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B DOCTOR | NODO MAESTRO ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;400;800&display=swap');
        :root { --main: #6366f1; --glow: rgba(99, 102, 241, 0.2); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fdfdff; color: #1e293b; overflow-x: hidden; }
        
        /* üíé ESTILO K.B TECH SOLUTION */
        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.3); border-radius: 2.5rem; }
        .card-cita { transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 2rem; border: 1px solid rgba(0,0,0,0.02); }
        .card-cita:hover { transform: scale(1.02) translateY(-4px); box-shadow: 0 20px 40px var(--glow); }

        /* üö• TRIAGE DE COLOR (ADN COMANDANTE) */
        .u-rojo { border-left: 12px solid #ef4444 !important; background: linear-gradient(90deg, #fef2f2 0%, white 100%); }
        .u-amarillo { border-left: 12px solid #f59e0b !important; background: linear-gradient(90deg, #fffbeb 0%, white 100%); }
        .u-verde { border-left: 12px solid #10b981 !important; background: linear-gradient(90deg, #f0fdf4 0%, white 100%); }
        .u-azul { border-left: 12px solid #6366f1 !important; background: linear-gradient(90deg, #eef2ff 0%, white 100%); }

        .btn-maestro { padding: 1rem; background: var(--main); color: white; border-radius: 1.25rem; font-weight: 800; transition: 0.3s; }
        .btn-maestro:active { transform: scale(0.9); }
        
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; transition: 0.3s; }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; transform: scale(1.2); }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10">

    <nav class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
        <div class="text-center md:text-left">
            <h1 class="text-5xl font-black italic uppercase tracking-tighter">K.B <span id="logo-tech" style="color: var(--main)">Doctor</span> ‚ú¶</h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.5em] mt-2 italic">Sincronizaci√≥n de Nodo Maestro Activa</p>
        </div>
        
        <div class="flex items-center gap-3 bg-white shadow-2xl p-3 rounded-[2rem] border border-slate-100">
            <span class="text-[9px] font-black uppercase text-indigo-600 pl-4 italic">Radar Temporal:</span>
            <input type="date" id="fechaAgenda" class="bg-transparent border-none text-[11px] font-black uppercase outline-none px-2 cursor-pointer">
        </div>
    </nav>

    <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-10">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="glass-panel p-8 shadow-sm border border-slate-100">
                <h3 class="text-[10px] font-black uppercase tracking-widest mb-6 text-indigo-600 italic">Identidad de Nodo</h3>
                <div id="doctor-info" class="space-y-2">
                    <p class="text-2xl font-black uppercase italic tracking-tighter" id="display-nombre-doc">Cargando...</p>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-ping"></div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase" id="display-especialidad">Sincronizando con B√∫nker...</p>
                    </div>
                </div>
                <hr class="my-8 border-slate-100">
                <div class="space-y-4">
                    <button onclick="window.location.href='asistente.html'" class="w-full py-5 bg-slate-900 text-white rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest hover:bg-indigo-600 transition shadow-xl">
                        Abrir Radar Recepci√≥n üë©‚Äçüíº
                    </button>
                    <button id="btn-logout" class="w-full py-3 border-2 border-slate-100 text-slate-400 rounded-[1.5rem] font-black text-[9px] uppercase hover:bg-rose-50 hover:text-rose-500 hover:border-rose-100 transition">
                        Cerrar Sesi√≥n üîê
                    </button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8">
            <div id="contenedor-citas" class="space-y-4">
                </div>
        </div>

    </main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// CONFIGURACI√ìN DE CONEXI√ìN
const supabase = createClient(
    "https://dgatsbnqgplalxwewpvs.supabase.co", 
    "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"
);

const maestroUI = {
    user: null,

    async init() {
        const { data } = await supabase.auth.getSession();
        if (!data.session) {
            window.location.href = 'index.html';
            return;
        }
        this.user = data.session.user;

        const { data: p } = await supabase.from('Usuarios').select('*').eq('id', this.user.id).single();
        if(p) {
            document.getElementById('display-nombre-doc').innerText = `Dr. ${p.nombre}`;
            document.getElementById('display-especialidad').innerText = p.especialidad || 'Especialista Registrado';
        }

        this.configurarCalendario();
        await this.cargarCitasDelDia();

        document.getElementById('btn-logout').onclick = async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        };
    },

    async cargarCitasDelDia() {
        const contenedor = document.getElementById('contenedor-citas');
        const fecha = this.obtenerFechaSeleccionada();

        contenedor.innerHTML = `
            <div class="p-20 text-center animate-pulse italic text-slate-400 uppercase text-[9px] tracking-[0.5em]">
                Escaneando actividad en el radar...
            </div>`;

        try {
            const { data: citas, error } = await supabase
                .from('Citas')
                .select(\`
                    *,
                    Pacientes (nombre, telefono),
                    Servicios (nombre)
                \`)
                .eq('doctor_id', this.user.id)
                .eq('fecha', fecha)
                .neq('estado', 'cancelado')
                .order('hora_inicio', { ascending: true });

            if (error) throw error;

            if (citas.length === 0) {
                contenedor.innerHTML = \`
                    <div class="p-20 text-center opacity-30 font-black italic uppercase tracking-widest text-xs">
                        Radar despejado: Sin actividad para este ciclo
                    </div>\`;
                return;
            }

            contenedor.innerHTML = citas.map(c => this.renderCita(c)).join('');
        } catch (error) {
            contenedor.innerHTML = \`<div class="p-10 text-center text-rose-500 font-bold text-xs uppercase">Falla de V√≠nculo: \${error.message}</div>\`;
        }
    },

    renderCita(cita) {
        const prioridad = this.calcularTriage(cita.estado);
        const hora = cita.hora_inicio.slice(0, 5);
        
        return \`
            <div class="card-cita \${prioridad} glass-panel p-8 mb-4 flex justify-between items-center shadow-sm bg-white">
                <div class="flex items-center gap-10">
                    <span class="text-4xl font-black italic text-indigo-600">\${hora}</span>
                    <div>
                        <h3 class="font-black text-slate-800 uppercase text-lg tracking-tighter">
                            \${cita.Pacientes?.nombre || 'PACIENTE EXTERNO'}
                        </h3>
                        <p class="text-[10px] font-bold text-slate-400 uppercase italic">
                            \${cita.Servicios?.nombre || 'PROCEDIMIENTO GENERAL'}
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <span class="text-[8px] font-black uppercase px-4 py-2 rounded-full bg-slate-50 tracking-widest text-slate-500 border border-slate-100">
                        \${cita.estado.toUpperCase()}
                    </span>
                    <button class="btn-maestro shadow-lg shadow-indigo-100" onclick="window.location.href='asistente.html'">
                        ü©∫
                    </button>
                </div>
            </div>\`;
    },

    calcularTriage(estado) {
        const e = estado.toLowerCase();
        if (['urgente', 'dolor'].includes(e)) return 'u-rojo';
        if (['pendiente', 'confirmado'].includes(e)) return 'u-amarillo';
        if (['atendiendo', 'en_consulta'].includes(e)) return 'u-azul';
        if (e === 'completado') return 'u-verde';
        return '';
    },

    obtenerFechaSeleccionada() {
        const input = document.getElementById('fechaAgenda');
        if (!input.value) {
            input.value = new Date().toISOString().slice(0, 10);
        }
        return input.value;
    },

    configurarCalendario() {
        document.getElementById('fechaAgenda').onchange = () => this.cargarCitasDelDia();
    }
};

maestroUI.init();
</script>
</body>
</html>
