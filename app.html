<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cita M√©dica | K.B Tech Solutions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.5s; }
        .legal-footer { font-size: 10px; color: #64748b; text-align: justify; line-height: 1.4; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center">

    <div class="max-w-md w-full bg-white min-h-screen shadow-2xl flex flex-col relative overflow-hidden">
        
        <header id="web-header" class="p-10 text-center text-white space-y-3 relative z-10 bg-slate-800">
            <div id="web-icon" class="text-6xl mb-2">üè•</div>
            <h1 id="web-doctor-name" class="text-3xl font-black italic tracking-tighter">Cargando M√©dico...</h1>
            <p id="web-especialidad" class="text-[10px] uppercase tracking-[0.3em] font-bold opacity-80 italic">Verificando Especialidad</p>
        </header>

        <main class="p-8 flex-grow space-y-8 relative z-10">
            
            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Estatus</p>
                    <p class="text-[11px] font-bold text-green-600 italic">DISPONIBLE</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Ubicaci√≥n</p>
                    <p class="text-[11px] font-bold text-slate-700 italic">Tijuana, B.C.</p>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-xs font-black uppercase text-slate-400 tracking-widest text-center">Datos del Paciente</h3>
                <input type="text" id="paciente-nombre" placeholder="Tu nombre completo" class="w-full p-5 bg-slate-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm">
                <input type="tel" id="paciente-tel" placeholder="WhatsApp (10 d√≠gitos)" class="w-full p-5 bg-slate-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm">
                
                <button onclick="enviarCita()" id="btn-submit" class="w-full py-5 bg-slate-800 text-white rounded-[2rem] font-black uppercase text-xs tracking-[0.2em] shadow-lg active:scale-95 transition-all">
                    Agendar mi Cita
                </button>
            </div>

            <div class="p-6 bg-slate-50 rounded-[2rem] border border-slate-100">
                <p class="text-[9px] font-black uppercase text-slate-400 mb-2 italic">Aviso de Privacidad (Cofepris)</p>
                <p class="legal-footer">Los datos proporcionados ser√°n tratados conforme a la LFPDPPP exclusivamente para la gesti√≥n de su consulta m√©dica en este establecimiento.</p>
            </div>
        </main>
    </div>

    <script>
        const URL_DB = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY_DB = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 

        const TEMAS = {
            1: { color: "#6366f1", icon: "üíé" },
            2: { color: "#f43f5e", icon: "üå∏" },
            3: { color: "#10b981", icon: "üåø" },
            4: { color: "#1e3a8a", icon: "üõ°Ô∏è" },
            5: { color: "#8b5cf6", icon: "üîÆ" }
        };

        // 1. CARGAR DATOS DEL DOCTOR AL ABRIR LA WEB
        async function cargarDoctor() {
            const params = new URLSearchParams(window.location.search);
            const docId = params.get('id');

            if (!docId) return console.error("No hay ID de doctor");

            const res = await fetch(`${URL_DB}/rest/v1/Perfiles_Medicos?id=eq.${docId}`, {
                headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}` }
            });
            const data = await res.json();

            if (data.length > 0) {
                const doc = data[0];
                const tema = TEMAS[doc.template_id] || TEMAS[1];

                // Aplicar estilo visual
                document.getElementById('web-header').style.backgroundColor = tema.color;
                document.getElementById('btn-submit').style.backgroundColor = tema.color;
                document.getElementById('web-icon').innerText = tema.icon;
                
                // Poner nombre y especialidad
                document.getElementById('web-doctor-name').innerText = "Dr. " + doc.nombre_doctor;
                document.getElementById('web-especialidad').innerText = doc.especialidad;
            }
        }

        // 2. ENVIAR LA CITA A LA BASE DE DATOS
        async function enviarCita() {
            const params = new URLSearchParams(window.location.search);
            const docId = params.get('id');
            const nombre = document.getElementById('paciente-nombre').value;
            const tel = document.getElementById('paciente-tel').value;

            if (!nombre || !tel) return alert("Por favor rellena tu nombre y tel√©fono.");

            // Desactivar bot√≥n para evitar doble clic
            const btn = document.getElementById('btn-submit');
            btn.innerText = "PROCESANDO...";
            btn.disabled = true;

            const res = await fetch(`${URL_DB}/rest/v1/Citas`, {
                method: 'POST',
                headers: { 
                    'apikey': KEY_DB, 
                    'Authorization': `Bearer ${KEY_DB}`, 
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal' 
                },
                body: JSON.stringify({
                    doctor_id: docId,
                    nombre_paciente: nombre,
                    telefono_paciente: tel,
                    hora: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                    fecha: new Date().toISOString().split('T')[0],
                    pagado: false
                })
            });

            if (res.ok) {
                alert("¬°Cita agendada con √©xito! El doctor te contactar√°.");
                location.reload();
            } else {
                alert("Hubo un error. Intenta de nuevo.");
                btn.innerText = "AGENDAR MI CITA";
                btn.disabled = false;
            }
        }

        cargarDoctor();
    </script>
</body>
</html>
