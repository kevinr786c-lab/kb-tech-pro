<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B DOCTOR | NODO MAESTRO ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;400;600;800&display=swap');
        :root { --main: #c5a059; --dark: #0f172a; --glow: rgba(197, 160, 89, 0.2); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; overflow-x: hidden; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(25px); border: 1px solid rgba(197, 160, 89, 0.1); border-radius: 2.5rem; }
        .card-cita { transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 2.2rem; border: 1px solid rgba(197, 160, 89, 0.05); }
        .card-cita:hover { transform: scale(1.01) translateY(-5px); box-shadow: 0 30px 60px -15px rgba(15, 23, 42, 0.1); }

        /* üö• TRIAGE DE RANGO (ADN K.B) */
        .r-nuevo { border-left: 10px solid #6366f1 !important; }
        .r-recurrente { border-left: 10px solid #10b981 !important; }
        .r-oro { border-left: 10px solid var(--main) !important; box-shadow: 0 0 20px var(--glow); }

        .btn-action { padding: 1.25rem; background: var(--dark); color: white; border-radius: 1.5rem; font-weight: 800; transition: 0.3s; }
        .btn-action:hover { background: var(--main); color: white; transform: translateY(-2px); }
        
        .kb-star { color: var(--main); text-shadow: 0 0 10px var(--glow); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--main); border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <nav class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-[#0f172a] rounded-2xl flex items-center justify-center shadow-2xl">
                <span class="kb-star text-3xl font-black">‚ú¶</span>
            </div>
            <div>
                <h1 class="text-4xl font-black italic uppercase tracking-tighter text-[#0f172a]">K.B <span style="color: var(--main)">Doctor</span></h1>
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.4em] italic">Nodo Maestro Operativo</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4 bg-white shadow-xl p-3 px-6 rounded-[2rem] border border-slate-50">
            <span class="text-[9px] font-black uppercase text-slate-400 italic">Ciclo Temporal</span>
            <input type="date" id="fechaAgenda" class="bg-transparent border-none text-sm font-black uppercase outline-none cursor-pointer text-[#c5a059]">
        </div>
    </nav>

    <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="glass-panel p-8 shadow-xl border border-white">
                <div class="text-center mb-8">
                    <div class="w-24 h-24 bg-slate-50 rounded-full mx-auto mb-4 border-4 border-white shadow-lg flex items-center justify-center overflow-hidden text-4xl">
                        ü©∫
                    </div>
                    <h3 class="text-2xl font-black uppercase italic tracking-tighter" id="display-nombre-doc">...</h3>
                    <p class="text-[10px] font-bold text-[#c5a059] uppercase tracking-widest mt-1" id="display-especialidad">Sincronizando ADN...</p>
                </div>
                
                <hr class="my-6 border-slate-100">
                
                <div class="space-y-3">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-dashed border-slate-200 mb-4">
                        <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest text-center">Cl√≠nica Asignada</p>
                        <p id="display-organizacion" class="text-[10px] font-bold text-center text-[#0f172a] uppercase mt-1">CARGANDO...</p>
                    </div>
                    <button onclick="window.location.href='asistente.html'" class="w-full py-5 bg-[#0f172a] text-white rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest hover:bg-[#c5a059] transition shadow-lg">
                        Radar Recepci√≥n üë©‚Äçüíº
                    </button>
                    <button id="btn-logout" class="w-full py-4 border border-slate-100 text-slate-400 rounded-[1.5rem] font-black text-[9px] uppercase hover:bg-rose-50 hover:text-rose-500 transition">
                        Cerrar B√∫nker üîê
                    </button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8">
            <div id="contenedor-citas" class="space-y-4"></div>
        </div>
    </main>

    <footer class="max-w-6xl mx-auto mt-12 mb-6 text-center">
        <p class="text-[9px] font-black uppercase tracking-[0.3em] text-slate-300 italic">
            POWERED BY <span class="text-[#c5a059]">K.B TECH SOLUTIONS</span> ‚ú¶ 2026
        </p>
    </footer>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient("https://ctvqjnckxmqeejbfwmkj.supabase.co", "sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w");

const maestroUI = {
    user: null,
    orgId: null,

    async init() {
        const { data } = await supabase.auth.getSession();
        if (!data.session) { window.location.href = 'index.html'; return; }
        this.user = data.session.user;

        // üì° Sincronizar Perfil y Organizaci√≥n
        const { data: p } = await supabase.from('Usuarios').select('*, Organizaciones(nombre)').eq('id', this.user.id).single();
        if(p) {
            document.getElementById('display-nombre-doc').innerText = `${p.nombre.toUpperCase()}`;
            document.getElementById('display-especialidad').innerText = p.especialidad || 'ESPECIALISTA ELITE';
            document.getElementById('display-organizacion').innerText = p.Organizaciones?.nombre || 'B√öNKER INDEPENDIENTE';
            this.orgId = p.organizacion_id;
        }

        this.configurarCalendario();
        await this.cargarCitasDelDia();

        document.getElementById('btn-logout').onclick = async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        };
    },

    async cargarCitasDelDia() {
        const contenedor = document.getElementById('contenedor-citas');
        const fecha = this.obtenerFechaSeleccionada();

        contenedor.innerHTML = `<div class="p-20 text-center animate-pulse italic text-slate-300 uppercase text-[9px] tracking-[0.4em]">Escaneando actividad en el radar...</div>`;

        try {
            // üõ°Ô∏è Filtro Multi-tenant: Solo citas de MI organizaci√≥n
            const { data: citas, error } = await supabase
                .from('Citas')
                .select('*, Pacientes(*), Servicios(nombre)')
                .eq('doctor_id', this.user.id)
                .eq('fecha', fecha)
                .eq('organizacion_id', this.orgId)
                .neq('estado', 'cancelado')
                .order('hora_inicio', { ascending: true });

            if (error) throw error;

            if (citas.length === 0) {
                contenedor.innerHTML = `<div class="glass-panel p-20 text-center opacity-30 font-black italic uppercase tracking-widest text-[10px] border-dashed border-2 border-slate-200">Radar Despejado: Sin actividad</div>`;
                return;
            }

            const htmlCitas = await Promise.all(citas.map(async (c) => {
                const { count } = await supabase.from('Citas').select('*', { count: 'exact', head: true }).eq('paciente_id', c.paciente_id).eq('estado', 'completado');
                let rango = 'r-nuevo';
                let tag = 'Paciente Nuevo';
                if(count >= 3) { rango = 'r-oro'; tag = 'Paciente ORO ‚ú¶'; }
                else if(count >= 1) { rango = 'r-recurrente'; tag = 'Recurrente'; }
                return this.renderCita(c, rango, tag);
            }));
            
            contenedor.innerHTML = htmlCitas.join('');
        } catch (error) {
            contenedor.innerHTML = `<div class="p-10 text-center text-rose-500 font-bold text-xs">Error de Enlace: ${error.message}</div>`;
        }
    },

    renderCita(cita, rangoClase, tag) {
        const hora = cita.hora_inicio.slice(0, 5);
        return `
            <div class="card-cita ${rangoClase} glass-panel p-6 px-8 flex justify-between items-center shadow-sm bg-white border-none mb-4">
                <div class="flex items-center gap-10">
                    <span class="text-4xl font-black italic text-[#0f172a] tracking-tighter">${hora}</span>
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[7px] font-black uppercase px-2 py-0.5 rounded-md bg-slate-100 text-slate-500">${tag}</span>
                        </div>
                        <h3 class="font-black text-slate-800 uppercase text-lg tracking-tighter">
                            ${cita.Pacientes?.nombre || 'PACIENTE EXTERNO'}
                        </h3>
                        <p class="text-[10px] font-bold text-slate-400 uppercase italic">
                            ${cita.Servicios?.nombre || 'CONSULTA GENERAL'}
                        </p>
                    </div>
                </div>
                
                <div class="flex items-center gap-6">
                    <div class="text-right">
                        <span class="block text-[7px] font-black text-slate-300 uppercase mb-1 tracking-widest">Estado</span>
                        <span class="text-[9px] font-black uppercase px-4 py-1.5 rounded-xl bg-[#0f172a] text-[#c5a059]">
                            ${cita.estado}
                        </span>
                    </div>
                    <button class="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center hover:bg-[#c5a059] hover:text-white transition shadow-sm text-xl" onclick="window.location.href='asistente.html'">
                        üîç
                    </button>
                </div>
            </div>`;
    },

    obtenerFechaSeleccionada() {
        const input = document.getElementById('fechaAgenda');
        if (!input.value) input.value = new Date().toLocaleDateString('en-CA');
        return input.value;
    },

    configurarCalendario() {
        document.getElementById('fechaAgenda').onchange = () => this.cargarCitasDelDia();
    }
};

maestroUI.init();
</script>
</body>
</html>
