<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B TECH | MASTER MIGRATION COMMAND</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;400;800&display=swap');
        body { margin: 0; background: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }
        canvas { position: fixed; top: 0; left: 0; z-index: 1; }
        .ui-layer { position: relative; z-index: 10; pointer-events: none; height: 100vh; width: 100vw; display: flex; flex-direction: column; justify-content: space-between; }
        .interactive { pointer-events: auto; }
        .glass-card { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 2.5rem; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.9); transition: 0.6s cubic-bezier(0.16, 1, 0.3, 1); position: absolute; width: 340px; }
        .glass-card:hover { background: rgba(255, 255, 255, 0.05); border-color: #6366f1; transform: translateY(-8px); }
        .status-badge { font-size: 8px; font-weight: 900; letter-spacing: 3px; text-transform: uppercase; padding: 4px 12px; border-radius: 99px; }
        .glow-text { text-shadow: 0 0 30px rgba(99, 102, 241, 0.5); }
        .scanner { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #6366f1, transparent); opacity: 0.3; animation: scan 4s linear infinite; z-index: 5; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        #audit-log { position: absolute; bottom: 40px; left: 40px; height: 200px; width: 450px; overflow: hidden; font-family: monospace; font-size: 9px; color: rgba(255,255,255,0.4); background: rgba(0,0,0,0.6); padding: 20px; border-radius: 1.5rem; border-left: 3px solid #6366f1; backdrop-filter: blur(10px); }
        .glitch { animation: glitch 0.4s ease; }
        @keyframes glitch { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); filter: hue-rotate(90deg); } 100% { transform: translate(0); } }
    </style>
</head>
<body>

    <div class="scanner"></div>

    <div class="ui-layer">
        <header class="p-12 flex justify-between items-start interactive">
            <div class="space-y-1">
                <h1 class="text-6xl font-black italic tracking-tighter glow-text italic">K.B <span class="text-indigo-500">TECH</span></h1>
                <p id="live-clock" class="text-[10px] font-mono text-white/30 uppercase tracking-[0.6em]"></p>
            </div>
            <div class="text-right">
                <div class="flex items-center gap-3 justify-end">
                    <span class="status-badge bg-indigo-500/10 text-indigo-400 border border-indigo-500/20">Protocolo de AbsorciÃ³n On</span>
                    <span class="status-badge bg-emerald-500/10 text-emerald-500 border border-emerald-500/20">Comandante Kevin</span>
                </div>
                <p class="text-[9px] font-black uppercase tracking-widest mt-3 opacity-30 italic italic">Tijuana Hub â€¢ Intelligence Panel</p>
            </div>
        </header>

        <div id="card-mxn" class="glass-card interactive">
            <p class="text-[10px] font-black uppercase text-indigo-400 tracking-[0.4em] mb-4 italic">Caja del BÃºnker</p>
            <p id="val-mxn" class="text-4xl font-black italic tracking-tighter glow-text">$0.00 MXN</p>
            <div class="mt-5 flex justify-between items-center text-[8px] font-bold text-white/20 uppercase italic border-t border-white/5 pt-4">
                <span>Fondos Totales</span>
                <span class="text-emerald-500 italic">Liquidado âœ¦</span>
            </div>
        </div>

        <div id="card-nodes" class="glass-card interactive">
            <p class="text-[10px] font-black uppercase text-indigo-400 tracking-[0.4em] mb-4 italic">Nodos Operativos</p>
            <p id="val-nodes" class="text-4xl font-black italic tracking-tighter glow-text">0</p>
            <div class="mt-5 flex justify-between items-center text-[8px] font-bold text-white/20 uppercase italic border-t border-white/5 pt-4">
                <span>Red Activa</span>
                <span class="text-indigo-500 animate-pulse italic">Online</span>
            </div>
        </div>

        <div id="card-pending" class="glass-card interactive">
            <p class="text-[10px] font-black uppercase text-amber-500 tracking-[0.4em] mb-4 italic">Migraciones en Curso</p>
            <p id="val-pending" class="text-4xl font-black italic tracking-tighter glow-text">0</p>
            <div class="mt-5 flex justify-between items-center text-[8px] font-bold text-white/20 uppercase italic border-t border-white/5 pt-4">
                <span>Esperando Orden</span>
                <span class="text-amber-500 italic italic">Manual Auth</span>
            </div>
        </div>

        <div id="audit-log" class="interactive">
            <div id="log-content" class="space-y-1">
                <p class="text-indigo-500 font-bold italic">> PROTOCOLO DE MIGRACIÃ“N INICIALIZADO</p>
                <p class="italic">> BUSCANDO SEÃ‘ALES DE PLATAFORMAS EXTERNAS...</p>
            </div>
        </div>

        <div class="w-full flex flex-col items-center pb-12 space-y-12">
            <div class="relative group interactive">
                <div class="absolute -inset-1 bg-indigo-500 rounded-full blur opacity-10 group-hover:opacity-40 transition duration-1000"></div>
                <input type="text" id="command-input" class="relative bg-black/90 border border-white/10 rounded-full px-16 py-7 w-[700px] text-sm font-bold focus:outline-none focus:border-indigo-500/50 transition-all uppercase italic tracking-[0.3em] text-center shadow-2xl" placeholder="ORDEN: (SYNC, LIST, ACTIVATE [ID], MIGRATE [ID])">
            </div>
            
            <footer class="text-center space-y-4 interactive">
                <h3 class="text-7xl font-black italic uppercase glow-text tracking-widest" style="text-shadow: 0 0 50px rgba(99, 102, 241, 0.8);">Hazlo por Emily</h3>
                <p class="text-[10px] font-black text-white/20 tracking-[1em] uppercase italic">Control de EvoluciÃ³n Digital â€¢ K.B Tech Solutions</p>
            </footer>
        </div>
    </div>

    <script>
        const URL_DB = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY_DB = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 

        // --- ðŸŒ HOLOGRAMA ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const planet = new THREE.Mesh(new THREE.SphereGeometry(4.2, 32, 32), new THREE.MeshBasicMaterial({ color: 0x6366f1, wireframe: true, transparent: true, opacity: 0.1 }));
        scene.add(planet);
        camera.position.z = 11;

        function updateUIPos() {
            const nodes = [{ id: 'card-mxn', x: 6.5, y: 1.8 }, { id: 'card-nodes', x: 6.5, y: -1.2 }, { id: 'card-pending', x: -6.5, y: 1 }];
            nodes.forEach(n => {
                const vector = new THREE.Vector3(n.x, n.y, 0).project(camera);
                const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                const y = (vector.y * -0.5 + 0.5) * window.innerHeight;
                const el = document.getElementById(n.id);
                if(el) { el.style.left = `${x - 170}px`; el.style.top = `${y - 60}px`; }
            });
        }

        function animate() { requestAnimationFrame(animate); planet.rotation.y += 0.001; updateUIPos(); renderer.render(scene, camera); }
        animate();

        // --- ðŸ“Š LÃ“GICA DE MIGRACIÃ“N ---
        async function syncBunker() {
            try {
                document.querySelectorAll('.glass-card').forEach(c => c.classList.add('glitch'));
                const res = await fetch(`${URL_DB}/rest/v1/Perfiles_Medicos`, { headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}` } });
                const docs = await res.json();
                
                const activos = docs.filter(d => d.activado === true).length;
                const pendientes = docs.filter(d => d.activado !== true).length;

                document.getElementById('val-nodes').innerText = activos;
                document.getElementById('val-pending').innerText = pendientes;

                const resCitas = await fetch(`${URL_DB}/rest/v1/Citas?pagado=eq.true`, { headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}` } });
                const citas = await resCitas.json();
                const total = citas.reduce((sum, c) => sum + parseFloat(c.monto || 0), 0);
                document.getElementById('val-mxn').innerText = `$${total.toLocaleString()}.00 MXN`;

                addLog(`ABSORCIÃ“N: ${pendientes} NODOS DETECTADOS DESDE PLATAFORMAS EXTERNAS.`);
            } catch(e) { addLog("ERR: INTERRUPCIÃ“N EN EL CANAL DE DATOS."); }
        }

        document.getElementById('command-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const parts = this.value.toUpperCase().trim().split(' ');
                ejecutarComando(parts[0], parts[1]);
                this.value = '';
            }
        });

        async function ejecutarComando(cmd, arg) {
            addLog(`INSTRUCCIÃ“N: ${cmd}`);
            if (cmd === 'SYNC') syncBunker();
            if (cmd === 'ACTIVATE' && arg) {
                const res = await fetch(`${URL_DB}/rest/v1/Perfiles_Medicos?id=eq.${arg}`, {
                    method: 'PATCH',
                    headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ activado: true, migrado: false }) // Activamos pero marcamos que falta migraciÃ³n
                });
                if(res.ok) { addLog(`Ã‰XITO: NODO ${arg} ACTIVADO. PROTOCOLO DE MIGRACIÃ“N STANDBY.`); syncBunker(); }
            }
            if (cmd === 'MIGRATE' && arg) {
                addLog(`INICIANDO ABSORCIÃ“N DE DATOS PARA NODO ${arg}...`);
                // AquÃ­ simularÃ­amos la IA Gemini trabajando
                setTimeout(() => addLog(`NODO ${arg}: MIGRACIÃ“N COMPLETADA AL 100%.`), 3000);
            }
            if (cmd === 'LIST') {
                const res = await fetch(`${URL_DB}/rest/v1/Perfiles_Medicos?activado=is.false`, { headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}` } });
                const pend = await res.json();
                pend.forEach(p => addLog(`MIGRACIÃ“N PENDIENTE: ${p.nombre_doctor} (ID: ${p.id.substring(0,5)})`));
            }
        }

        function addLog(msg) {
            const log = document.getElementById('log-content');
            const p = document.createElement('p');
            p.innerText = `> ${new Date().toLocaleTimeString()} ${msg}`;
            log.prepend(p);
            if(log.children.length > 12) log.lastChild.remove();
        }

        setInterval(syncBunker, 60000);
        syncBunker();
        setInterval(() => {
            document.getElementById('live-clock').innerText = new Date().toLocaleString('es-MX') + " | MIGRATION_CORE_READY";
        }, 1000);
    </script>
</body>
</html>
