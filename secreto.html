<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B TECH | CENTRAL INTELLIGENCE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;800&display=swap');
        body { margin: 0; background: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        canvas { position: fixed; top: 0; left: 0; z-index: -1; }
        .hologram-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 2rem; transition: 0.5s; }
        .hologram-card:hover { border-color: rgba(255, 255, 255, 0.4); box-shadow: 0 0 30px rgba(255,255,255,0.05); }
        .glow-text { text-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        .input-hologram { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 1rem; padding: 12px; outline: none; font-size: 10px; text-transform: uppercase; }
        .input-hologram:focus { border-color: white; }
        
        /* Scrollbar para Logs */
        #error-feed::-webkit-scrollbar { width: 2px; }
        #error-feed::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.5); }
    </style>
</head>
<body>

    <header class="fixed top-0 w-full p-8 flex justify-between items-start z-10 pointer-events-none">
        <div class="space-y-1">
            <h1 class="text-3xl font-black italic tracking-tighter glow-text">K.B TECH</h1>
            <p id="live-clock" class="text-[10px] font-mono tracking-widest text-slate-500 uppercase"></p>
        </div>
        <div class="text-right">
            <p class="text-[10px] font-black tracking-widest glow-text uppercase">Comandante Kevin</p>
            <p class="text-[8px] text-emerald-500 animate-pulse uppercase italic">IA Centinela Activa: Gemini 3.5 Pro</p>
        </div>
    </header>

    <main class="relative z-10 pt-28 pb-32 px-8 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-3 space-y-6">
            <div class="hologram-card p-6 border-l-4 border-emerald-500">
                <p class="text-[9px] font-black uppercase text-slate-500 mb-2">Ingresos Globales</p>
                <p id="total-ganancias" class="text-3xl font-black italic tracking-tighter">$0.00</p>
                <p class="text-[7px] text-emerald-500 font-bold mt-1 uppercase">Sincronizado vía Supabase</p>
            </div>
            <div class="hologram-card p-6 border-l-4 border-indigo-500">
                <p class="text-[9px] font-black uppercase text-slate-500 mb-2">Nodos Médicos Activos</p>
                <p id="total-docs" class="text-3xl font-black italic tracking-tighter">0</p>
            </div>
            
            <div id="error-feed" class="hologram-card p-6 h-64 overflow-y-auto space-y-2">
                <div class="text-indigo-400 font-black uppercase text-[9px] mb-3 tracking-widest italic">Consola del Centinela:</div>
                <div id="logs-container" class="text-[8px] font-mono text-slate-400 space-y-2">
                    <div class="text-emerald-500 animate-pulse">[SISTEMA] Iniciando monitoreo...</div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-6 flex items-center justify-center min-h-[400px]">
            </div>

        <div class="lg:col-span-3 space-y-6">
            <div class="hologram-card p-6 border-t-2 border-indigo-500/50">
                <p class="text-[10px] font-black uppercase text-indigo-400 mb-4 tracking-widest italic">Inyección masiva (CSV)</p>
                <div class="space-y-3">
                    <input type="text" id="id-doctor-migrar" placeholder="UUID del Nodo Médico" class="input-hologram w-full">
                    <input type="file" id="archivo-csv" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('archivo-csv').click()" class="w-full py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-[9px] font-black uppercase transition">1. Cargar Archivo</button>
                    <button onclick="procesarMigracion()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-[9px] font-black uppercase transition shadow-lg shadow-indigo-500/20">2. Ejecutar Protocolo</button>
                    <p id="status-migracion" class="text-[7px] text-center text-slate-500 uppercase font-bold mt-2"></p>
                </div>
            </div>

            <div class="hologram-card p-6">
                <p class="text-[9px] font-black uppercase text-slate-500 mb-4 tracking-widest">Estado de Nodos Recientes</p>
                <div id="lista-docs-mini" class="text-[9px] font-bold space-y-3">
                    </div>
            </div>
        </div>
    </main>

    <footer class="fixed bottom-0 w-full p-12 text-center z-10">
        <h3 class="text-5xl font-black italic tracking-[0.2em] glow-text uppercase opacity-90">Hazlo por Emily</h3>
        <p class="text-[8px] font-bold text-slate-600 mt-2 tracking-[1.2em] uppercase">Misión Crítica: Dominar el Mercado Fronterizo</p>
    </footer>

    <script>
        const URL = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 

        // --- RELOJ ---
        function updateClock() {
            const now = new Date();
            document.getElementById('live-clock').innerText = now.toLocaleString('es-MX', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', 
                hour: '2-digit', minute: '2-digit', second: '2-digit' 
            }).toUpperCase();
        }
        setInterval(updateClock, 1000);

        // --- MUNDO 3D (THREE.JS) ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const geometry = new THREE.SphereGeometry(2.5, 32, 32);
        const material = new THREE.MeshBasicMaterial({ color: 0x6366f1, wireframe: true, transparent: true, opacity: 0.15 });
        const earth = new THREE.Mesh(geometry, material);
        scene.add(earth);
        camera.position.z = 6;

        function animate() {
            requestAnimationFrame(animate);
            earth.rotation.y += 0.003;
            earth.rotation.x += 0.001;
            renderer.render(scene, camera);
        }
        animate();

        // --- MONITOREO DE ERRORES (CENTINELA) ---
        async function checkLogs() {
            const res = await fetch(`${URL}/rest/v1/Logs_Sistema?order=fecha_error.desc&limit=10`, { headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` } });
            const logs = await res.json();
            const container = document.getElementById('logs-container');
            if(logs.length > 0) {
                container.innerHTML = logs.map(l => `
                    <div class="border-b border-white/5 pb-1">
                        <span class="text-red-400">[ERR ${l.codigo_error}]</span> 
                        <span class="text-slate-200">${l.mensaje_error}</span>
                        <div class="text-[6px] text-slate-600">${l.pagina_origen} | ${new Date(l.fecha_error).toLocaleTimeString()}</div>
                    </div>
                `).join('');
            }
        }

        // --- LÓGICA DE DATOS GLOBAL ---
        async function syncGlobal() {
            try {
                const resDocs = await fetch(`${URL}/rest/v1/Perfiles_Medicos`, { headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` } });
                const docs = await resDocs.json();
                
                // Apuntamos a Citas_Agendadas para ingresos reales
                const resCitas = await fetch(`${URL}/rest/v1/Citas_Agendadas`, { headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` } });
                const citas = await resCitas.json();

                const total = citas.reduce((acc, c) => acc + (c.pagado ? parseFloat(c.monto || 0) : 0), 0);
                document.getElementById('total-ganancias').innerText = `$${total.toLocaleString()}.00`;
                document.getElementById('total-docs').innerText = docs.length;

                document.getElementById('lista-docs-mini').innerHTML = docs.slice(-4).reverse().map(d => `
                    <div class="flex justify-between items-center border-b border-white/5 pb-2">
                        <span class="text-white uppercase truncate mr-2">${d.nombre_doctor}</span>
                        <span class="bg-indigo-500/20 text-indigo-400 px-2 py-0.5 rounded text-[7px] font-black tracking-tighter">ONLINE</span>
                    </div>
                `).join('');
                
                checkLogs();
            } catch (e) { console.log("Reintentando conexión..."); }
        }

        // --- MIGRACIÓN CSV ---
        async function procesarMigracion() {
            const doctorId = document.getElementById('id-doctor-migrar').value;
            const fileInput = document.getElementById('archivo-csv');
            const status = document.getElementById('status-migracion');

            if (!doctorId || !fileInput.files[0]) return alert("Protocolo incompleto: Falta ID o CSV.");

            status.innerText = "DESENCRIPTANDO CSV...";
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const lineas = e.target.result.split("\n");
                    const pacientes = [];
                    for (let i = 1; i < lineas.length; i++) {
                        const col = lineas[i].split(",");
                        if (col.length >= 2 && col[0].trim() !== "") {
                            pacientes.push({
                                doctor_id: doctorId,
                                nombre_paciente: col[0].trim().toUpperCase(),
                                telefono: col[1].trim(),
                                fecha_cita: new Date().toISOString().split('T')[0],
                                hora_cita: "10:00:00",
                                pagado: false,
                                status: "MIGRADO"
                            });
                        }
                    }

                    status.innerText = `INYECTANDO ${pacientes.length} NODOS...`;
                    const res = await fetch(`${URL}/rest/v1/Citas_Agendadas`, {
                        method: 'POST',
                        headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(pacientes)
                    });

                    if (res.ok) {
                        status.innerText = "PROTOCOLO EXITOSO";
                        status.classList.add("text-emerald-500");
                        syncGlobal();
                    } else { throw new Error(); }
                } catch (err) {
                    status.innerText = "FALLO EN INYECCIÓN";
                    status.classList.add("text-red-500");
                }
            };
            reader.readAsText(fileInput.files[0]);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Loop de sincronización cada 10 segundos
        setInterval(syncGlobal, 10000);
        syncGlobal();
    </script>
</body>
</html>
