<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B TECH | CENTRAL INTELLIGENCE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;800&display=swap');
        body { margin: 0; background: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        canvas { position: fixed; top: 0; left: 0; z-index: -1; }
        .hologram-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 2rem; transition: 0.5s; }
        .hologram-card:hover { border-color: rgba(255, 255, 255, 0.4); box-shadow: 0 0 30px rgba(255,255,255,0.05); }
        .glow-text { text-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        .input-hologram { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 1rem; padding: 12px; outline: none; font-size: 12px; }
        .input-hologram:focus { border-color: white; }
    </style>
</head>
<body>

    <header class="fixed top-0 w-full p-8 flex justify-between items-start z-10 pointer-events-none">
        <div class="space-y-1">
            <h1 class="text-3xl font-black italic tracking-tighter glow-text">K.B TECH</h1>
            <p id="live-clock" class="text-[10px] font-mono tracking-widest text-slate-500 uppercase"></p>
        </div>
        <div class="text-right">
            <p class="text-[10px] font-black tracking-widest glow-text uppercase">Comandante Kevin</p>
            <p class="text-[8px] text-emerald-500 animate-pulse uppercase">Conexión Segura Establecida</p>
        </div>
    </header>

    <main class="relative z-10 pt-28 pb-32 px-8 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-3 space-y-6">
            <div class="hologram-card p-6">
                <p class="text-[9px] font-black uppercase text-slate-500 mb-2">Ingresos de la Red</p>
                <p id="total-ganancias" class="text-3xl font-black italic tracking-tighter">$0.00</p>
            </div>
            <div class="hologram-card p-6">
                <p class="text-[9px] font-black uppercase text-slate-500 mb-2">Nodos Activos</p>
                <p id="total-docs" class="text-3xl font-black italic tracking-tighter">0</p>
            </div>
            <div id="error-feed" class="hologram-card p-4 text-[7px] font-mono text-slate-500 space-y-1">
                <div class="text-indigo-400 font-bold uppercase mb-2">Logs del Sistema:</div>
                <div>[OK] SYNC_MASTER_DB</div>
                <div class="text-emerald-500">[LIVE] MONITORING_TIJUANA...</div>
            </div>
        </div>

        <div class="lg:col-span-6 flex items-center justify-center min-h-[400px]">
            </div>

        <div class="lg:col-span-3 space-y-6">
            <div class="hologram-card p-6 border-indigo-500/30">
                <p class="text-[10px] font-black uppercase text-indigo-400 mb-4 tracking-widest italic">Migración Guante Blanco</p>
                <div class="space-y-3">
                    <input type="text" id="id-doctor-migrar" placeholder="ID del Nodo (Doctor)" class="input-hologram w-full">
                    <input type="file" id="archivo-csv" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('archivo-csv').click()" class="w-full py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-[9px] font-black uppercase transition">1. Cargar CSV</button>
                    <button onclick="procesarMigracion()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-[9px] font-black uppercase transition shadow-lg">2. Iniciar Migración</button>
                    <p id="status-migracion" class="text-[7px] text-center text-slate-500 uppercase font-bold mt-2"></p>
                </div>
            </div>

            <div class="hologram-card p-6">
                <p class="text-[9px] font-black uppercase text-slate-500 mb-4 tracking-widest">Nodos Recientes</p>
                <div id="lista-docs-mini" class="text-[9px] font-bold space-y-3">
                    </div>
            </div>
        </div>
    </main>

    <footer class="fixed bottom-0 w-full p-12 text-center z-10">
        <h3 class="text-5xl font-black italic tracking-[0.2em] glow-text uppercase opacity-90">Hazlo por Emily</h3>
        <p class="text-[8px] font-bold text-slate-600 mt-2 tracking-[1.2em] uppercase">Razón de Ser del Ecosistema K.B Tech</p>
    </footer>

    <script>
        const URL = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 

        // --- RELOJ ---
        function updateClock() {
            const now = new Date();
            document.getElementById('live-clock').innerText = now.toLocaleString('es-MX', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', 
                hour: '2-digit', minute: '2-digit', second: '2-digit' 
            }).toUpperCase();
        }
        setInterval(updateClock, 1000);

        // --- MUNDO 3D (THREE.JS) ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const geometry = new THREE.SphereGeometry(2.5, 64, 64);
        const material = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true, transparent: true, opacity: 0.1 });
        const earth = new THREE.Mesh(geometry, material);
        scene.add(earth);
        camera.position.z = 6;

        function animate() {
            requestAnimationFrame(animate);
            earth.rotation.y += 0.002;
            earth.rotation.x += 0.001;
            renderer.render(scene, camera);
        }
        animate();

        // --- LÓGICA DE DATOS ---
        async function syncGlobal() {
            const resDocs = await fetch(`${URL}/rest/v1/Perfiles_Medicos`, { headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` } });
            const docs = await resDocs.json();
            
            const resCitas = await fetch(`${URL}/rest/v1/Citas`, { headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` } });
            const citas = await resCitas.json();

            const total = citas.reduce((acc, c) => acc + (c.pagado ? parseFloat(c.monto || 0) : 0), 0);
            document.getElementById('total-ganancias').innerText = `$${total.toLocaleString()}.00`;
            document.getElementById('total-docs').innerText = docs.length;

            document.getElementById('lista-docs-mini').innerHTML = docs.slice(-4).reverse().map(d => `
                <div class="flex justify-between items-center border-b border-white/5 pb-2">
                    <span class="text-white uppercase">${d.nombre_doctor.slice(0,18)}</span>
                    <span class="bg-emerald-500/10 text-emerald-500 px-2 py-0.5 rounded text-[7px]">LIVE</span>
                </div>
            `).join('');
        }

        // --- MIGRACIÓN CSV ---
        async function procesarMigracion() {
            const doctorId = document.getElementById('id-doctor-migrar').value;
            const fileInput = document.getElementById('archivo-csv');
            const status = document.getElementById('status-migracion');

            if (!doctorId || !fileInput.files[0]) return alert("Faltan datos para migrar.");

            status.innerText = "PROCESANDO ARCHIVO...";
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const lineas = e.target.result.split("\n");
                    const pacientes = [];
                    // Formato esperado: Nombre, Telefono
                    for (let i = 1; i < lineas.length; i++) {
                        const col = lineas[i].split(",");
                        if (col.length >= 2 && col[0].trim() !== "") {
                            pacientes.push({
                                doctor_id: doctorId,
                                nombre_paciente: col[0].trim(),
                                telefono_paciente: col[1].trim(),
                                fecha: new Date().toISOString().split('T')[0],
                                pagado: false,
                                monto: 0
                            });
                        }
                    }

                    status.innerText = `INYECTANDO ${pacientes.length} PACIENTES...`;

                    const res = await fetch(`${URL}/rest/v1/Citas`, {
                        method: 'POST',
                        headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(pacientes)
                    });

                    if (res.ok) {
                        status.innerText = "MIGRACIÓN EXITOSA";
                        status.classList.add("text-emerald-500");
                        syncGlobal();
                    } else { throw new Error(); }
                } catch (err) {
                    status.innerText = "ERROR EN FORMATO CSV";
                    status.classList.add("text-red-500");
                }
            };
            reader.readAsText(fileInput.files[0]);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        syncGlobal();
    </script>
</body>
</html>
