<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RESERVACI√ìN √âLITE | K.B TECH PRO ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;500;800&display=swap');
        :root { --main: #c5a059; } 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fafafa; color: #0f172a; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.7); box-shadow: 0 40px 100px -20px rgba(0,0,0,0.05); }
        .input-premium { width: 100%; padding: 1.25rem; border-radius: 1.5rem; background: #fff; border: 1px solid #f1f5f9; font-weight: 600; transition: 0.4s; outline: none; }
        .input-premium:focus { border-color: var(--main); box-shadow: 0 10px 25px -10px var(--main); }
        .scroll-calendar { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none; }
        .scroll-calendar::-webkit-scrollbar { display: none; }
        .date-card { min-width: 65px; aspect-ratio: 1/1.2; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; border-radius: 1.2rem; border: 1px solid #f1f5f9; cursor: pointer; transition: 0.3s; }
        .date-card.selected { background: var(--main); color: white; transform: scale(1.05); }
        .time-pill { padding: 12px; border-radius: 1.25rem; background: #fff; border: 1px solid #f1f5f9; font-weight: 800; font-size: 0.75rem; text-align: center; cursor: pointer; transition: 0.3s; }
        .time-pill.selected { background: var(--main); color: white; }
        .btn-lujo { width: 100%; border-radius: 1.5rem; background: #0f172a; color: white; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; transition: 0.4s; }
        .btn-lujo:hover:not(:disabled) { background: var(--main); transform: translateY(-3px); }
        #elite-toast { position: fixed; top: 2rem; left: 50%; transform: translateX(-50%) translateY(-250%); background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); padding: 1.5rem 3rem; border-radius: 2rem; z-index: 10000; transition: 0.6s; border: 1px solid rgba(255,255,255,0.1); }
        #elite-toast.active { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="elite-toast"><p id="toast-msg" class="text-white font-black uppercase italic tracking-widest text-[10px] text-center"></p></div>

    <div class="max-w-md w-full glass-card p-8 md:p-10 rounded-[3.5rem] relative overflow-hidden">
        <header class="text-center mb-10">
            <div class="text-5xl mb-4">ü©∫</div>
            <h1 id="doc-name" class="text-2xl font-black text-slate-900 tracking-tighter uppercase italic">Cargando...</h1>
            <p id="doc-esp" class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.4em] italic mt-2">Sincronizaci√≥n √âlite</p>
        </header>

        <form id="form-cita" class="space-y-6">
            <div>
                <p class="text-[9px] font-black uppercase text-[#c5a059] px-2 tracking-widest italic mb-2">1. Servicio solicitado</p>
                <select id="select-servicios" class="input-premium text-xs uppercase italic tracking-wider cursor-pointer" required>
                    <option value="" disabled selected>Cargando servicios...</option>
                </select>
            </div>

            <div class="space-y-3">
                <p class="text-[9px] font-black uppercase text-slate-400 px-2 tracking-widest italic">2. Identidad del Paciente</p>
                <input type="text" id="nombre" placeholder="NOMBRE COMPLETO" class="input-premium uppercase" required>
                <input type="tel" id="telefono" placeholder="TEL√âFONO (10 D√çGITOS)" class="input-premium" maxlength="10" required>
            </div>

            <div>
                <div class="flex justify-between items-center px-2 text-[9px] font-black uppercase text-slate-400 mb-2">
                    <p>3. Fecha de Misi√≥n</p>
                    <span id="current-month" class="font-black italic text-[#c5a059]"></span>
                </div>
                <div id="date-slider" class="scroll-calendar"></div>
                <input type="hidden" id="fecha-sel" required>
            </div>

            <div>
                <p class="text-[9px] font-black uppercase text-slate-400 px-2 tracking-widest italic mb-2">4. Horarios Disponibles</p>
                <div id="time-grid" class="grid grid-cols-3 gap-3"></div>
                <input type="hidden" id="hora-sel" required>
            </div>

            <button type="submit" id="btn-submit" class="btn-lujo py-5 text-[11px]">Confirmar Reservaci√≥n ‚ú¶</button>
        </form>
    </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');
const docId = '196c57b5-68d5-4825-8607-36b5d3bc3e15';

function eliteAviso(msg) {
    const t = document.getElementById('elite-toast');
    document.getElementById('toast-msg').innerText = msg;
    t.classList.add('active');
    setTimeout(() => t.classList.remove('active'), 4000);
}

async function init() {
    const { data: doc } = await supabase.from('Usuarios').select('nombre').eq('id', docId).single();
    if(doc) {
        document.getElementById('doc-name').innerText = `DR. ${doc.nombre}`;
        await cargarServicios();
        renderCalendar();
    }
}

async function cargarServicios() {
    const { data } = await supabase.from('Servicios').select('*').eq('doctor_id', docId).eq('activo', true);
    const sel = document.getElementById('select-servicios');
    if (data) {
        sel.innerHTML = '<option value="" disabled selected>Seleccione un servicio</option>' + 
            data.map(s => `<option value="${s.id}" data-d="${s.duracion_total}" data-p="${s.precio}">${s.nombre.toUpperCase()} ‚Äî $${s.precio}</option>`).join('');
    }
}

function renderCalendar() {
    const slider = document.getElementById('date-slider');
    const today = new Date();
    for (let i = 0; i < 30; i++) {
        const d = new Date(); d.setDate(today.getDate() + i);
        if (d.getDay() === 0) continue; // Saltamos domingos
        const card = document.createElement('div');
        card.className = 'date-card';
        card.innerHTML = `<span class="text-[8px] font-bold opacity-40 uppercase">${d.toLocaleDateString('es',{weekday:'short'})}</span><span class="text-lg font-black">${d.getDate()}</span>`;
        card.onclick = () => {
            document.querySelectorAll('.date-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            const fechaString = d.toISOString().split('T')[0];
            document.getElementById('fecha-sel').value = fechaString;
            cargarHorasDisponibles(fechaString);
        };
        slider.appendChild(card);
    }
}

async function cargarHorasDisponibles(fecha) {
    const grid = document.getElementById('time-grid');
    const serv = document.getElementById('select-servicios').selectedOptions[0];
    if(!serv.value) return eliteAviso("ELIJA UN SERVICIO");

    grid.innerHTML = "<p class='col-span-3 text-center text-[8px] font-black uppercase animate-pulse'>Escaneando...</p>";
    
    const { data: slots, error } = await supabase.rpc('obtener_horarios_disponibles', {
        p_doctor: docId, p_fecha: fecha, p_duracion: parseInt(serv.dataset.d)
    });

    grid.innerHTML = slots?.length ? "" : "<p class='col-span-3 text-center text-[8px] font-black uppercase text-rose-500 py-4'>SIN ESPACIOS</p>";
    slots?.forEach(s => {
        const pill = document.createElement('div');
        pill.className = 'time-pill';
        pill.innerText = s.hora.slice(0,5);
        pill.onclick = () => {
            document.querySelectorAll('.time-pill').forEach(p => p.classList.remove('selected'));
            pill.classList.add('selected');
            document.getElementById('hora-sel').value = s.hora;
        };
        grid.appendChild(pill);
    });
}

document.getElementById('form-cita').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-submit');
    const fecha = document.getElementById('fecha-sel').value;
    const hora = document.getElementById('hora-sel').value;
    if(!fecha || !hora) return eliteAviso("ELIJA FECHA Y HORA");

    btn.disabled = true;
    btn.innerText = "INYECTANDO...";

    try {
        const tel = document.getElementById('telefono').value;
        const nombre = document.getElementById('nombre').value.toUpperCase();
        
        // 1. Upsert Paciente
        let { data: pac } = await supabase.from('Pacientes').select('id').eq('telefono', tel).maybeSingle();
        if(!pac) {
            const { data } = await supabase.from('Pacientes').insert({ nombre, telefono: tel }).select().single();
            pac = data;
        }

        const serv = document.getElementById('select-servicios').selectedOptions[0];
        
        // 2. Insert Cita
        const { error } = await supabase.from('Citas').insert({
            doctor_id: docId, paciente_id: pac.id, servicio_id: document.getElementById('select-servicios').value,
            fecha, hora_inicio: hora, duracion_cita: parseInt(serv.dataset.d), monto: Number(serv.dataset.p), estado: 'pendiente'
        });

        if(error) throw error;
        eliteAviso("‚úÖ RESERVACI√ìN EXITOSA");
        setTimeout(() => location.reload(), 3000);
    } catch (err) {
        eliteAviso("‚ùå ERROR EN EL B√öNKER");
        btn.disabled = false; btn.innerText = "Confirmar Reservaci√≥n ‚ú¶";
    }
};

init();
</script>
</body>
</html>
