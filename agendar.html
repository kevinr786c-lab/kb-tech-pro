<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu Cita | K.B Tech Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.8s; overflow-x: hidden; background-color: #f8fafc; }
        :root { --main: #6366f1; }
        
        .bg-element { position: fixed; z-index: -1; opacity: 0.1; pointer-events: none; transition: 1.5s; filter: blur(4px); }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 50px 100px -20px rgba(0,0,0,0.1); }
        
        .input-modern { 
            width: 100%; padding: 1.25rem; border-radius: 1.5rem; background: #f1f5f9; 
            border: 2px solid transparent; font-weight: 700; font-size: 0.9rem; transition: 0.3s; outline: none;
        }
        .input-modern:focus { border-color: var(--main); background: white; box-shadow: 0 10px 25px -10px var(--main); }
        
        /* Sistema de Horarios Verde/Rojo */
        .grid-horas { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .btn-hora { 
            padding: 12px; border-radius: 1.2rem; font-weight: 800; font-size: 0.75rem; 
            transition: 0.3s; text-align: center; border: 2px solid transparent; cursor: pointer;
        }
        .hora-disponible { background: #f1f5f9; color: #475569; }
        .hora-disponible:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -5px var(--main); border-color: var(--main); }
        
        .hora-ocupada { background: #fee2e2; color: #991b1b; opacity: 0.5; cursor: not-allowed; border-color: #f87171; text-decoration: line-through; }
        .hora-seleccionada { background: var(--main) !important; color: white !important; transform: scale(1.05); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="visual-1" class="bg-element top-[-5%] right-[-5%] text-[25rem]"></div>
    <div id="visual-2" class="bg-element bottom-[-5%] left-[-5%] text-[20rem]"></div>

    <div class="max-w-md w-full glass-card p-10 rounded-[3.5rem] relative z-10 border-t-[10px]" id="card-main">
        <header class="text-center mb-8">
            <div id="icon-header" class="text-7xl mb-4 drop-shadow-xl animate-bounce" style="animation-duration: 4s;">üè•</div>
            <h1 id="doc-name" class="text-3xl font-black tracking-tighter text-slate-800 uppercase italic">Conectando...</h1>
            <p id="doc-esp" class="text-[9px] font-black text-slate-400 uppercase tracking-[0.4em] italic mt-2"></p>
        </header>

        <form id="form-cita" class="space-y-6">
            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 italic">Tu Nombre</label>
                <input type="text" id="nombre" placeholder="Nombre completo" class="input-modern" required>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 italic">Selecciona el D√≠a</label>
                <input type="date" id="fecha" class="input-modern" required>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 italic">Horarios Disponibles</label>
                <div id="contenedor-horas" class="grid-horas">
                    <p class="col-span-3 text-[8px] text-center text-slate-400 py-4 uppercase font-bold tracking-widest">Elige una fecha para ver disponibilidad</p>
                </div>
                <input type="hidden" id="hora-seleccionada" required>
            </div>

            <button type="submit" id="btn-submit" class="w-full py-6 bg-slate-900 text-white rounded-[2.5rem] font-black uppercase text-[10px] tracking-[0.2em] shadow-2xl transition-all duration-500 hover:scale-105 active:scale-95">Confirmar Reservaci√≥n</button>
        </form>

        <footer class="mt-10 text-center border-t border-slate-100 pt-8">
            <button onclick="document.getElementById('modal-privacidad').classList.remove('hidden')" class="text-[10px] font-black text-slate-300 underline uppercase tracking-tighter hover:text-slate-500 transition">Aviso de Privacidad Legal</button>
        </footer>
    </div>

    <div id="modal-privacidad" class="hidden fixed inset-0 bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-6 z-50">
        <div class="bg-white p-10 rounded-[3.5rem] max-w-sm w-full shadow-2xl border-b-[12px]" id="modal-border">
            <h2 class="text-2xl font-black mb-4 uppercase italic tracking-tighter" id="priv-titulo">Privacidad</h2>
            <p class="text-xs text-slate-500 leading-relaxed mb-8 italic" id="priv-texto"></p>
            <button onclick="document.getElementById('modal-privacidad').classList.add('hidden')" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest">Entendido</button>
        </div>
    </div>

    <script>
        const URL_DB = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY_DB = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 
        const docId = new URLSearchParams(window.location.search).get('id');

        let doctorConfig = null;

        const CATALOGO_MAESTRO = {
            "Ginecolog√≠a": [
                { id: 1, color: "#f43f5e", icon: "üå∏", priv: "Tus datos de salud femenina son tratados con la m√°xima delicadeza y confidencialidad absoluta." },
                { id: 2, color: "#8b5cf6", icon: "üîÆ", priv: "Sofisticaci√≥n y calma boutique. Resguardamos tu informaci√≥n con elegancia." },
                { id: 3, color: "#fb7185", icon: "üå∑", priv: "Suavidad y atenci√≥n prenatal. Cuidamos de ti con reserva profesional." },
                { id: 4, color: "#059669", icon: "üçÉ", priv: "Salud femenina org√°nica. Tu privacidad es un proceso seguro." },
                { id: 5, color: "#1e293b", icon: "üíé", priv: "Discreci√≥n de alta gama. Protocolos de √©lite para tu historial cl√≠nico." }
            ],
            "Odontolog√≠a": [
                { id: 1, color: "#0ea5e9", icon: "üíé", priv: "Limpieza y tecnolog√≠a. Registros dentales protegidos bajo seguridad digital." },
                { id: 2, color: "#10b981", icon: "üåø", priv: "Frescura y salud dental. Tu historial est√° en un entorno √©tico." },
                { id: 3, color: "#22d3ee", icon: "‚ùÑÔ∏è", priv: "Est√©tica y blanqueamiento. Protegemos tu diagn√≥stico est√©tico." },
                { id: 4, color: "#1e3a8a", icon: "üõ°Ô∏è", priv: "Cirug√≠a e implantes. M√°xima seguridad digital para tus procedimientos." },
                { id: 5, color: "#6366f1", icon: "‚ö°", priv: "Innovaci√≥n 3D. Tus diagn√≥sticos protegidos por encriptaci√≥n avanzada." }
            ],
            "Pediatr√≠a": [
                { id: 1, color: "#fb923c", icon: "üß∏", priv: "Entorno alegre y seguro. La privacidad de los ni√±os es sagrada." },
                { id: 2, color: "#38bdf8", icon: "üöÄ", priv: "Confianza y juego. Solo tutores autorizados acceden al historial." },
                { id: 3, color: "#4ade80", icon: "ü¶ñ", priv: "Aventura segura. Datos pedi√°tricos resguardados con absoluta √©tica." },
                { id: 4, color: "#f472b6", icon: "üç≠", priv: "Dulce cuidado infantil. Tratamos la info con ternura y seguridad." },
                { id: 5, color: "#818cf8", icon: "üåô", priv: "Estrella de calma. Un entorno sereno para la privacidad de los peque√±os." }
            ],
            "Cardiolog√≠a": [
                { id: 1, color: "#e11d48", icon: "‚ù§Ô∏è", priv: "Precisi√≥n card√≠aca. Encriptaci√≥n de grado m√©dico para tus datos vitales." },
                { id: 2, color: "#1e293b", icon: "‚ö°", priv: "Seriedad y vanguardia. Monitoreo cardiovascular de alta seguridad." },
                { id: 3, color: "#0284c7", icon: "üåä", priv: "Flujo y salud vascular. Datos circulatorios protegidos por tecnolog√≠a de punta." },
                { id: 4, color: "#9f1239", icon: "ü©∏", priv: "Hematolog√≠a especializada. Resguardo √©tico de tus an√°lisis sangu√≠neos." },
                { id: 5, color: "#4f46e5", icon: "üõ∞Ô∏è", priv: "Ciber Cardiolog√≠a. Seguridad satelital aplicada a tu monitoreo card√≠aco." }
            ],
            "Bienestar (Nutri/Psico)": [
                { id: 1, color: "#059669", icon: "üßò‚Äç‚ôÇÔ∏è", priv: "Equilibrio y paz. Tus notas de consulta son privadas y encriptadas." },
                { id: 2, color: "#a855f7", icon: "üß†", priv: "Crecimiento seguro. Tu historia emocional es confidencial." },
                { id: 3, color: "#fbbf24", icon: "üçé", priv: "Nutrici√≥n energ√©tica. Planes alimenticios resguardados con reserva." },
                { id: 4, color: "#0ea5e9", icon: "üåä", priv: "Inmersi√≥n emocional. Confidencialidad absoluta para tu bienestar." },
                { id: 5, color: "#10b981", icon: "ü•ë", priv: "Vida saludable. Privacidad integral para tu estilo de vida fit." }
            ],
            "General": [
                { id: 1, color: "#1e3a8a", icon: "‚öñÔ∏è", priv: "Autoridad m√©dica. Datos personales encriptados bajo la ley vigente." },
                { id: 2, color: "#6366f1", icon: "üè•", priv: "Innovaci√≥n moderna. Seguridad digital para tu historial cl√≠nico." },
                { id: 3, color: "#10b981", icon: "ü©∫", priv: "Salud b√°sica. Atenci√≥n primaria con seguridad avanzada." },
                { id: 4, color: "#be123c", icon: "üöë", priv: "Urgencias m√©dicas. Seguridad inmediata para datos cr√≠ticos." },
                { id: 5, color: "#4338ca", icon: "üè¢", priv: "Red hospitalaria. Protecci√≥n de datos a escala corporativa." }
            ]
        };

        async function init() {
            if(!docId) return alert("Error: Nodo M√©dico no identificado.");
            const res = await fetch(`${URL_DB}/rest/v1/Perfiles_Medicos?id=eq.${docId}`, { headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}` } });
            const data = await res.json();
            
            if(data.length > 0) {
                doctorConfig = data[0];
                const especialidad = doctorConfig.especialidad;
                const template_id = doctorConfig.template_id;

                const cat = CATALOGO_MAESTRO[especialidad] || CATALOGO_MAESTRO["General"];
                const tema = cat.find(t => t.id === template_id) || cat[0];

                // Aplicar Identidad Visual
                document.getElementById('doc-name').innerText = "Dr. " + doctorConfig.nombre_doctor;
                document.getElementById('doc-esp').innerText = especialidad;
                document.getElementById('icon-header').innerText = tema.icon;
                document.documentElement.style.setProperty('--main', tema.color);
                
                document.getElementById('btn-submit').style.backgroundColor = tema.color;
                document.getElementById('card-main').style.borderColor = tema.color;
                document.getElementById('modal-border').style.borderColor = tema.color;
                document.getElementById('visual-1').innerText = tema.icon;
                document.getElementById('visual-2').innerText = tema.icon;

                // Aplicar Privacidad Din√°mica
                document.getElementById('priv-texto').innerText = "AVISO LEGAL: " + tema.priv;
                document.getElementById('priv-titulo').style.color = tema.color;
            }
        }

        // GENERADOR DE HORARIOS INTELIGENTES (VERDE / ROJO)
        document.getElementById('fecha').addEventListener('change', async (e) => {
            const fecha = e.target.value;
            const contenedor = document.getElementById('contenedor-horas');
            contenedor.innerHTML = '<p class="col-span-3 text-center text-[8px] animate-pulse">ESCANEANDO DISPONIBILIDAD...</p>';

            // Consultar citas ocupadas en Supabase
            const res = await fetch(`${URL_DB}/rest/v1/Citas_Agendadas?doctor_id=eq.${docId}&fecha_cita=eq.${fecha}`, {
                headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}` }
            });
            const citas = await res.json();
            const horasOcupadas = citas.map(c => c.hora_cita.substring(0, 5));

            contenedor.innerHTML = '';
            
            // Configuraci√≥n del doctor (Viene de la base de datos)
            let inicio = doctorConfig.hora_inicio || "09:00:00";
            let fin = doctorConfig.hora_fin || "17:00:00";
            let duracion = doctorConfig.duracion_cita_min || 30;

            let hActual = new Date(`2026-01-01T${inicio}`);
            let hFinal = new Date(`2026-01-01T${fin}`);

            while(hActual < hFinal) {
                const textoHora = hActual.toTimeString().substring(0, 5);
                const btn = document.createElement('div');
                const ocupada = horasOcupadas.includes(textoHora);

                btn.innerText = textoHora;
                btn.className = `btn-hora ${ocupada ? 'hora-ocupada' : 'hora-disponible'}`;
                
                if(!ocupada) {
                    btn.onclick = () => {
                        document.querySelectorAll('.btn-hora').forEach(b => b.classList.remove('hora-seleccionada'));
                        btn.classList.add('hora-seleccionada');
                        document.getElementById('hora-seleccionada').value = textoHora + ":00";
                    };
                }
                contenedor.appendChild(btn);
                hActual.setMinutes(hActual.getMinutes() + duracion);
            }
        });

        document.getElementById('form-cita').addEventListener('submit', async (e) => {
            e.preventDefault();
            const hora = document.getElementById('hora-seleccionada').value;
            if(!hora) return alert("‚ö†Ô∏è Por favor selecciona una hora disponible.");

            const btn = document.getElementById('btn-submit');
            btn.innerText = "PROCESANDO RESERVA..."; btn.disabled = true;

            const res = await fetch(`${URL_DB}/rest/v1/Citas_Agendadas`, {
                method: 'POST',
                headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    doctor_id: docId,
                    nombre_paciente: document.getElementById('nombre').value,
                    fecha_cita: document.getElementById('fecha').value,
                    hora_cita: hora
                })
            });

            if(res.ok) {
                alert("‚úÖ ¬°CITA CONFIRMADA!\nTu espacio ha sido reservado en el sistema.");
                location.reload();
            } else {
                alert("‚ùå Error de conexi√≥n. Int√©ntalo de nuevo.");
                btn.innerText = "Confirmar Reservaci√≥n"; btn.disabled = false;
            }
        });

        init();
    </script>
</body>
</html>
