<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu Cita | K.B Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.5s; overflow-x: hidden; }
        
        /* Contenedores de Vida (Backgrounds din√°micos) */
        .bg-element { position: fixed; z-index: -1; opacity: 0.15; pointer-events: none; transition: 1s; }
        
        /* Camale√≥n Est√°ndar */
        :root { --main: #6366f1; --soft: #f5f3ff; }
        .text-main { color: var(--main); }
        .bg-main { background-color: var(--main); }
        .border-main { border-color: var(--main); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">

    <div id="visual-1" class="bg-element top-[-5%] right-[-5%] text-[20rem] hidden">üå∏</div>
    <div id="visual-2" class="bg-element bottom-[-5%] left-[-5%] text-[15rem] hidden">üåø</div>
    <div id="visual-3" class="bg-element top-[10%] left-[-10%] text-[20rem] opacity-[0.05] hidden">üß¨</div>

    <div class="max-w-md w-full bg-white/80 backdrop-blur-xl p-8 rounded-[3rem] shadow-2xl border border-white relative">
        <header class="text-center mb-8">
            <div id="icon-header" class="text-4xl mb-2">üè•</div>
            <h1 id="doc-name" class="text-2xl font-black tracking-tighter text-slate-800 uppercase italic">Cargando Especialista...</h1>
            <p id="doc-esp" class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em]">Nodo M√©dico Sincronizado</p>
        </header>

        <form id="form-cita" class="space-y-4">
            <div class="space-y-1">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-4">Tu Nombre Completo</label>
                <input type="text" id="nombre" class="w-full p-4 rounded-2xl bg-white border-2 border-slate-100 outline-none focus:border-main transition-all text-sm font-bold" required>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-slate-400 ml-4">Fecha</label>
                    <input type="date" id="fecha" class="w-full p-4 rounded-2xl bg-white border-2 border-slate-100 text-xs font-bold" required>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-slate-400 ml-4">Hora</label>
                    <input type="time" id="hora" class="w-full p-4 rounded-2xl bg-white border-2 border-slate-100 text-xs font-bold" required>
                </div>
            </div>

            <button type="submit" id="btn-submit" class="w-full py-5 bg-main text-white rounded-[2rem] font-black uppercase text-[10px] tracking-[0.2em] shadow-xl hover:scale-[1.02] transition-all">Confirmar Cita</button>
        </form>

        <footer class="mt-8 text-center border-t border-slate-100 pt-6">
            <p class="text-[8px] font-black text-slate-300 uppercase tracking-widest mb-4">K.B TECH SOLUTIONS POWERED BY</p>
            <button onclick="document.getElementById('modal-privacidad').classList.remove('hidden')" class="text-[9px] font-bold text-main underline uppercase">Aviso de Privacidad</button>
        </footer>
    </div>

    <div id="modal-privacidad" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6 z-50">
        <div class="bg-white p-8 rounded-[2.5rem] max-w-sm w-full">
            <h2 class="text-lg font-black mb-4 uppercase italic" id="priv-titulo">Protecci√≥n de Datos</h2>
            <p class="text-[11px] text-slate-500 leading-relaxed mb-6" id="priv-texto">
                Tus datos de salud son sagrados. En esta plataforma, la informaci√≥n se encripta de punto a punto para asegurar que solo tu m√©dico tenga acceso a tu historial.
            </p>
            <button onclick="document.getElementById('modal-privacidad').classList.add('hidden')" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-[10px] uppercase">Entendido</button>
        </div>
    </div>

    <script>
        const URL = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 
        const docId = new URLSearchParams(window.location.search).get('id');

        const temas = {
            1: { main: "#0ea5e9", icon: "üíé", visuals: ["üîπ", "üõ°Ô∏è"], priv: "Confidencialidad t√©cnica y seguridad de grado m√©dico para tu tranquilidad." },
            2: { main: "#f43f5e", icon: "üå∏", visuals: ["üå∏", "‚ú®"], priv: "Cuidamos tu informaci√≥n con la delicadeza y privacidad que tu salud merece." },
            3: { main: "#10b981", icon: "üåø", visuals: ["üåø", "üçÉ"], priv: "Un entorno seguro y natural para la gesti√≥n de tu bienestar integral." },
            4: { main: "#1e3a8a", icon: "‚öñÔ∏è", visuals: ["üè¢", "üíé"], priv: "Protocolos de alta seguridad corporativa aplicados a tu historial cl√≠nico." },
            5: { main: "#8b5cf6", icon: "üîÆ", visuals: ["‚ú®", "üßò‚Äç‚ôÄÔ∏è"], priv: "Privacidad premium en un espacio dise√±ado para tu comodidad y confianza." }
        };

        async function init() {
            if(!docId) return;
            const res = await fetch(`${URL}/rest/v1/Perfiles_Medicos?id=eq.${docId}`, {
                headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` }
            });
            const data = await res.json();
            if(data.length > 0) {
                const doc = data[0];
                const t = temas[doc.template_id] || temas[1];

                document.getElementById('doc-name').innerText = "Dr. " + doc.nombre_doctor;
                document.getElementById('doc-esp').innerText = doc.especialidad;
                document.getElementById('icon-header').innerText = t.icon;
                document.documentElement.style.setProperty('--main', t.main);
                
                // Aplicar Visuales de Fondo
                document.getElementById('visual-1').innerText = t.visuals[0];
                document.getElementById('visual-1').classList.remove('hidden');
                document.getElementById('visual-2').innerText = t.visuals[1];
                document.getElementById('visual-2').classList.remove('hidden');

                // Personalizar Privacidad
                document.getElementById('priv-texto').innerText = t.priv;
                document.getElementById('priv-titulo').style.color = t.main;
            }
        }

        document.getElementById('form-cita').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "SINCRONIZANDO..."; btn.disabled = true;

            const nuevaCita = {
                doctor_id: docId,
                nombre_paciente: document.getElementById('nombre').value,
                fecha: document.getElementById('fecha').value,
                hora: document.getElementById('hora').value,
                pagado: false
            };

            const res = await fetch(`${URL}/rest/v1/Citas`, {
                method: 'POST',
                headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(nuevaCita)
            });

            if(res.ok) {
                alert("¬°Cita confirmada! El consultorio ha sido notificado.");
                location.reload();
            } else {
                alert("Error al agendar.");
                btn.innerText = "Confirmar Cita"; btn.disabled = false;
            }
        });

        init();
    </script>
</body>
</html>
