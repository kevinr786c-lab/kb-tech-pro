<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RESERVACI√ìN √âLITE | K.B TECH PRO ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;500;800&display=swap');
        :root { --main: #c5a059; } /* Cambio a Dorado Luxe para consistencia */
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fafafa; color: #0f172a; }

        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.7); box-shadow: 0 40px 100px -20px rgba(0,0,0,0.05); }
        .input-premium { width: 100%; padding: 1.25rem; border-radius: 1.5rem; background: #fff; border: 1px solid #f1f5f9; font-weight: 600; transition: 0.4s; outline: none; }
        .input-premium:focus { border-color: var(--main); box-shadow: 0 10px 25px -10px var(--main); }
        
        .scroll-calendar { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .scroll-calendar::-webkit-scrollbar { display: none; }

        .date-card { min-width: 65px; aspect-ratio: 1/1.2; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; border-radius: 1.2rem; border: 1px solid #f1f5f9; cursor: pointer; transition: 0.3s; scroll-snap-align: start; }
        .date-card.selected { background: var(--main); color: white; transform: scale(1.05); box-shadow: 0 10px 20px -5px var(--main); }
        
        .time-pill { padding: 12px; border-radius: 1.25rem; background: #fff; border: 1px solid #f1f5f9; font-weight: 800; font-size: 0.75rem; text-align: center; cursor: pointer; transition: 0.3s; }
        .time-pill.selected { background: var(--main); color: white; }
        
        .btn-lujo { width: 100%; border-radius: 1.5rem; background: #0f172a; color: white; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; transition: 0.4s; box-shadow: 0 20px 40px -10px rgba(15, 23, 42, 0.3); }
        .btn-lujo:not(:disabled):hover { transform: translateY(-3px); background: var(--main); }

        #elite-toast { position: fixed; top: 2rem; left: 50%; transform: translateX(-50%) translateY(-250%); background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); padding: 1.5rem 3rem; border-radius: 2rem; z-index: 10000; transition: 0.6s cubic-bezier(0.23, 1, 0.32, 1); border: 1px solid rgba(255,255,255,0.1); }
        #elite-toast.active { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="elite-toast"><p id="toast-msg" class="text-white font-black uppercase italic tracking-widest text-[10px]"></p></div>

    <div id="main-node-container" class="max-w-md w-full glass-card p-8 md:p-10 rounded-[3.5rem] relative overflow-hidden">
        <header class="text-center mb-10">
            <div class="text-5xl mb-4">ü©∫</div>
            <h1 id="doc-name" class="text-2xl font-black text-slate-900 tracking-tighter uppercase italic">Sincronizando...</h1>
            <p id="doc-esp" class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.4em] italic mt-2">Nodo K.B Operativo</p>
        </header>

        <form id="form-cita" class="space-y-6">
            <div class="space-y-2">
                <p class="text-[9px] font-black uppercase text-[#c5a059] px-2 tracking-widest italic">1. Servicio solicitado</p>
                <select id="select-servicios" class="input-premium text-xs uppercase italic tracking-wider cursor-pointer" required>
                    <option value="" disabled selected>Cargando cat√°logo...</option>
                </select>
            </div>

            <div class="space-y-3">
                <p class="text-[9px] font-black uppercase text-slate-400 px-2 tracking-widest italic">2. Identidad del Paciente</p>
                <input type="text" id="nombre" placeholder="NOMBRE COMPLETO" class="input-premium uppercase" required>
                <input type="tel" id="telefono" placeholder="TEL√âFONO (10 D√çGITOS)" class="input-premium" maxlength="10" required>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center px-2 text-[9px] font-black uppercase text-slate-400">
                    <p>3. Fecha de Misi√≥n</p>
                    <span id="current-month" class="font-black italic uppercase text-[#c5a059]"></span>
                </div>
                <div id="date-slider" class="scroll-calendar"></div>
                <input type="hidden" id="fecha-sel" required>
            </div>

            <div class="space-y-3">
                <p class="text-[9px] font-black uppercase text-slate-400 px-2 tracking-widest italic">4. Horarios Disponibles</p>
                <div id="time-grid" class="grid grid-cols-3 gap-3"></div>
                <input type="hidden" id="hora-sel" required>
            </div>

            <button type="submit" id="btn-submit" class="btn-lujo py-5 text-[11px]">Confirmar Reservaci√≥n ‚ú¶</button>
        </form>

        <footer class="mt-8 text-center text-[7px] font-black text-slate-300 uppercase tracking-widest">
            Powered by K.B Tech Pro ‚ú¶ Sincronizaci√≥n √âlite
        </footer>
    </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');
const docId = '196c57b5-68d5-4825-8607-36b5d3bc3e15';

function eliteAviso(msg) {
    const t = document.getElementById('elite-toast');
    document.getElementById('toast-msg').innerText = msg;
    t.classList.add('active');
    setTimeout(() => t.classList.remove('active'), 4000);
}

async function init() {
    try {
        const { data: doc } = await supabase.from('Perfiles_Medicos').select('*, Usuarios(nombre)').eq('id', docId).single();
        if(doc) {
            document.getElementById('doc-name').innerText = `DR. ${doc.Usuarios.nombre}`;
            document.getElementById('doc-esp').innerText = doc.especialidad;
            await cargarServicios(docId);
            renderCalendar();
        }
    } catch (e) { eliteAviso("ERROR: NODO NO ENCONTRADO"); }
}

async function cargarServicios(id) {
    // Sincronizaci√≥n: Cargamos duracion_min (para Citas) y duracion_total (para el Radar)
    const { data } = await supabase.from('Servicios').select('id, nombre, precio, duracion_min, duracion_total').eq('doctor_id', id).eq('activo', true);
    const sel = document.getElementById('select-servicios');
    if (data) {
        sel.innerHTML = '<option value="" disabled selected>Seleccione un servicio</option>' + 
            data.map(s => `<option value="${s.id}" data-d="${s.duracion_min}" data-dt="${s.duracion_total}" data-p="${s.precio}">${s.nombre.toUpperCase()} ‚Äî $${s.precio}</option>`).join('');
    }
}

// ... (renderCalendar se mantiene igual para funcionalidad visual)

async function cargarHorasDisponibles(fecha) {
    const grid = document.getElementById('time-grid');
    const servSel = document.getElementById('select-servicios').selectedOptions[0];
    
    if(!servSel.value) {
        eliteAviso("‚ö†Ô∏è PRIMERO ELIJA UN SERVICIO");
        return;
    }

    grid.innerHTML = "<p class='col-span-3 text-[8px] font-black uppercase animate-pulse text-center py-4 text-[#c5a059]'>Escaneando Radar...</p>";

    try {
        // Llamada al RPC usando duracion_total para asegurar el buffer en la vista
        const { data: slots, error } = await supabase.rpc('obtener_horarios_disponibles', {
            p_doctor: docId,
            p_fecha: fecha,
            p_duracion: parseInt(servSel.dataset.dt) 
        });

        if (error) throw error;
        grid.innerHTML = slots?.length ? "" : "<p class='col-span-3 text-center text-[9px] font-black uppercase text-rose-500 py-4 italic'>SIN DISPONIBILIDAD üõ°Ô∏è</p>";
        
        slots?.forEach(s => {
            const pill = document.createElement('div');
            pill.className = `time-pill`;
            pill.innerText = s.hora.slice(0,5);
            pill.onclick = () => {
                document.querySelectorAll('.time-pill').forEach(p => p.classList.remove('selected'));
                pill.classList.add('selected');
                document.getElementById('hora-sel').value = s.hora;
                eliteAviso(`OBJETIVO: ${s.hora.slice(0,5)} HRS`);
            };
            grid.appendChild(pill);
        });
    } catch (err) { eliteAviso("FALLA EN LA RED MAESTRA"); }
}

document.getElementById('form-cita').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-submit');
    const fecha = document.getElementById('fecha-sel').value;
    const hora = document.getElementById('hora-sel').value;
    if(!fecha || !hora) return eliteAviso("‚ö†Ô∏è ELIJA FECHA Y HORA");

    btn.innerText = "INYECTANDO DATOS...";
    btn.disabled = true;

    try {
        const tel = document.getElementById('telefono').value;
        const nombreP = document.getElementById('nombre').value.toUpperCase();
        
        // 1. Upsert Paciente
        let { data: pac } = await supabase.from('Pacientes').select('id').eq('telefono', tel).maybeSingle();
        if(!pac) {
            const { data } = await supabase.from('Pacientes').insert({ nombre: nombreP, telefono: tel }).select().single();
            pac = data;
        }

        const servOpt = document.getElementById('select-servicios').selectedOptions[0];
        
        // 2. Insert Cita (Sincronizado con tabla Citas)
        const { error } = await supabase.from('Citas').insert({
            doctor_id: docId,
            paciente_id: pac.id,
            servicio_id: document.getElementById('select-servicios').value,
            fecha: fecha,
            hora_inicio: hora,
            duracion_cita: parseInt(servOpt.dataset.d), // Solo minutos de consulta
            monto: Number(servOpt.dataset.p),
            estado: 'pendiente'
        });

        if(error) throw error;
        eliteAviso("‚úÖ RESERVACI√ìN EXITOSA");
        setTimeout(() => location.reload(), 3000);

    } catch (err) {
        // Captura el mensaje del TRIGGER validar_choque_citas
        eliteAviso(err.message.includes("RADAR") ? err.message : "‚ùå ERROR EN EL B√öNKER");
        btn.disabled = false;
        btn.innerText = "Confirmar Reservaci√≥n ‚ú¶";
    }
};

// ... (renderCalendar init)
init();
</script>
</body>
</html>
