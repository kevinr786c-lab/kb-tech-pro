<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGENDADOR ELITE | K.B SYSTEM ✦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        :root { --gold: #c5a059; --dark: #0f172a; --deep: #020617; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: radial-gradient(circle at top right, var(--dark), var(--deep)); color: white; min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 2.5rem; }
        .input-kb { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.25rem; padding: 1rem; color: white; width: 100%; font-weight: 600; outline: none; transition: 0.3s; }
        .input-kb:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(197, 160, 89, 0.2); }
        .btn-gold { background: var(--gold); color: var(--deep); font-weight: 800; border-radius: 1.5rem; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        .btn-gold:hover { transform: translateY(-2px); filter: brightness(1.2); box-shadow: 0 10px 20px rgba(197, 160, 89, 0.3); }
        .kb-star { color: var(--gold); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto glass p-8 md:p-12 relative overflow-hidden">
        <header class="flex justify-between items-center mb-10 border-b border-white/5 pb-6">
            <div class="flex items-center gap-4">
                <span class="kb-star text-3xl">✦</span>
                <h1 class="text-2xl font-black uppercase italic tracking-tighter">Nueva <span class="text-[#c5a059]">Reservación</span></h1>
            </div>
            <button onclick="window.history.back()" class="text-[10px] font-bold text-slate-500 hover:text-white transition">CANCELAR X</button>
        </header>

        <form id="form-agendar" class="grid md:grid-cols-2 gap-8">
            <div class="space-y-6">
                <h3 class="text-[10px] font-black text-[#c5a059] uppercase tracking-widest border-l-4 border-[#c5a059] pl-3">Datos del Paciente</h3>
                <input type="text" id="p-nombre" placeholder="NOMBRE COMPLETO" class="input-kb uppercase text-xs" required>
                <input type="tel" id="p-telefono" placeholder="TELÉFONO (WHATSAPP)" class="input-kb text-xs" required>
                <input type="email" id="p-email" placeholder="EMAIL (OPCIONAL)" class="input-kb text-xs">
            </div>

            <div class="space-y-6">
                <h3 class="text-[10px] font-black text-[#c5a059] uppercase tracking-widest border-l-4 border-[#c5a059] pl-3">Detalles de la Cita</h3>
                
                <select id="servicio-select" class="input-kb text-xs appearance-none" required>
                    <option value="" disabled selected>CARGANDO SERVICIOS...</option>
                </select>

                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="c-fecha" class="input-kb text-xs uppercase" required>
                    <input type="time" id="c-hora" class="input-kb text-xs" required>
                </div>

                <div id="info-tiempo" class="bg-white/5 p-4 rounded-2xl border border-white/5 hidden">
                    <p class="text-[9px] font-bold text-slate-500 uppercase">Tiempo en Agenda (Incluye Espacio):</p>
                    <span id="label-total" class="text-white font-black text-sm">-- MINUTOS</span>
                </div>
            </div>

            <div class="md:col-span-2 pt-6">
                <button type="submit" id="btn-confirmar" class="btn-gold w-full py-5 shadow-2xl">Confirmar Reservación ✦</button>
            </div>
        </form>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('docId'); // El radar detecta al doctor de la URL

    if (!docId) {
        alert("ERROR: No se detectó ID del Doctor.");
        window.location.href = 'index.html';
    }

    // --- CARGAR SERVICIOS DESDE SUPABASE (Basado en el Croquis) ---
    async function init() {
        const { data: servicios, error } = await supabase
            .from('Servicios')
            .select('*')
            .eq('doctor_id', docId)
            .eq('activo', true);

        const select = document.getElementById('servicio-select');
        
        if (error || !servicios || servicios.length === 0) {
            select.innerHTML = '<option value="">NO HAY SERVICIOS CONFIGURADOS</option>';
            return;
        }

        select.innerHTML = '<option value="" disabled selected>SELECCIONE UN SERVICIO ✦</option>';
        servicios.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.dataset.total = s.duracion_total; // Suma de duracion + buffer
            opt.innerText = `${s.nombre.toUpperCase()} ($${s.precio}) - ${s.duracion_total} MIN`;
            select.appendChild(opt);
        });
    }

    // Mostrar tiempo total al seleccionar servicio
    document.getElementById('servicio-select').onchange = (e) => {
        const opt = e.target.options[e.target.selectedIndex];
        document.getElementById('info-tiempo').classList.remove('hidden');
        document.getElementById('label-total').innerText = `${opt.dataset.total} MINUTOS`;
    };

    // --- GUARDAR CITA (Protocolo Final) ---
    document.getElementById('form-agendar').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-confirmar');
        btn.disabled = true;
        btn.innerText = "PROCESANDO...";

        const nombreP = document.getElementById('p-nombre').value.toUpperCase();
        const telefonoP = document.getElementById('p-telefono').value;
        const servicioId = document.getElementById('servicio-select').value;
        const fechaC = document.getElementById('c-fecha').value;
        const horaC = document.getElementById('c-hora').value;
        const duracionTotal = document.getElementById('servicio-select').options[document.getElementById('servicio-select').selectedIndex].dataset.total;

        try {
            // 1. Registrar/Actualizar Paciente (Tabla Usuarios según Croquis)
            const { data: pac, error: errP } = await supabase
                .from('Usuarios')
                .upsert({ 
                    nombre: nombreP, 
                    telefono: telefonoP, 
                    email: document.getElementById('p-email').value,
                    rol: 'paciente' 
                }, { onConflict: 'telefono' })
                .select()
                .single();

            if (errP) throw errP;

            // 2. Crear la Cita (Tabla Citas según Croquis)
            const { error: errC } = await supabase
                .from('Citas')
                .insert({
                    doctor_id: docId,
                    paciente_id: pac.id,
                    servicio_id: servicioId,
                    fecha: fechaC,
                    hora_inicio: horaC,
                    duracion_cita: parseInt(duracionTotal),
                    estado: 'confirmada'
                });

            if (errC) throw errC;

            // 3. Éxito y Salto a WhatsApp
            alert("✦ CITA AGENDADA CON ÉXITO");
            
            // Preparar mensaje de WhatsApp
            const msj = `Hola ${nombreP}, su cita ha sido confirmada para el día ${fechaC} a las ${horaC}. ¡Lo esperamos! ✦`;
            window.location.href = `https://wa.me/${telefonoP.replace(/\D/g,'')}?text=${encodeURIComponent(msj)}`;

        } catch (err) {
            alert("Error: " + err.message);
            btn.disabled = false;
            btn.innerText = "Confirmar Reservación ✦";
        }
    };

    init();
</script>
</body>
</html>
