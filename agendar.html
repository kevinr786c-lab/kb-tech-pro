<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K.B SYSTEM | AGENDADOR ELITE ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        :root { --main: #c5a059; --dark: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: radial-gradient(circle at top, #f8fafc, #e2e8f0); color: var(--dark); }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(197, 160, 89, 0.2); border-radius: 2.5rem; }
        .input-elite { width: 100%; padding: 1rem; border-radius: 1.2rem; border: 1px solid #e2e8f0; outline: none; transition: 0.3s; font-weight: 600; }
        .input-elite:focus { border-color: var(--main); box-shadow: 0 0 0 4px rgba(197, 160, 89, 0.1); }
        .time-pill { padding: 0.8rem; border-radius: 1rem; border: 1px solid #e2e8f0; text-align: center; cursor: pointer; font-weight: 800; font-size: 0.8rem; transition: 0.3s; background: white; }
        .time-pill.selected { background: var(--main); color: white; border-color: var(--main); transform: scale(1.05); }
        .btn-mision { width: 100%; padding: 1.2rem; border-radius: 1.5rem; background: var(--dark); color: white; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; transition: 0.4s; }
        .btn-mision:hover { background: var(--main); transform: translateY(-3px); }
        .badge-estatus { display: none; padding: 0.3rem 0.8rem; border-radius: 0.7rem; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; transition: 0.3s; }
        .estatus-nuevo { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .estatus-recurrente { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        .estatus-oro { background: #fefce8; color: #a16207; border: 1px solid #fef08a; box-shadow: 0 4px 10px rgba(197, 160, 89, 0.2); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full glass p-8 shadow-2xl relative overflow-hidden">
        <header class="text-center mb-8">
            <button onclick="history.back()" class="absolute left-6 top-8 text-slate-300 hover:text-slate-900 transition text-sm">‚Üê</button>
            <h1 id="doc-name" class="text-xl font-black italic uppercase tracking-tighter text-slate-900">ESCANEANDO B√öNKER...</h1>
            <p id="doc-especialidad" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Terminal de Inteligencia M√©dica</p>
        </header>

        <form id="agendador-form" class="space-y-5">
            <div>
                <div class="flex justify-between items-center mb-2 px-1">
                    <p class="text-[10px] font-black uppercase text-slate-400 italic">Identificaci√≥n (Tel√©fono)</p>
                    <span id="badge-paciente" class="badge-estatus italic"></span>
                </div>
                <input type="tel" id="telefono" placeholder="10 D√çGITOS" class="input-elite" maxlength="10" required>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <input type="text" id="nombre" placeholder="NOMBRE COMPLETO" class="input-elite uppercase" required>
                <div class="grid grid-cols-2 gap-2">
                    <input type="email" id="email" placeholder="EMAIL" class="input-elite text-xs">
                    <input type="date" id="fecha_nacimiento" class="input-elite text-xs">
                </div>
            </div>

            <div class="space-y-4">
                <select id="servicio" class="input-elite text-xs uppercase font-bold" required>
                    <option value="" disabled selected>Seleccione Servicio</option>
                </select>
                <input type="date" id="fecha" class="input-elite">
            </div>

            <div id="radar-horas" class="grid grid-cols-3 gap-2 py-2"></div>

            <input type="hidden" id="hora_seleccionada">
            <button type="submit" id="confirmar-btn" class="btn-mision">Confirmar Reservaci√≥n ‚ú¶</button>
        </form>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('docId') || '8a4cf0e6-ddf8-4a95-9bba-4d4d094ad985'; 
    let orgId = null;

    // üì° DETECTOR DE PACIENTES
    document.getElementById('telefono').addEventListener('input', async (e) => {
        const tel = e.target.value;
        const badge = document.getElementById('badge-paciente');
        if (tel.length === 10) {
            const { data: pac } = await supabase.from('Pacientes').select('*').eq('telefono', tel).maybeSingle();
            if (pac) {
                document.getElementById('nombre').value = pac.nombre;
                document.getElementById('email').value = pac.email || '';
                document.getElementById('fecha_nacimiento').value = pac.fecha_nacimiento || '';
                const { count } = await supabase.from('Citas').select('*', { count: 'exact', head: true }).eq('paciente_id', pac.id).eq('estado','completado');
                badge.style.display = 'block';
                badge.innerText = count >= 3 ? "‚ú¶ PACIENTE ORO" : "‚úì RECURRENTE";
                badge.className = "badge-estatus " + (count >= 3 ? "estatus-oro" : "estatus-recurrente") + " italic";
            } else {
                badge.style.display = 'block';
                badge.innerText = "+ PACIENTE NUEVO";
                badge.className = "badge-estatus estatus-nuevo italic";
            }
        } else { badge.style.display = 'none'; }
    });

    // üß¨ ACTUALIZAR RADAR USANDO B√öSQUEDA POR ID DE DOCTOR
    async function actualizarRadar() {
        const fechaInput = document.getElementById('fecha').value;
        const selectServ = document.getElementById('servicio');
        const radar = document.getElementById('radar-horas');
        if (!fechaInput || !selectServ.value) return;

        radar.innerHTML = '<p class="col-span-3 text-center text-[10px] animate-pulse text-amber-500 font-bold italic">SINCRO DE RADAR...</p>';
        
        try {
            // 1. üõ°Ô∏è VERIFICAR BLOQUEOS (Prioridad M√°xima)
            const { data: bloqueo } = await supabase
                .from('Bloqueos_Horario')
                .select('motivo')
                .eq('doctor_id', docId)
                .eq('fecha', fechaInput)
                .maybeSingle();

            if (bloqueo) {
                radar.innerHTML = `<p class="col-span-3 text-center text-rose-500 text-[10px] font-bold uppercase py-4">‚ö†Ô∏è ${bloqueo.motivo}</p>`;
                return;
            }

            // 2. üìÖ CALCULAR D√çA DE LA SEMANA
            const dateObj = new Date(fechaInput + 'T12:00:00');
            const diaSemanaActual = dateObj.getDay().toString(); // 0-6 en String

            // 3. üì° BUSCAR TODOS LOS HORARIOS DEL ID DOCTOR
            const { data: horariosDoc } = await supabase
                .from('Horarios_Doctor') 
                .select('dia_semana, hora_inicio, hora_fin')
                .eq('doctor_id', docId)
                .eq('activo', true);

            // Filtrar en el cliente el horario que corresponde al d√≠a seleccionado
            const config = horariosDoc?.find(h => h.dia_semana === diaSemanaActual);

            if (!config) {
                radar.innerHTML = '<p class="col-span-3 text-center text-rose-500 text-[10px] font-bold uppercase py-4">‚ö†Ô∏è D√çA NO LABORAL</p>';
                return;
            }

            // 4. üõ°Ô∏è FILTRAR CITAS OCUPADAS
            const { data: ocupadas } = await supabase.from('Citas')
                .select('hora_inicio')
                .eq('doctor_id', docId)
                .eq('fecha', fechaInput)
                .neq('estado', 'cancelado');

            const horasOcupadas = ocupadas?.map(o => o.hora_inicio.slice(0,5)) || [];

            // 5. üß¨ GENERAR SLOTS (Frecuencia 30 min)
            let actual = new Date(`2026-01-01T${config.hora_inicio}`);
            let limite = new Date(`2026-01-01T${config.hora_fin}`);
            
            radar.innerHTML = '';
            while (actual < limite) {
                const h = actual.toTimeString().slice(0,5);
                if (!horasOcupadas.includes(h)) {
                    const pill = document.createElement('div');
                    pill.className = `time-pill`;
                    pill.innerText = h;
                    pill.onclick = () => {
                        document.querySelectorAll('.time-pill').forEach(p => p.classList.remove('selected'));
                        pill.classList.add('selected');
                        document.getElementById('hora_seleccionada').value = h + ":00";
                    };
                    radar.appendChild(pill);
                }
                actual.setMinutes(actual.getMinutes() + 30);
            }

            if (radar.innerHTML === '') radar.innerHTML = '<p class="col-span-3 text-center text-rose-500 text-[10px] font-bold">‚ö†Ô∏è SIN ESPACIO</p>';

        } catch (e) {
            radar.innerHTML = '<p class="col-span-3 text-center text-rose-500">ERROR DE ENLACE</p>';
        }
    }

    document.getElementById('fecha').onchange = actualizarRadar;
    document.getElementById('servicio').onchange = actualizarRadar;

    // üèõÔ∏è INICIALIZAR B√öNKER
    async function init() {
        const { data: doc } = await supabase.from('Usuarios').select('nombre, organizacion_id').eq('id', docId).single();
        if(doc) {
            document.getElementById('doc-name').innerText = `${doc.nombre.toUpperCase()}`;
            orgId = doc.organizacion_id;
        }
        
        const { data: servs } = await supabase.from('Servicios').select('*').eq('doctor_id', docId).eq('activo', true);
        const select = document.getElementById('servicio');
        servs?.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.setAttribute('data-total', s.duracion_min);
            opt.setAttribute('data-monto', s.precio);
            opt.innerText = `${s.nombre.toUpperCase()} ‚Äî $${s.precio}`;
            select.appendChild(opt);
        });
    }

    // ‚öîÔ∏è EJECUTAR REGISTRO
    document.getElementById('agendador-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('confirmar-btn');
        const hora = document.getElementById('hora_seleccionada').value;
        const selectServ = document.getElementById('servicio');
        if(!hora) return alert("‚ú¶ ELIJA HORA EN EL RADAR");
        
        btn.disabled = true; btn.innerText = "REGISTRANDO...";
        const servOpt = selectServ.selectedOptions[0];

        try {
            // 1. GESTI√ìN DE PACIENTE
            let { data: pac } = await supabase.from('Pacientes').select('id').eq('telefono', document.getElementById('telefono').value).maybeSingle();
            if (!pac) {
                const { data } = await supabase.from('Pacientes').insert({ 
                    nombre: document.getElementById('nombre').value.toUpperCase(), 
                    telefono: document.getElementById('telefono').value, 
                    email: document.getElementById('email').value,
                    fecha_nacimiento: document.getElementById('fecha_nacimiento').value
                }).select().single();
                pac = data;
            }

            // üõ°Ô∏è BUSCAR CONSULTORIO DISPONIBLE
            const { data: cons } = await supabase.from('consultorios').select('id').eq('organizacion_id', orgId).limit(1).single();

            // 2. INSERCI√ìN DE CITA
            const { error } = await supabase.from('Citas').insert({
                doctor_id: docId, 
                paciente_id: pac.id, 
                servicio_id: servOpt.value,
                organizacion_id: orgId,
                consultorio_id: cons?.id,
                fecha: document.getElementById('fecha').value, 
                hora_inicio: hora,
                duracion_cita: parseInt(servOpt.getAttribute('data-total')), 
                monto: parseFloat(servOpt.getAttribute('data-monto')),
                estado: 'pendiente'
            });

            if (error) {
                if(error.message.includes('CONFLICTO')) throw new Error("RADAR: El espacio se ocup√≥ recientemente.");
                throw error;
            }
            
            alert("‚úÖ CITA CONFIRMADA");
            location.reload();
        } catch (err) { 
            alert("‚ö†Ô∏è " + err.message); 
            btn.disabled = false; 
            btn.innerText = "REINTENTAR";
        }
    };

    init();
</script>
</body>
</html>
