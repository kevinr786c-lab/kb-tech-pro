<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu Cita | K.B Tech Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.8s; overflow-x: hidden; background-color: #f8fafc; }
        :root { --main: #6366f1; }
        
        .bg-element { position: fixed; z-index: -1; opacity: 0.05; pointer-events: none; transition: 1.5s; filter: blur(4px); }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 50px 100px -20px rgba(0,0,0,0.1); }
        
        .input-modern { 
            width: 100%; padding: 1.25rem; border-radius: 1.5rem; background: #f1f5f9; 
            border: 2px solid transparent; font-weight: 700; font-size: 0.9rem; transition: 0.3s; outline: none;
        }
        .input-modern:focus { border-color: var(--main); background: white; box-shadow: 0 10px 25px -10px var(--main); }
        
        /* CALENDARIO GRID FASE DIOS */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .day-box { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 0.8rem; font-size: 0.7rem; font-weight: 800; cursor: pointer; transition: 0.2s; border: 1px solid #f1f5f9; background: white; }
        .day-box:hover { border-color: var(--main); background: #f8fafc; }
        .day-box.selected { background: var(--main); color: white; border-color: var(--main); box-shadow: 0 10px 15px -5px var(--main); }
        .day-name { text-align: center; font-size: 0.55rem; font-weight: 800; color: #cbd5e1; text-transform: uppercase; }

        /* Sistema de Horarios */
        .grid-horas { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .btn-hora { 
            padding: 10px; border-radius: 1rem; font-weight: 800; font-size: 0.7rem; 
            transition: 0.3s; text-align: center; border: 2px solid transparent; cursor: pointer;
        }
        .hora-disponible { background: #f1f5f9; color: #475569; }
        .hora-disponible:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -5px var(--main); border-color: var(--main); }
        .hora-ocupada { background: #fee2e2; color: #991b1b; opacity: 0.5; cursor: not-allowed; border-color: #f87171; text-decoration: line-through; }
        .hora-seleccionada { background: var(--main) !important; color: white !important; }

        /* Barra de Navegaci√≥n Retr√°ctil */
        #nav-bar { transition: transform 0.4s ease-in-out; }
        .nav-hidden { transform: translate(-50%, 150%); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 pb-32">

    <div id="visual-1" class="bg-element top-[-5%] right-[-5%] text-[25rem]">üè•</div>
    <div id="visual-2" class="bg-element bottom-[-5%] left-[-5%] text-[20rem]">üè•</div>

    <div class="max-w-md w-full glass-card p-8 rounded-[3rem] relative z-10 border-t-[10px]" id="card-main">
        <header class="text-center mb-6">
            <div id="icon-header" class="text-6xl mb-4 drop-shadow-xl animate-bounce">üè•</div>
            <h1 id="doc-name" class="text-2xl font-black tracking-tighter text-slate-800 uppercase italic">Cargando Nodo...</h1>
            <p id="doc-esp" class="text-[8px] font-black text-slate-400 uppercase tracking-[0.4em] italic mt-1"></p>
        </header>

        <form id="form-cita" class="space-y-4">
            <div class="space-y-1">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-4">Nombre del Paciente</label>
                <input type="text" id="nombre" placeholder="Nombre completo" class="input-modern" required>
            </div>

            <div class="space-y-1">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-4">WhatsApp</label>
                <div class="flex gap-2">
                    <select id="lada" class="w-28 input-modern !px-2 text-xs">
                        <option value="52">üá≤üáΩ +52</option>
                        <option value="1">üá∫üá∏ +1</option>
                        <option value="1">üá®üá¶ +1</option>
                        <option value="34">üá™üá∏ +34</option>
                    </select>
                    <input type="tel" id="telefono" placeholder="10 d√≠gitos" class="flex-1 input-modern" required>
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-4">Selecciona el D√≠a</label>
                <div class="bg-slate-50 p-4 rounded-[2rem] border border-slate-100">
                    <div id="month-name" class="text-[10px] font-black text-[var(--main)] uppercase italic text-center mb-4"></div>
                    <div class="grid grid-cols-7 gap-1 text-center mb-2">
                        <div class="day-name">D</div><div class="day-name">L</div><div class="day-name">M</div><div class="day-name">M</div><div class="day-name">J</div><div class="day-name">V</div><div class="day-name">S</div>
                    </div>
                    <div id="calendar-body" class="calendar-grid"></div>
                </div>
                <input type="hidden" id="fecha-seleccionada" required>
            </div>

            <div class="space-y-1">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-4">Horarios Libres</label>
                <div id="contenedor-horas" class="grid-horas">
                    <p class="col-span-3 text-[7px] text-center text-slate-400 py-2 uppercase font-bold">Toca un d√≠a en el cuadro superior</p>
                </div>
                <input type="hidden" id="hora-seleccionada" required>
            </div>

            <button type="submit" id="btn-submit" class="w-full py-5 bg-slate-900 text-white rounded-[2rem] font-black uppercase text-[10px] tracking-[0.2em] shadow-xl hover:bg-indigo-600 transition-all">Confirmar Cita</button>
        </form>
    </div>

    <nav id="nav-bar" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-xl border border-slate-200 p-3 rounded-full flex gap-6 shadow-2xl z-50">
        <div class="text-xl cursor-pointer hover:scale-110 transition" onclick="location.reload()">üîÑ</div>
        <div class="text-xl cursor-pointer hover:scale-110 transition" onclick="alert('K.B Tech Pro v2.0 - Tijuana Global')">üõ°Ô∏è</div>
        <div class="text-xl cursor-pointer hover:scale-110 transition" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">‚¨ÜÔ∏è</div>
    </nav>

    <script>
        const URL = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 
        const docId = new URLSearchParams(window.location.search).get('id');
        let doctorConfig = null;

        // --- L√≥gica de la Barra de Navegaci√≥n Retr√°ctil ---
        let lastScroll = 0;
        window.addEventListener("scroll", () => {
            const currentScroll = window.pageYOffset;
            const nav = document.getElementById("nav-bar");
            if (currentScroll > lastScroll && currentScroll > 50) {
                nav.classList.add("nav-hidden");
            } else {
                nav.classList.remove("nav-hidden");
            }
            lastScroll = currentScroll;
        });

        async function init() {
            if(!docId) return alert("Enlace de Nodo inv√°lido.");
            const res = await fetch(`${URL}/rest/v1/Perfiles_Medicos?id=eq.${docId}`, { headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` } });
            const data = await res.json();
            
            if(data.length > 0) {
                doctorConfig = data[0];
                document.getElementById('doc-name').innerText = "Dr. " + doctorConfig.nombre_doctor;
                document.getElementById('doc-esp').innerText = doctorConfig.especialidad + " | Nodo Activo";
                
                renderCalendar();
            }
        }

        function renderCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            document.getElementById('month-name').innerText = monthNames[month] + " " + year;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const calBody = document.getElementById('calendar-body');
            calBody.innerHTML = '';

            for(let i=0; i<firstDay; i++) { calBody.innerHTML += `<div></div>`; }

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const div = document.createElement('div');
                div.className = `day-box ${d === now.getDate() ? 'border-2 border-indigo-500' : ''}`;
                div.innerText = d;
                div.onclick = () => seleccionarDia(dateStr, div);
                calBody.appendChild(div);
            }
        }

        async function seleccionarDia(fecha, elemento) {
            document.querySelectorAll('.day-box').forEach(b => b.classList.remove('selected'));
            elemento.classList.add('selected');
            document.getElementById('fecha-seleccionada').value = fecha;

            const contenedor = document.getElementById('contenedor-horas');
            contenedor.innerHTML = '<p class="col-span-3 text-center text-[7px] animate-pulse">VERIFICANDO AGENDA...</p>';

            const res = await fetch(`${URL}/rest/v1/Citas_Agendadas?doctor_id=eq.${docId}&fecha_cita=eq.${fecha}`, {
                headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` }
            });
            const citas = await res.json();
            const ocupadas = citas.map(c => c.hora_cita.substring(0, 5));

            contenedor.innerHTML = '';
            let inicio = doctorConfig.hora_inicio || "09:00:00";
            let fin = doctorConfig.hora_fin || "17:00:00";
            let duracion = doctorConfig.duracion_cita_min || 30;

            let hActual = new Date(`2026-01-01T${inicio}`);
            let hFinal = new Date(`2026-01-01T${fin}`);

            while(hActual < hFinal) {
                const tHora = hActual.toTimeString().substring(0, 5);
                const btn = document.createElement('div');
                const isOcupada = ocupadas.includes(tHora);
                
                btn.innerText = tHora;
                btn.className = `btn-hora ${isOcupada ? 'hora-ocupada' : 'hora-disponible'}`;
                if(!isOcupada) {
                    btn.onclick = () => {
                        document.querySelectorAll('.btn-hora').forEach(b => b.classList.remove('hora-seleccionada'));
                        btn.classList.add('hora-seleccionada');
                        document.getElementById('hora-seleccionada').value = tHora + ":00";
                    };
                }
                contenedor.appendChild(btn);
                hActual.setMinutes(hActual.getMinutes() + duracion);
            }
        }

        document.getElementById('form-cita').addEventListener('submit', async (e) => {
            e.preventDefault();
            const hora = document.getElementById('hora-seleccionada').value;
            const fecha = document.getElementById('fecha-seleccionada').value;
            if(!hora || !fecha) return alert("Por favor selecciona d√≠a y hora.");

            const btn = document.getElementById('btn-submit');
            btn.innerText = "RESERVANDO ESPACIO..."; btn.disabled = true;

            const fullTel = "+" + document.getElementById('lada').value + document.getElementById('telefono').value;

            try {
                const res = await fetch(`${URL}/rest/v1/Citas_Agendadas`, {
                    method: 'POST',
                    headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        doctor_id: docId,
                        nombre_paciente: document.getElementById('nombre').value,
                        fecha_cita: fecha,
                        hora_cita: hora,
                        telefono: fullTel
                    })
                });

                if(res.ok) {
                    alert("‚úÖ ¬°CITA CONFIRMADA!\nTu espacio ha sido bloqueado en el sistema.");
                    location.reload();
                } else { alert("Error de red. Intenta de nuevo."); }
            } catch(e) { alert("Error cr√≠tico de conexi√≥n."); }
        });

        init();
    </script>
</body>
</html>
