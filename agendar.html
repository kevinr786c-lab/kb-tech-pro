<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | AGENDADOR ELITE ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        :root { --main: #c5a059; --dark: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: var(--dark); }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(197, 160, 89, 0.2); border-radius: 2.5rem; }
        .input-elite { width: 100%; padding: 1rem; border-radius: 1.2rem; border: 1px solid #e2e8f0; outline: none; transition: 0.3s; font-weight: 600; }
        .input-elite:focus { border-color: var(--main); box-shadow: 0 0 0 4px rgba(197, 160, 89, 0.1); }
        .time-pill { padding: 0.8rem; border-radius: 1rem; border: 1px solid #e2e8f0; text-align: center; cursor: pointer; font-weight: 800; font-size: 0.8rem; transition: 0.3s; background: white; }
        .time-pill.selected { background: var(--main); color: white; border-color: var(--main); transform: scale(1.05); }
        .btn-mision { width: 100%; padding: 1.2rem; border-radius: 1.5rem; background: var(--dark); color: white; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; transition: 0.4s; }
        .btn-mision:hover { background: var(--main); transform: translateY(-3px); }
        .memoria-tag { background: #f0fdf4; color: #10b981; padding: 0.2rem 0.6rem; border-radius: 0.5rem; font-size: 0.6rem; font-weight: 900; display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full glass p-8 shadow-2xl">
        <header class="text-center mb-8">
            <h1 id="doc-name" class="text-xl font-black italic uppercase tracking-tighter">Cargando B√∫nker...</h1>
            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Terminal de Agendamiento Inteligente</p>
        </header>

        <form id="agendador-form" class="space-y-5">
            <div>
                <div class="flex justify-between items-center mb-2 px-1">
                    <p class="text-[10px] font-black uppercase text-slate-400 italic">Identificaci√≥n (Tel√©fono)</p>
                    <span id="memoria-status" class="memoria-tag italic tracking-tighter">‚úì PACIENTE RECORDADO</span>
                </div>
                <input type="tel" id="telefono" placeholder="10 D√çGITOS" class="input-elite" maxlength="10" required>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <input type="text" id="nombre" placeholder="NOMBRE COMPLETO" class="input-elite uppercase" required>
                <div class="grid grid-cols-2 gap-2">
                    <input type="email" id="email" placeholder="EMAIL" class="input-elite text-xs">
                    <input type="date" id="fecha_nacimiento" class="input-elite text-xs">
                </div>
            </div>

            <div class="space-y-4">
                <select id="servicio" class="input-elite text-xs uppercase font-bold" required>
                    <option value="" disabled selected>Seleccione Servicio</option>
                </select>
                <input type="date" id="fecha" class="input-elite">
            </div>

            <div id="radar-horas" class="grid grid-cols-3 gap-2 py-2">
                </div>

            <input type="hidden" id="hora_seleccionada">
            <button type="submit" id="confirmar-btn" class="btn-mision">Confirmar Cita ‚ú¶</button>
        </form>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');
    const docId = '196c57b5-68d5-4825-8607-36b5d3bc3e15';

    // üß† L√ìGICA DE MEMORIA: Detectar paciente al escribir el tel√©fono
    document.getElementById('telefono').addEventListener('input', async (e) => {
        const tel = e.target.value;
        if (tel.length === 10) {
            const { data, error } = await supabase.from('Pacientes').select('*').eq('telefono', tel).maybeSingle();
            if (data) {
                document.getElementById('nombre').value = data.nombre;
                document.getElementById('email').value = data.email || '';
                document.getElementById('fecha_nacimiento').value = data.fecha_nacimiento || '';
                document.getElementById('memoria-status').style.display = 'block';
                console.log("‚úÖ ADN Recuperado del b√∫nker.");
            }
        } else {
            document.getElementById('memoria-status').style.display = 'none';
        }
    });

    // üõ°Ô∏è REGLA DE BIOSEGURIDAD: Cargar horas respetando el buffer
    async function actualizarRadar() {
        const fecha = document.getElementById('fecha').value;
        const servId = document.getElementById('servicio').value;
        const radar = document.getElementById('radar-horas');
        
        if (!fecha || !servId) return;

        radar.innerHTML = '<p class="col-span-3 text-center text-[8px] font-black animate-pulse">Escaneando Radar...</p>';

        const servSelect = document.getElementById('servicio');
        const duracionTotal = parseInt(servSelect.selectedOptions[0].dataset.total);

        const { data: slots, error } = await supabase.rpc('obtener_horarios_disponibles', {
            p_doctor: docId,
            p_fecha: fecha,
            p_duracion: duracionTotal
        });

        radar.innerHTML = slots?.length ? '' : '<p class="col-span-3 text-center text-[8px] font-black text-rose-500">B√öNKER OCUPADO</p>';

        slots?.forEach(s => {
            const pill = document.createElement('div');
            pill.className = 'time-pill';
            pill.innerText = s.hora.slice(0,5);
            pill.onclick = () => {
                document.querySelectorAll('.time-pill').forEach(p => p.classList.remove('selected'));
                pill.classList.add('selected');
                document.getElementById('hora_seleccionada').value = s.hora;
            };
            radar.appendChild(pill);
        });
    }

    document.getElementById('fecha').onchange = actualizarRadar;
    document.getElementById('servicio').onchange = actualizarRadar;

    // INICIO: Cargar cat√°logo y nombre del doctor
    async function init() {
        const { data: doc } = await supabase.from('Usuarios').select('nombre').eq('id', docId).single();
        document.getElementById('doc-name').innerText = `DR. ${doc.nombre}`;

        const { data: servs } = await supabase.from('Servicios').select('*').eq('doctor_id', docId).eq('activo', true);
        const select = document.getElementById('servicio');
        servs?.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.dataset.total = s.duracion_total;
            opt.dataset.monto = s.precio;
            opt.innerText = `${s.nombre.toUpperCase()} ($${s.precio})`;
            select.appendChild(opt);
        });
    }

    document.getElementById('agendador-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('confirmar-btn');
        btn.disabled = true; btn.innerText = "Sincronizando...";

        // 1. Asegurar Paciente (Memoria)
        const tel = document.getElementById('telefono').value;
        const nombre = document.getElementById('nombre').value.toUpperCase();
        const email = document.getElementById('email').value;
        const fnac = document.getElementById('fecha_nacimiento').value;

        let { data: pac } = await supabase.from('Pacientes').select('id').eq('telefono', tel).maybeSingle();
        if (!pac) {
            const { data } = await supabase.from('Pacientes').insert({ nombre, telefono: tel, email, fecha_nacimiento: fnac }).select().single();
            pac = data;
        }

        // 2. Inyectar Cita
        const serv = document.getElementById('servicio').selectedOptions[0];
        const { error } = await supabase.from('Citas').insert({
            doctor_id: docId,
            paciente_id: pac.id,
            servicio_id: serv.value,
            fecha: document.getElementById('fecha').value,
            hora_inicio: document.getElementById('hora_seleccionada').value,
            duracion_cita: parseInt(serv.dataset.total),
            monto: parseFloat(serv.dataset.monto),
            estado: 'pendiente'
        });

        if (error) {
            alert("Error: " + error.message);
            btn.disabled = false; btn.innerText = "Reintentar";
        } else {
            alert("‚úÖ Cita Confirmada. El radar ha sido actualizado.");
            location.reload();
        }
    };

    init();
</script>
</body>
</html>
