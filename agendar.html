<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu Cita | K.B Tech Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.8s; overflow-x: hidden; background-color: #f8fafc; }
        :root { --main: #6366f1; }
        
        .bg-element { position: fixed; z-index: -1; opacity: 0.1; pointer-events: none; transition: 1.5s; filter: blur(4px); }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 50px 100px -20px rgba(0,0,0,0.1); }
        
        .input-modern { 
            width: 100%; padding: 1.25rem; border-radius: 1.5rem; background: #f1f5f9; 
            border: 2px solid transparent; font-weight: 700; font-size: 0.9rem; transition: 0.3s; outline: none;
        }
        .input-modern:focus { border-color: var(--main); background: white; box-shadow: 0 10px 25px -10px var(--main); }
        input[type="date"], input[type="time"] { cursor: pointer; color: #1e293b; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="visual-1" class="bg-element top-[-5%] right-[-5%] text-[25rem]"></div>
    <div id="visual-2" class="bg-element bottom-[-5%] left-[-5%] text-[20rem]"></div>

    <div class="max-w-md w-full glass-card p-10 rounded-[3.5rem] relative z-10 border-t-[10px]" id="card-main">
        <header class="text-center mb-8">
            <div id="icon-header" class="text-7xl mb-4 drop-shadow-xl animate-bounce" style="animation-duration: 4s;">üè•</div>
            <h1 id="doc-name" class="text-3xl font-black tracking-tighter text-slate-800 uppercase italic">Conectando...</h1>
            <p id="doc-esp" class="text-[9px] font-black text-slate-400 uppercase tracking-[0.4em] italic mt-2"></p>
        </header>

        <form id="form-cita" class="space-y-6">
            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 italic">Tu Nombre</label>
                <input type="text" id="nombre" placeholder="Nombre completo" class="input-modern" required>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 italic">D√≠a de Cita</label>
                <input type="date" id="fecha" class="input-modern" required>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 italic">Hora de Cita</label>
                <input type="time" id="hora" class="input-modern" required>
            </div>

            <button type="submit" id="btn-submit" class="w-full py-6 bg-slate-900 text-white rounded-[2.5rem] font-black uppercase text-[10px] tracking-[0.2em] shadow-2xl transition-all duration-500 hover:scale-105 active:scale-95">Confirmar Reservaci√≥n</button>
        </form>

        <footer class="mt-10 text-center border-t border-slate-100 pt-8">
            <button onclick="document.getElementById('modal-privacidad').classList.remove('hidden')" class="text-[10px] font-black text-slate-300 underline uppercase tracking-tighter hover:text-slate-500 transition">Aviso de Privacidad Legal</button>
        </footer>
    </div>

    <div id="modal-privacidad" class="hidden fixed inset-0 bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-6 z-50">
        <div class="bg-white p-10 rounded-[3.5rem] max-w-sm w-full shadow-2xl border-b-[12px]" id="modal-border">
            <h2 class="text-2xl font-black mb-4 uppercase italic tracking-tighter" id="priv-titulo">Privacidad</h2>
            <p class="text-xs text-slate-500 leading-relaxed mb-8 italic" id="priv-texto"></p>
            <button onclick="document.getElementById('modal-privacidad').classList.add('hidden')" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest">Entendido</button>
        </div>
    </div>

    <script>
        const URL_DB = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY_DB = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 
        const docId = new URLSearchParams(window.location.search).get('id');

        const CATALOGO_MAESTRO = {
            "Ginecolog√≠a": [
                { id: 1, color: "#f43f5e", icon: "üå∏", priv: "Tus datos de salud femenina son tratados con la m√°xima delicadeza y confidencialidad absoluta." },
                { id: 2, color: "#8b5cf6", icon: "üîÆ", priv: "Sofisticaci√≥n y calma boutique. Resguardamos tu informaci√≥n con la elegancia que mereces." },
                { id: 3, color: "#fb7185", icon: "üå∑", priv: "Suavidad y atenci√≥n prenatal. Cuidamos de ti y de tu bienestar con reserva profesional." },
                { id: 4, color: "#059669", icon: "üçÉ", priv: "Salud femenina org√°nica. Tu privacidad es un proceso natural y seguro con nosotros." },
                { id: 5, color: "#1e293b", icon: "üíé", priv: "Discreci√≥n de alta gama. Protocolos de √©lite para el manejo confidencial de tu historial cl√≠nico." }
            ],
            "Odontolog√≠a": [
                { id: 1, color: "#0ea5e9", icon: "üíé", priv: "Limpieza y tecnolog√≠a. Registros dentales protegidos bajo seguridad digital extrema." },
                { id: 2, color: "#10b981", icon: "üåø", priv: "Frescura y salud dental. Tu historial dental est√° resguardado en un entorno √©tico y profesional." },
                { id: 3, color: "#22d3ee", icon: "‚ùÑÔ∏è", priv: "Est√©tica y blanqueamiento. Protegemos tu diagn√≥stico est√©tico con tecnolog√≠a de vanguardia." },
                { id: 4, color: "#1e3a8a", icon: "üõ°Ô∏è", priv: "Cirug√≠a e implantes. M√°xima seguridad digital para tus procedimientos especializados." },
                { id: 5, color: "#6366f1", icon: "‚ö°", priv: "Innovaci√≥n 3D. Tus diagn√≥sticos digitales est√°n protegidos por encriptaci√≥n m√©dica avanzada." }
            ],
            "Pediatr√≠a": [
                { id: 1, color: "#fb923c", icon: "üß∏", priv: "Entorno alegre y seguro. La privacidad de los ni√±os es sagrada y est√° totalmente protegida." },
                { id: 2, color: "#38bdf8", icon: "üöÄ", priv: "Confianza y juego. Solo tutores autorizados tienen acceso al historial cl√≠nico del menor." },
                { id: 3, color: "#4ade80", icon: "ü¶ñ", priv: "Aventura segura. Datos pedi√°tricos resguardados con absoluta √©tica y reserva profesional." },
                { id: 4, color: "#f472b6", icon: "üç≠", priv: "Dulce cuidado infantil. Tratamos la informaci√≥n con la ternura y seguridad que tu familia merece." },
                { id: 5, color: "#818cf8", icon: "üåô", priv: "Estrella de calma. Un entorno sereno para resguardar la salud y privacidad de los m√°s peque√±os." }
            ],
            "Cardiolog√≠a": [
                { id: 1, color: "#e11d48", icon: "‚ù§Ô∏è", priv: "Precisi√≥n card√≠aca. Utilizamos encriptaci√≥n de grado m√©dico para proteger tus datos vitales." },
                { id: 2, color: "#1e293b", icon: "‚ö°", priv: "Seriedad y vanguardia. Monitoreo cardiovascular bajo est√°ndares tecnol√≥gicos de alta seguridad." },
                { id: 3, color: "#0284c7", icon: "üåä", priv: "Flujo y salud vascular. Tus datos circulatorios est√°n protegidos por tecnolog√≠a de punta." },
                { id: 4, color: "#9f1239", icon: "ü©∏", priv: "Hematolog√≠a especializada. Resguardo √©tico de tus an√°lisis y datos sangu√≠neos bajo protocolos." },
                { id: 5, color: "#4f46e5", icon: "üõ∞Ô∏è", priv: "Ciber Cardiolog√≠a. Seguridad satelital aplicada a tu monitoreo card√≠aco en tiempo real." }
            ],
            "Bienestar (Nutri/Psico)": [
                { id: 1, color: "#059669", icon: "üßò‚Äç‚ôÇÔ∏è", priv: "Equilibrio y paz. Tus notas de consulta son privadas y encriptadas √©ticamente." },
                { id: 2, color: "#a855f7", icon: "üß†", priv: "Crecimiento seguro. Tu historia emocional es confidencial y est√° protegida en nuestra nube." },
                { id: 3, color: "#fbbf24", icon: "üçé", priv: "Nutrici√≥n energ√©tica. Planes alimenticios resguardados con absoluta reserva." },
                { id: 4, color: "#0ea5e9", icon: "üåä", priv: "Inmersi√≥n emocional. Confidencialidad absoluta para tu proceso de sanaci√≥n y bienestar." },
                { id: 5, color: "#10b981", icon: "ü•ë", priv: "Vida saludable. Privacidad integral para tu estilo de vida fit y seguro." }
            ],
            "General": [
                { id: 1, color: "#1e3a8a", icon: "‚öñÔ∏è", priv: "Autoridad m√©dica. Datos personales y notas de consulta encriptadas bajo la ley vigente." },
                { id: 2, color: "#6366f1", icon: "üè•", priv: "Innovaci√≥n moderna. Seguridad digital de √∫ltima generaci√≥n para tu historial cl√≠nico con control." },
                { id: 3, color: "#10b981", icon: "ü©∫", priv: "Salud b√°sica. Atenci√≥n primaria con seguridad avanzada para el resguardo de tus datos." },
                { id: 4, color: "#be123c", icon: "üöë", priv: "Urgencias m√©dicas. Seguridad inmediata para datos cr√≠ticos en situaciones de emergencia." },
                { id: 5, color: "#4338ca", icon: "üè¢", priv: "Red hospitalaria. Protecci√≥n de datos a escala corporativa para redes de salud seguras." }
            ]
        };

        async function init() {
            if(!docId) return alert("Falta Nodo M√©dico.");
            const res = await fetch(`${URL_DB}/rest/v1/Perfiles_Medicos?id=eq.${docId}`, { headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}` } });
            const data = await res.json();
            
            if(data.length > 0) {
                const doc = data[0];
                const especialidad = doc.especialidad;
                const template_id = doc.template_id;

                const cat = CATALOGO_MAESTRO[especialidad] || CATALOGO_MAESTRO["General"];
                const tema = cat.find(t => t.id === template_id) || cat[0];

                // Identidad Visual
                document.getElementById('doc-name').innerText = "Dr. " + doc.nombre_doctor;
                document.getElementById('doc-esp').innerText = especialidad;
                document.getElementById('icon-header').innerText = tema.icon;
                document.documentElement.style.setProperty('--main', tema.color);
                
                document.getElementById('btn-submit').style.backgroundColor = tema.color;
                document.getElementById('card-main').style.borderColor = tema.color;
                document.getElementById('modal-border').style.borderColor = tema.color;
                document.getElementById('visual-1').innerText = tema.icon;
                document.getElementById('visual-2').innerText = tema.icon;

                // Privacidad
                document.getElementById('priv-texto').innerText = "AVISO LEGAL: " + tema.priv;
                document.getElementById('priv-titulo').style.color = tema.color;
            }
        }

        document.getElementById('form-cita').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "PROCESANDO..."; btn.disabled = true;

            const res = await fetch(`${URL_DB}/rest/v1/Citas`, {
                method: 'POST',
                headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    doctor_id: docId,
                    nombre_paciente: document.getElementById('nombre').value,
                    fecha: document.getElementById('fecha').value,
                    hora: document.getElementById('hora').value,
                    pagado: false
                })
            });

            if(res.ok) {
                alert("¬°SOLICITUD ENVIADA!\nRecibir√°s una confirmaci√≥n del consultorio.");
                location.reload();
            } else {
                alert("Error al agendar.");
                btn.innerText = "Confirmar Reservaci√≥n"; btn.disabled = false;
            }
        });

        init();
    </script>
</body>
</html>
