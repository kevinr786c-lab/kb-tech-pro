<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B Tech | Reservaci√≥n de √âlite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.8s cubic-bezier(0.4, 0, 0.2, 1); overflow-x: hidden; background-color: #f8fafc; }
        .bg-element { position: fixed; z-index: -1; opacity: 0.1; pointer-events: none; transition: 1.5s; filter: blur(4px); }
        :root { --main: #6366f1; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 50px 100px -20px rgba(0,0,0,0.08); }
        input { transition: 0.3s !important; }
        input:focus { transform: scale(1.01); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="visual-1" class="bg-element top-[-10%] right-[-10%] text-[30rem]"></div>
    <div id="visual-2" class="bg-element bottom-[-10%] left-[-10%] text-[20rem]"></div>

    <div class="max-w-md w-full glass-card p-10 rounded-[3.5rem] relative z-10 border-t-8" id="card-border">
        <header class="text-center mb-10">
            <div id="icon-header" class="text-7xl mb-4 drop-shadow-xl animate-bounce" style="animation-duration: 3s;">üè•</div>
            <h1 id="doc-name" class="text-3xl font-black tracking-tighter text-slate-800 uppercase italic">Conectando Nodo...</h1>
            <p id="doc-esp" class="text-[10px] font-black text-slate-400 uppercase tracking-[0.4em] italic mt-2"></p>
        </header>

        <form id="form-cita" class="space-y-6">
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 tracking-widest italic">Nombre Completo</label>
                <input type="text" id="nombre" placeholder="Tu nombre" class="w-full p-5 rounded-3xl bg-slate-50 border-2 border-transparent focus:border-[var(--main)] focus:bg-white text-sm font-bold outline-none" required>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-400 ml-4 tracking-widest italic">Fecha</label>
                    <input type="date" id="fecha" class="w-full p-5 rounded-3xl bg-slate-50 border-2 border-transparent focus:border-[var(--main)] text-xs font-bold outline-none" required>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-400 ml-4 tracking-widest italic">Hora</label>
                    <input type="time" id="hora" class="w-full p-5 rounded-3xl bg-slate-50 border-2 border-transparent focus:border-[var(--main)] text-xs font-bold outline-none" required>
                </div>
            </div>

            <button type="submit" id="btn-submit" class="w-full py-6 bg-[var(--main)] text-white rounded-[2.5rem] font-black uppercase text-xs tracking-widest shadow-2xl transition-all duration-500 hover:scale-105 active:scale-95" style="background-color: var(--main);">Confirmar Cita</button>
        </form>

        <footer class="mt-10 text-center border-t border-slate-100 pt-8">
            <button onclick="document.getElementById('modal-privacidad').classList.remove('hidden')" class="text-[10px] font-black text-slate-400 underline uppercase tracking-widest hover:text-slate-600 transition">Aviso de Privacidad Especializado</button>
        </footer>
    </div>

    <div id="modal-privacidad" class="hidden fixed inset-0 bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-6 z-50">
        <div class="bg-white p-10 rounded-[3.5rem] max-w-sm w-full shadow-2xl border-b-8 border-[var(--main)]">
            <h2 class="text-2xl font-black mb-4 uppercase italic tracking-tighter" id="priv-titulo">Protecci√≥n de Datos</h2>
            <p class="text-xs text-slate-500 leading-relaxed mb-8 italic" id="priv-texto"></p>
            <button onclick="document.getElementById('modal-privacidad').classList.add('hidden')" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest">Entendido</button>
        </div>
    </div>

    <script>
        const URL_DB = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY_DB = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 
        const docId = new URLSearchParams(window.location.search).get('id');

        // MAPA MAESTRO DE 6 ESPECIALIDADES Y SUS TEMAS (Sincronizado con Registro)
        const MAPA_ESTILOS = {
            "Ginecolog√≠a": { color: "#f43f5e", icon: "üå∏", bg: "üå∏", priv: "Tus datos de salud femenina son tratados con la m√°xima delicadeza y confidencialidad cl√≠nica." },
            "Odontolog√≠a": { color: "#0ea5e9", icon: "üíé", bg: "ü¶∑", priv: "Resguardamos tus registros dentales y radiogr√°ficos bajo protocolos de alta seguridad digital." },
            "Pediatr√≠a": { color: "#fb923c", icon: "üß∏", bg: "üéà", priv: "La privacidad de los m√°s peque√±os es sagrada. Seguridad total para datos pedi√°tricos." },
            "Cardiolog√≠a": { color: "#e11d48", icon: "‚ù§Ô∏è", bg: "üìà", priv: "Encriptaci√≥n de grado m√©dico para proteger tus datos vitales y diagn√≥stico card√≠aco." },
            "Bienestar (Nutri/Psico)": { color: "#059669", icon: "üßò‚Äç‚ôÇÔ∏è", bg: "üçÉ", priv: "Tus notas de consulta son encriptadas, asegurando que tu proceso de bienestar sea privado." },
            "General": { color: "#6366f1", icon: "üè•", bg: "üß¨", priv: "Seguridad digital de √∫ltima generaci√≥n para resguardar tu historial cl√≠nico con control total." }
        };

        async function init() {
            if(!docId) return;
            const res = await fetch(`${URL_DB}/rest/v1/Perfiles_Medicos?id=eq.${docId}`, {
                headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}` }
            });
            const data = await res.json();
            
            if(data.length > 0) {
                const doc = data[0];
                // Buscar estilo por especialidad, si no existe usa "General"
                const estilo = MAPA_ESTILOS[doc.especialidad] || MAPA_ESTILOS["General"];

                document.getElementById('doc-name').innerText = "Dr. " + doc.nombre_doctor;
                document.getElementById('doc-esp').innerText = doc.especialidad;
                document.getElementById('icon-header').innerText = estilo.icon;
                document.documentElement.style.setProperty('--main', estilo.color);
                document.getElementById('card-border').style.borderColor = estilo.color;

                // Visuales de fondo
                document.getElementById('visual-1').innerText = estilo.bg;
                document.getElementById('visual-2').innerText = estilo.icon;

                // Modal Privacidad
                document.getElementById('priv-texto').innerText = estilo.priv;
                document.getElementById('priv-titulo').style.color = estilo.color;
            }
        }

        document.getElementById('form-cita').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "PROCESANDO..."; btn.disabled = true;

            const res = await fetch(`${URL_DB}/rest/v1/Citas`, {
                method: 'POST',
                headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    doctor_id: docId,
                    nombre_paciente: document.getElementById('nombre').value,
                    fecha: document.getElementById('fecha').value,
                    hora: document.getElementById('hora').value,
                    pagado: false
                })
            });

            if(res.ok) {
                alert("¬°CITA REGISTRADA!\nEl consultorio ha sido notificado.");
                location.reload();
            } else {
                alert("Error de conexi√≥n.");
                btn.innerText = "Confirmar Cita"; btn.disabled = false;
            }
        });

        init();
    </script>
</body>
</html>
