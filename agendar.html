<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu Cita | K.B Tech Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.8s; overflow-x: hidden; background-color: #f8fafc; }
        :root { --main: #6366f1; }
        
        .bg-element { position: fixed; z-index: -1; opacity: 0.1; pointer-events: none; transition: 1.5s; filter: blur(4px); }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 50px 100px -20px rgba(0,0,0,0.1); }
        
        .input-modern { 
            width: 100%; padding: 1.25rem; border-radius: 1.5rem; background: #f1f5f9; 
            border: 2px solid transparent; font-weight: 700; font-size: 0.9rem; transition: 0.3s; outline: none;
        }
        .input-modern:focus { border-color: var(--main); background: white; box-shadow: 0 10px 25px -10px var(--main); }
        
        /* CALENDARIO GRID */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; }
        .day-box { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 1rem; font-size: 0.75rem; font-weight: 800; cursor: pointer; transition: 0.2s; border: 1px solid #f1f5f9; background: white; }
        .day-box:hover { border-color: var(--main); background: #f8fafc; }
        .day-box.selected { background: var(--main); color: white; border-color: var(--main); box-shadow: 0 10px 15px -5px var(--main); }
        .day-name { text-align: center; font-size: 0.6rem; font-weight: 800; color: #cbd5e1; text-transform: uppercase; }

        /* Sistema de Horarios */
        .grid-horas { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .btn-hora { 
            padding: 12px; border-radius: 1.2rem; font-weight: 800; font-size: 0.75rem; 
            transition: 0.3s; text-align: center; border: 2px solid transparent; cursor: pointer;
        }
        .hora-disponible { background: #f1f5f9; color: #475569; }
        .hora-disponible:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -5px var(--main); border-color: var(--main); }
        .hora-ocupada { background: #fee2e2; color: #991b1b; opacity: 0.5; cursor: not-allowed; border-color: #f87171; text-decoration: line-through; }
        .hora-seleccionada { background: var(--main) !important; color: white !important; transform: scale(1.05); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="visual-1" class="bg-element top-[-5%] right-[-5%] text-[25rem]"></div>
    <div id="visual-2" class="bg-element bottom-[-5%] left-[-5%] text-[20rem]"></div>

    <div class="max-w-md w-full glass-card p-10 rounded-[3.5rem] relative z-10 border-t-[10px]" id="card-main">
        <header class="text-center mb-8">
            <div id="icon-header" class="text-7xl mb-4 drop-shadow-xl animate-bounce" style="animation-duration: 4s;">üè•</div>
            <h1 id="doc-name" class="text-3xl font-black tracking-tighter text-slate-800 uppercase italic">Conectando...</h1>
            <p id="doc-esp" class="text-[9px] font-black text-slate-400 uppercase tracking-[0.4em] italic mt-2"></p>
        </header>

        <form id="form-cita" class="space-y-6">
            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 italic">Tu Nombre</label>
                <input type="text" id="nombre" placeholder="Nombre completo" class="input-modern" required>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 italic">WhatsApp (Internacional)</label>
                <div class="flex gap-2">
                    <select id="lada" class="w-24 input-modern !px-2 text-xs">
                        <option value="52">üá≤üáΩ +52</option>
                        <option value="1">üá∫üá∏ +1</option>
                        <option value="1">üá®üá¶ +1</option>
                        <option value="502">üá¨üáπ +502</option>
                        <option value="34">üá™üá∏ +34</option>
                    </select>
                    <input type="tel" id="telefono" placeholder="N√∫mero" class="flex-1 input-modern" required>
                </div>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 italic">Selecciona el D√≠a</label>
                <div id="month-name" class="text-[10px] font-black text-[var(--main)] uppercase italic text-center mb-2">Febrero 2026</div>
                <div class="grid grid-cols-7 gap-1 text-center mb-2">
                    <div class="day-name">D</div><div class="day-name">L</div><div class="day-name">M</div><div class="day-name">M</div><div class="day-name">J</div><div class="day-name">V</div><div class="day-name">S</div>
                </div>
                <div id="calendar-body" class="calendar-grid"></div>
                <input type="hidden" id="fecha-seleccionada" required>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-4 italic">Horarios Disponibles</label>
                <div id="contenedor-horas" class="grid-horas">
                    <p class="col-span-3 text-[8px] text-center text-slate-400 py-4 uppercase font-bold tracking-widest">Elige un d√≠a en el calendario</p>
                </div>
                <input type="hidden" id="hora-seleccionada" required>
            </div>

            <button type="submit" id="btn-submit" class="w-full py-6 bg-slate-900 text-white rounded-[2.5rem] font-black uppercase text-[10px] tracking-[0.2em] shadow-2xl transition-all duration-500 hover:scale-105 active:scale-95">Confirmar Reservaci√≥n</button>
        </form>

        <footer class="mt-10 text-center border-t border-slate-100 pt-8">
            <button onclick="document.getElementById('modal-privacidad').classList.remove('hidden')" class="text-[10px] font-black text-slate-300 underline uppercase tracking-tighter hover:text-slate-500 transition">Aviso de Privacidad Legal</button>
        </footer>
    </div>

    <div id="modal-privacidad" class="hidden fixed inset-0 bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-6 z-50">
        <div class="bg-white p-10 rounded-[3.5rem] max-w-sm w-full shadow-2xl border-b-[12px]" id="modal-border">
            <h2 class="text-2xl font-black mb-4 uppercase italic tracking-tighter" id="priv-titulo">Privacidad</h2>
            <p class="text-xs text-slate-500 leading-relaxed mb-8 italic" id="priv-texto"></p>
            <button onclick="document.getElementById('modal-privacidad').classList.add('hidden')" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest">Entendido</button>
        </div>
    </div>

    <script>
        const URL_DB = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY_DB = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 
        const docId = new URLSearchParams(window.location.search).get('id');
        let doctorConfig = null;

        const CATALOGO_MAESTRO = {
            "Ginecolog√≠a": [{id:1,color:"#f43f5e",icon:"üå∏",priv:"Tus datos son tratados con m√°xima confidencialidad."}],
            "Odontolog√≠a": [{id:1,color:"#0ea5e9",icon:"üíé",priv:"Registros dentales protegidos bajo seguridad digital."}],
            "Pediatr√≠a": [{id:1,color:"#fb923c",icon:"üß∏",priv:"La privacidad de los ni√±os es sagrada."}],
            "Cardiolog√≠a": [{id:1,color:"#e11d48",icon:"‚ù§Ô∏è",priv:"Encriptaci√≥n de grado m√©dico para tus datos vitales."}],
            "Bienestar (Nutri/Psico)": [{id:1,color:"#059669",icon:"üßò‚Äç‚ôÇÔ∏è",priv:"Tus notas de consulta son privadas y encriptadas."}],
            "General": [{id:1,color:"#1e3a8a",icon:"‚öñÔ∏è",priv:"Datos personales encriptados bajo la ley vigente."}]
        };

        async function init() {
            if(!docId) return alert("Error de enlace.");
            const res = await fetch(`${URL_DB}/rest/v1/Perfiles_Medicos?id=eq.${docId}`, { headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}` } });
            const data = await res.json();
            if(data.length > 0) {
                doctorConfig = data[0];
                const cat = CATALOGO_MAESTRO[doctorConfig.especialidad] || CATALOGO_MAESTRO["General"];
                const tema = cat.find(t => t.id === doctorConfig.template_id) || cat[0];

                document.getElementById('doc-name').innerText = "Dr. " + doctorConfig.nombre_doctor;
                document.getElementById('doc-esp').innerText = doctorConfig.especialidad;
                document.getElementById('icon-header').innerText = tema.icon;
                document.documentElement.style.setProperty('--main', tema.color);
                document.getElementById('btn-submit').style.backgroundColor = tema.color;
                document.getElementById('card-main').style.borderColor = tema.color;
                document.getElementById('modal-border').style.borderColor = tema.color;
                document.getElementById('priv-texto').innerText = "AVISO LEGAL: " + tema.priv;
                
                renderCalendar();
            }
        }

        function renderCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const calBody = document.getElementById('calendar-body');
            calBody.innerHTML = '';

            for(let i=0; i<firstDay; i++) { calBody.innerHTML += `<div></div>`; }

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const div = document.createElement('div');
                div.className = `day-box ${d === now.getDate() ? 'border-2 border-[var(--main)]' : ''}`;
                div.innerText = d;
                div.onclick = () => seleccionarDia(dateStr, div);
                calBody.appendChild(div);
            }
        }

        async function seleccionarDia(fecha, elemento) {
            document.querySelectorAll('.day-box').forEach(b => b.classList.remove('selected'));
            elemento.classList.add('selected');
            document.getElementById('fecha-seleccionada').value = fecha;

            const contenedor = document.getElementById('contenedor-horas');
            contenedor.innerHTML = '<p class="col-span-3 text-center text-[8px] animate-pulse">ESCANEANDO DISPONIBILIDAD...</p>';

            const res = await fetch(`${URL_DB}/rest/v1/Citas_Agendadas?doctor_id=eq.${docId}&fecha_cita=eq.${fecha}`, {
                headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}` }
            });
            const citas = await res.json();
            const ocupadas = citas.map(c => c.hora_cita.substring(0, 5));

            contenedor.innerHTML = '';
            let inicio = doctorConfig.hora_inicio || "09:00:00";
            let fin = doctorConfig.hora_fin || "17:00:00";
            let duracion = doctorConfig.duracion_cita_min || 30;

            let hActual = new Date(`2026-01-01T${inicio}`);
            let hFinal = new Date(`2026-01-01T${fin}`);

            while(hActual < hFinal) {
                const textoHora = hActual.toTimeString().substring(0, 5);
                const isOcupada = ocupadas.includes(textoHora);
                const btn = document.createElement('div');
                btn.innerText = textoHora;
                btn.className = `btn-hora ${isOcupada ? 'hora-ocupada' : 'hora-disponible'}`;
                if(!isOcupada) {
                    btn.onclick = () => {
                        document.querySelectorAll('.btn-hora').forEach(b => b.classList.remove('hora-seleccionada'));
                        btn.classList.add('hora-seleccionada');
                        document.getElementById('hora-seleccionada').value = textoHora + ":00";
                    };
                }
                contenedor.appendChild(btn);
                hActual.setMinutes(hActual.getMinutes() + duracion);
            }
        }

        document.getElementById('form-cita').addEventListener('submit', async (e) => {
            e.preventDefault();
            const hora = document.getElementById('hora-seleccionada').value;
            const fecha = document.getElementById('fecha-seleccionada').value;
            if(!hora || !fecha) return alert("‚ö†Ô∏è Selecciona d√≠a y hora.");

            const btn = document.getElementById('btn-submit');
            btn.innerText = "RESERVANDO..."; btn.disabled = true;

            const fullTel = "+" + document.getElementById('lada').value + document.getElementById('telefono').value;

            const res = await fetch(`${URL_DB}/rest/v1/Citas_Agendadas`, {
                method: 'POST',
                headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    doctor_id: docId,
                    nombre_paciente: document.getElementById('nombre').value,
                    fecha_cita: fecha,
                    hora_cita: hora,
                    telefono: fullTel
                })
            });

            if(res.ok) {
                alert("‚úÖ ¬°CITA CONFIRMADA!\nTu espacio ha sido reservado.");
                location.reload();
            } else {
                alert("‚ùå Error al reservar.");
                btn.innerText = "Confirmar Reservaci√≥n"; btn.disabled = false;
            }
        });

        init();
    </script>
</body>
</html>
