<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA M√âDICO | AGENDADOR UNIVERSAL ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; color: #111827; -webkit-tap-highlight-color: transparent; }
        
        /* üì± AJUSTES T√ÅCTICOS PARA M√ìVIL */
        .card-responsive { background: #ffffff; border-radius: 1.5rem; border: 1px solid #e5e7eb; transition: all 0.3s; }
        @media (max-width: 640px) {
            .card-responsive { border-radius: 0; border: none; box-shadow: none; min-height: 100vh; }
            body { background-color: #ffffff; padding: 0 !important; }
        }

        .input-clean { width: 100%; padding: 0.85rem 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db; outline: none; transition: 0.2s; background: #fff; font-size: 16px; /* Evita zoom autom√°tico en iPhone */ }
        .input-clean:focus { border-color: #111827; ring: 1px; ring-color: #111827; }
        
        .time-pill { padding: 0.75rem 0.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; text-align: center; cursor: pointer; font-size: 0.85rem; font-weight: 700; background: #f9fafb; transition: 0.2s; }
        .time-pill.selected { background: #111827; color: white; border-color: #111827; transform: scale(0.95); }
        
        /* Animaci√≥n de carga sutil */
        .kb-star { color: #d1d5db; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-2xl w-full card-responsive p-6 md:p-10 shadow-xl">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 id="doc-name" class="text-xl md:text-2xl font-extrabold tracking-tight text-gray-900 uppercase">SINCRONIZANDO...</h1>
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-[0.3em] mt-1 italic">M√≥dulo de Agendado Universal ‚ú¶</p>
            </div>
            <button onclick="window.history.back()" class="p-2 text-gray-300 hover:text-gray-900 transition">‚úï</button>
        </header>

        <form id="form-agendar" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase ml-1">Nombre Completo</label>
                    <input type="text" id="p-nombre" placeholder="Nombre del paciente" class="input-clean" required>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase ml-1">WhatsApp</label>
                    <input type="tel" id="p-telefono" placeholder="10 d√≠gitos" class="input-clean" required>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase ml-1">Email</label>
                    <input type="email" id="p-email" placeholder="Opcional" class="input-clean">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase ml-1">Cumplea√±os üéÇ</label>
                    <input type="date" id="p-cumple" class="input-clean" required>
                </div>
            </div>

            <div class="pt-4 border-t border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-gray-400 uppercase ml-1">Servicio</label>
                        <select id="servicio-select" class="input-clean appearance-none" required>
                            <option value="" disabled selected>Seleccione servicio</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-gray-400 uppercase ml-1">Fecha de Consulta</label>
                        <input type="date" id="c-fecha" class="input-clean" required>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <label class="text-[10px] font-black text-gray-400 uppercase ml-1">Horarios Disponibles</label>
                <div id="radar-horas" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                    <p class="col-span-full text-center text-[10px] text-gray-300 font-bold uppercase py-4">Esperando selecci√≥n...</p>
                </div>
            </div>

            <input type="hidden" id="hora-seleccionada">
            
            <button type="submit" id="btn-confirmar" class="w-full py-4 md:py-5 bg-gray-900 text-white rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-black transition-all shadow-lg active:scale-95">
                Confirmar Reservaci√≥n ‚ú¶
            </button>
        </form>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('docId') || '196c57b5-68d5-4825-8607-36b5d3bc3e15';

    async function init() {
        const { data: doc } = await supabase.from('Usuarios').select('nombre').eq('id', docId).single();
        if(doc) document.getElementById('doc-name').innerText = `DR. ${doc.nombre.toUpperCase()}`;

        const { data: servs } = await supabase.from('Servicios').select('*').eq('doctor_id', docId).eq('activo', true);
        const select = document.getElementById('servicio-select');
        servs?.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.dataset.total = s.duracion_total;
            opt.innerText = `${s.nombre.toUpperCase()} ($${s.precio})`;
            select.appendChild(opt);
        });
    }

    async function actualizarRadar() {
        const fecha = document.getElementById('c-fecha').value;
        const servId = document.getElementById('servicio-select').value;
        const radar = document.getElementById('radar-horas');
        if (!fecha || !servId) return;

        radar.innerHTML = '<p class="col-span-full text-center text-[10px] text-gray-400 animate-pulse font-bold uppercase">Escaneando...</p>';
        const duracion = document.getElementById('servicio-select').selectedOptions[0].dataset.total;

        const { data: slots } = await supabase.rpc('obtener_horarios_disponibles', {
            p_doctor: docId, p_fecha: fecha, p_duracion: parseInt(duracion)
        });

        radar.innerHTML = slots?.length ? '' : '<p class="col-span-full text-center text-[10px] text-red-500 font-bold uppercase">Sin espacios libres</p>';
        slots?.forEach(s => {
            const pill = document.createElement('div');
            pill.className = 'time-pill';
            pill.innerText = s.hora.slice(0,5);
            pill.onclick = () => {
                document.querySelectorAll('.time-pill').forEach(p => p.classList.remove('selected'));
                pill.classList.add('selected');
                document.getElementById('hora-seleccionada').value = s.hora;
            };
            radar.appendChild(pill);
        });
    }

    document.getElementById('c-fecha').onchange = actualizarRadar;
    document.getElementById('servicio-select').onchange = actualizarRadar;

    document.getElementById('form-agendar').onsubmit = async (e) => {
        e.preventDefault();
        const hora = document.getElementById('hora-seleccionada').value;
        if(!hora) return alert("Por favor seleccione un horario.");

        const btn = document.getElementById('btn-confirmar');
        btn.disabled = true; btn.innerText = "SINCRONIZANDO...";

        try {
            const { data: pac } = await supabase.from('Usuarios').upsert({
                nombre: document.getElementById('p-nombre').value.toUpperCase(),
                telefono: document.getElementById('p-telefono').value,
                email: document.getElementById('p-email').value,
                fecha_nacimiento: document.getElementById('p-cumple').value,
                rol: 'paciente'
            }, { onConflict: 'telefono' }).select().single();

            const { error } = await supabase.from('Citas').insert({
                doctor_id: docId,
                paciente_id: pac.id,
                servicio_id: document.getElementById('servicio-select').value,
                fecha: document.getElementById('c-fecha').value,
                hora_inicio: hora,
                duracion_cita: parseInt(document.getElementById('servicio-select').selectedOptions[0].dataset.total),
                estado: 'confirmada'
            });

            if (!error) {
                alert("‚úÖ MISI√ìN CUMPLIDA: CITA AGENDADA.");
                const msj = `Hola ${pac.nombre}, su cita con el Dr. ha sido confirmada para el ${document.getElementById('c-fecha').value} a las ${hora}. ‚ú¶`;
                window.location.href = `https://wa.me/${pac.telefono.replace(/\D/g,'')}?text=${encodeURIComponent(msj)}`;
            }
        } catch (e) {
            alert("Error");
            btn.disabled = false;
        }
    };

    init();
</script>
</body>
</html>
