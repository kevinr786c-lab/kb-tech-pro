<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro M√©dico | K.B Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f172a; color: white; transition: 0.5s; overflow-x: hidden; }
        .preview-phone { width: 260px; height: 500px; border: 12px solid #1e293b; border-radius: 3rem; position: relative; overflow: hidden; background: #f8fafc; transition: 0.5s; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.5); }
        .color-dot { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; transition: 0.3s; border: 3px solid transparent; }
        .color-dot.active { border-color: white; transform: scale(1.2); box-shadow: 0 0 20px rgba(99,102,241,0.5); }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        .modal-pago { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); }
        .badge-plan { background: #6366f1; color: white; padding: 4px 12px; border-radius: 99px; font-size: 8px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; }
        
        .gemini-star { color: #6366f1; animation: pulse-star 3s infinite; display: inline-block; }
        @keyframes pulse-star { 0%, 100% { opacity: 1; transform: scale(1.2); } 50% { opacity: 0.4; transform: scale(1); } }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <div class="max-w-6xl w-full grid grid-cols-1 lg:grid-cols-12 gap-12 items-center">
        <div class="lg:col-span-7 space-y-8 text-left">
            <header class="flex justify-between items-start">
                <div>
                    <h1 class="text-5xl font-black italic tracking-tighter mb-2 uppercase">K.B <span id="text-logo" class="text-indigo-400">TECH</span></h1>
                    <p class="text-slate-400 text-xs uppercase tracking-[0.4em] font-bold italic"><span class="gemini-star">‚ú¶</span> Gemini Engine ‚ú¶ Sincronizando Nodo</p>
                </div>
                <div id="plan-display-badge" class="badge-plan">Sincronizando...</div>
            </header>

            <form id="form-registro" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-4 italic">Nombre del Especialista</label>
                        <input type="text" id="nombre" placeholder="Ej. Dr. Rivera" class="w-full bg-slate-800/50 p-4 rounded-2xl border border-slate-700 outline-none focus:border-white transition-all text-sm font-bold text-white uppercase" required>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-4 italic">Especialidad M√©dica</label>
                        <select id="especialidad" onchange="cambiarCatalogo()" class="w-full bg-slate-800/50 p-4 rounded-2xl border border-slate-700 outline-none text-sm font-bold text-white appearance-none cursor-pointer">
                            <option value="Ginecolog√≠a">Ginecolog√≠a</option>
                            <option value="Odontolog√≠a">Odontolog√≠a</option>
                            <option value="Pediatr√≠a">Pediatr√≠a</option>
                            <option value="Cardiolog√≠a">Cardiolog√≠a</option>
                            <option value="Bienestar (Nutri/Psico)">Bienestar (Nutri/Psico)</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="glass-card p-6 rounded-[2.5rem] border border-white/5">
                        <label class="text-[9px] font-black uppercase text-indigo-400 mb-2 block italic">Foto de Perfil (Avatar)</label>
                        <input type="file" id="foto_perfil" accept="image/*" class="text-[10px] text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:font-black file:bg-indigo-500 file:text-white hover:file:bg-indigo-400 cursor-pointer">
                    </div>
                    <div class="glass-card p-6 rounded-[2.5rem] border border-white/5">
                        <label class="text-[9px] font-black uppercase text-indigo-400 mb-2 block italic">C√©dula o Local (Validaci√≥n)</label>
                        <input type="file" id="foto_cedula" accept="image/*" class="text-[10px] text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:font-black file:bg-slate-700 file:text-white hover:file:bg-slate-600 cursor-pointer">
                    </div>
                </div>

                <div class="glass-card p-8 rounded-[3rem] space-y-6">
                    <div class="flex justify-between items-center">
                        <p class="text-[10px] font-black uppercase text-indigo-400 tracking-[0.3em] italic">Cat√°logo Camale√≥n</p>
                        <span id="theme-tag" class="text-[9px] font-black bg-white/10 px-3 py-1 rounded-full uppercase italic text-white tracking-widest">Seleccione</span>
                    </div>
                    <div id="contenedor-colores" class="flex gap-6 flex-wrap"></div>
                </div>

                <div class="flex items-center gap-6 p-6 bg-white/5 rounded-[2.5rem] border border-white/5">
                    <div class="flex-grow">
                        <p class="text-[9px] font-black uppercase text-indigo-400 mb-1 italic">Costo de Activaci√≥n</p>
                        <p class="text-4xl font-black text-white" id="precio-display">$0 <span class="text-xs text-slate-500 italic font-normal tracking-normal uppercase">MXN/mes</span></p>
                    </div>
                    <button type="submit" id="btn-activar" class="px-10 py-5 bg-indigo-500 text-white rounded-[2rem] font-black uppercase text-[10px] tracking-[0.2em] shadow-lg hover:bg-indigo-400 transition-all active:scale-95">Activar Nodo</button>
                </div>
            </form>
        </div>

        <div class="lg:col-span-5 flex flex-col items-center">
            <div id="preview-box" class="preview-phone">
                <div id="prev-bg-icon" class="absolute top-10 right-[-40px] text-[15rem] opacity-5 text-slate-900 pointer-events-none italic">üè•</div>
                <div class="p-8 text-slate-800 space-y-8 relative h-full flex flex-col justify-center bg-white/90 text-center">
                    <div id="prev-icon" class="text-6xl mb-2">üè•</div>
                    <div class="h-4 w-32 bg-slate-200 rounded-full mx-auto mb-2"></div>
                    <p id="prev-desc" class="text-[8px] text-slate-400 font-bold uppercase tracking-widest px-4 italic"></p>
                    <div id="prev-button" class="h-14 w-full rounded-[1.5rem] shadow-xl"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-pago" class="hidden fixed inset-0 modal-pago z-50 flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-[3rem] p-8 text-slate-800 shadow-2xl border-t-[12px] border-indigo-500">
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">üè¶</div>
                <h2 class="text-2xl font-black uppercase italic tracking-tighter">Pasarela BBVA</h2>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic tracking-[0.3em]">Kevin Brayan Reyes Cruz</p>
            </div>
            
            <div class="space-y-4 bg-slate-50 p-6 rounded-3xl border border-slate-100 mb-6">
                <div>
                    <p class="text-[9px] font-black text-indigo-500 uppercase italic">Clabe Interbancaria</p>
                    <p class="font-black text-lg tracking-wider">0120 2801 5649 7592 11</p>
                </div>
                <div class="pt-2 border-t border-slate-200">
                    <p class="text-[9px] font-black text-slate-400 uppercase italic">Concepto de Transferencia</p>
                    <p class="font-bold italic text-indigo-600" id="pago-concepto">CARGANDO...</p>
                </div>
            </div>

            <p class="text-[10px] text-center text-slate-500 mb-6 font-medium italic">Al confirmar el pago, Gemini Engine ‚ú¶ validar√° la transacci√≥n y activar√° tu Nodo Maestro autom√°ticamente.</p>
            
            <button onclick="irANodo()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl hover:bg-slate-900 transition-all active:scale-95">He realizado la transferencia</button>
        </div>
    </div>

    <script>
        const URL_DB = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY_DB = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 
        let ultimoIdGenerado = null;

        const planElegido = parseInt(sessionStorage.getItem('kb_plan_elegido')) || 0;
        const infoPlanes = [
            { nombre: "Aspirante", precio: "$999" },
            { nombre: "Dominio", precio: "$1,599" },
            { nombre: "Corporativo", precio: "Consultor√≠a" }
        ];

        document.getElementById('plan-display-badge').innerText = `PLAN: ${infoPlanes[planElegido].nombre}`;
        document.getElementById('precio-display').innerHTML = `${infoPlanes[planElegido].precio} <span class="text-xs text-slate-500 italic font-normal uppercase tracking-normal">MXN/mes</span>`;

        const CATALOGO = {
            "Ginecolog√≠a": [{ id: 1, color: "#f43f5e", icon: "üå∏", tag: "Floral", desc: "Rose Quartz" }, { id: 2, color: "#8b5cf6", icon: "üîÆ", tag: "Boutique", desc: "Lavender Silk" }, { id: 3, color: "#fb7185", icon: "üå∑", tag: "Maternal", desc: "Pink Velvet" }, { id: 4, color: "#059669", icon: "üçÉ", tag: "Org√°nico", desc: "Nature Essence" }, { id: 5, color: "#1e293b", icon: "üíé", tag: "√âlite", desc: "Premium Care" }],
            "Odontolog√≠a": [{ id: 1, color: "#0ea5e9", icon: "üíé", tag: "Cl√≠nico", desc: "Arctic Bright" }, { id: 2, color: "#10b981", icon: "üåø", tag: "Org√°nico", desc: "Emerald Fresh" }, { id: 3, color: "#22d3ee", icon: "‚ùÑÔ∏è", tag: "Est√©tico", desc: "Ice Smile" }, { id: 4, color: "#1e3a8a", icon: "üõ°Ô∏è", tag: "Cirug√≠a", desc: "Titanium Pro" }, { id: 5, color: "#6366f1", icon: "‚ö°", tag: "Tech", desc: "Digital Dentist" }],
            "Pediatr√≠a": [{ id: 1, color: "#fb923c", icon: "üß∏", tag: "Infantil", desc: "Sunny Kids" }, { id: 2, color: "#38bdf8", icon: "üöÄ", tag: "L√∫dico", desc: "Sky Dreams" }, { id: 3, color: "#4ade80", icon: "ü¶ñ", tag: "Aventura", desc: "Dino Jungle" }, { id: 4, color: "#f472b6", icon: "üç≠", tag: "Tierno", desc: "Candy Health" }, { id: 5, color: "#818cf8", icon: "üåô", tag: "Paz", desc: "Starry Night" }],
            "Cardiolog√≠a": [{ id: 1, color: "#e11d48", icon: "‚ù§Ô∏è", tag: "Precisi√≥n", desc: "Vital Pulse" }, { id: 2, color: "#1e293b", icon: "‚ö°", tag: "Digital", desc: "Tech Heart" }, { id: 3, color: "#0284c7", icon: "üåä", tag: "Vascular", desc: "Flow System" }, { id: 4, color: "#9f1239", icon: "ü©∏", tag: "Hema", desc: "Deep Crimson" }, { id: 5, color: "#4f46e5", icon: "üõ∞Ô∏è", tag: "Remoto", desc: "Cyber Cardio" }],
            "Bienestar (Nutri/Psico)": [{ id: 1, color: "#059669", icon: "üßò‚Äç‚ôÇÔ∏è", tag: "Zen", desc: "Zen Leaf" }, { id: 2, color: "#a855f7", icon: "üß†", tag: "Mental", desc: "Mind Flow" }, { id: 3, color: "#fbbf24", icon: "üçé", tag: "Nutri", desc: "Vital Food" }, { id: 4, color: "#0ea5e9", icon: "üåä", tag: "Terapia", desc: "Deep Therapy" }, { id: 5, color: "#10b981", icon: "ü•ë", tag: "Fit", desc: "Clean Eating" }],
            "General": [{ id: 1, color: "#1e3a8a", icon: "‚öñÔ∏è", tag: "S√≥lido", desc: "Deep Ocean" }, { id: 2, color: "#6366f1", icon: "üè•", tag: "Moderno", desc: "Tech Navy" }, { id: 3, color: "#10b981", icon: "ü©∫", tag: "B√°sico", desc: "Clinic Green" }, { id: 4, color: "#be123c", icon: "üöë", tag: "Urgencia", desc: "Urgency Red" }, { id: 5, color: "#4338ca", icon: "üè¢", tag: "Corp", desc: "City Medical" }]
        };

        let currentSelection = { template_id: 1, color: "#6366f1" };

        function cambiarCatalogo() {
            const esp = document.getElementById('especialidad').value;
            const contenedor = document.getElementById('contenedor-colores');
            let temas = CATALOGO[esp] || CATALOGO["General"];

            if (planElegido === 0) { temas = temas.slice(0, 2); }

            contenedor.innerHTML = "";
            temas.forEach((t) => {
                const dot = document.createElement('div');
                dot.className = `color-dot`;
                dot.style.backgroundColor = t.color;
                dot.onclick = () => {
                    document.querySelectorAll('.color-dot').forEach(d => { d.classList.remove('active'); d.style.borderColor = "transparent"; });
                    dot.classList.add('active');
                    dot.style.borderColor = "white";
                    currentSelection = { template_id: t.id, color: t.color };
                    document.getElementById('prev-button').style.backgroundColor = t.color;
                    document.getElementById('prev-icon').innerText = t.icon;
                    document.getElementById('prev-bg-icon').innerText = t.icon;
                    document.getElementById('theme-tag').innerText = t.tag;
                    document.getElementById('prev-desc').innerText = t.desc;
                    document.getElementById('text-logo').style.color = t.color;
                };
                contenedor.appendChild(dot);
            });
            contenedor.firstChild.click();
        }

        // FUNCI√ìN DE CARGA BLINDADA (STORAGE)
        async function subirFoto(inputElement, folder) {
            const file = inputElement.files[0];
            if (!file) return null;
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.floor(Math.random() * 1000)}.${fileExt}`;
            const filePath = `${folder}/${fileName}`;

            const res = await fetch(`${URL_DB}/storage/v1/object/medicos_assets/${filePath}`, {
                method: 'POST',
                headers: { 'apikey': KEY_DB, 'Authorization': `Bearer ${KEY_DB}`, 'Content-Type': file.type },
                body: file
            });
            if (!res.ok) throw new Error("Error subiendo imagen");
            return `${URL_DB}/storage/v1/object/public/medicos_assets/${filePath}`;
        }

        document.getElementById('form-registro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-activar');
            btn.innerText = "GEMINI ‚ú¶: SUBIENDO ARCHIVOS...";
            btn.disabled = true;

            try {
                // 1. Subir archivos primero
                const urlPerfil = await subirFoto(document.getElementById('foto_perfil'), 'perfiles');
                const urlCedula = await subirFoto(document.getElementById('foto_cedula'), 'cedulas');

                // 2. Enviar JSON con URLs de texto
                const payload = {
                    nombre_doctor: document.getElementById('nombre').value.trim(),
                    email: `${document.getElementById('nombre').value.toLowerCase().replace(/\s+/g, '.')}.${Math.floor(Math.random() * 1000)}@kbtech.com`,
                    especialidad: document.getElementById('especialidad').value,
                    plan: infoPlanes[planElegido].nombre,
                    template_id: parseInt(currentSelection.template_id),
                    foto_perfil_url: urlPerfil,
                    foto_cedula_url: urlCedula,
                    creado_en: new Date().toISOString()
                };

                const res = await fetch(`${URL_DB}/rest/v1/Perfiles_Medicos`, {
                    method: 'POST',
                    headers: { 
                        'apikey': KEY_DB, 
                        'Authorization': `Bearer ${KEY_DB}`, 
                        'Content-Type': 'application/json', 
                        'Prefer': 'return=representation' 
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok && data.length > 0) {
                    ultimoIdGenerado = data[0].id;
                    const shortName = payload.nombre_doctor.split(' ')[0].toUpperCase();
                    document.getElementById('pago-concepto').innerText = `KB-TJ-${shortName}-${ultimoIdGenerado.substring(0,4)}`;
                    document.getElementById('modal-pago').classList.remove('hidden');
                } else {
                    throw new Error("Fallo en base de datos");
                }
            } catch (error) {
                alert("Error de enlace. Verifique conexi√≥n y tama√±o de fotos.");
                btn.disabled = false;
                btn.innerText = "Reintentar";
            }
        });

        function irANodo() {
            if(ultimoIdGenerado) {
                const btn = event.target;
                btn.innerText = "GEMINI ‚ú¶: INICIANDO COCCI√ìN...";
                setTimeout(() => {
                    window.location.href = (planElegido === 0) 
                        ? `appsolo.html?id=${ultimoIdGenerado}` 
                        : `configurar-perfil.html?id=${ultimoIdGenerado}`;
                }, 1500);
            }
        }

        cambiarCatalogo();
    </script>
</body>
</html>
