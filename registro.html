<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B TECH | Registro de Élite</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 p-6 md:p-20 flex items-center justify-center min-h-screen">
    <div class="max-w-md w-full bg-white p-10 rounded-[2.5rem] shadow-2xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-black italic tracking-tighter">K.B <span class="text-indigo-600">TECH</span></h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sincronización Nodo 2.0</p>
        </header>

        <form id="form-registro" class="space-y-4 text-left">
            <div class="space-y-1">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-2">Nombre del Especialista</label>
                <input type="text" id="nombre" placeholder="Ej: Dr. Toby" class="w-full p-4 rounded-xl border border-slate-200 text-sm font-medium" required>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-2">Email de Acceso</label>
                <input type="email" id="email" placeholder="doctor@ejemplo.com" class="w-full p-4 rounded-xl border border-slate-200 text-sm font-medium" required>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-2">Especialidad</label>
                <input type="text" id="especialidad" placeholder="Ej: Cardiología" class="w-full p-4 rounded-xl border border-slate-200 text-sm font-medium" required>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-2">Plan de Red</label>
                <select id="plan" class="w-full p-4 rounded-xl border border-slate-200 text-sm font-bold bg-white text-indigo-600">
                    <option value="Semilla" data-id="1">Plan Profesional (Indigo)</option>
                    <option value="Dominio" data-id="2">Plan Dominio (Esmeralda)</option>
                </select>
            </div>
            <button type="submit" id="btn" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black uppercase text-[10px] tracking-[0.2em] shadow-xl hover:bg-slate-900 transition-all">
                Activar Nodo Médico
            </button>
        </form>
        <div id="resultado" class="hidden mt-6 p-4 bg-slate-100 rounded-2xl break-all text-[9px] font-mono text-slate-500 border border-slate-200"></div>
    </div>

    <script>
        // TUS NUEVAS CREDENCIALES (IMAGEN #7 CORREGIDA)
        const URL = "https://dgatsbnqgplalxwewpvs.supabase.co"; 
        const KEY = "sb_publishable_qXj4L3x_s2sP3-FFQpIOhA_GXP0qX8i"; 

        document.getElementById('form-registro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn');
            btn.innerText = "SINCRO EN CURSO..."; 
            btn.disabled = true;

            const sel = document.getElementById('plan');
            const datos = {
                nombre_doctor: document.getElementById('nombre').value,
                email: document.getElementById('email').value,
                especialidad: document.getElementById('especialidad').value,
                plan: sel.value,
                template_id: parseInt(sel.options[sel.selectedIndex].getAttribute('data-id'))
            };

            try {
                const res = await fetch(`${URL}/rest/v1/Perfiles_Medicos`, {
                    method: 'POST',
                    headers: { 
                        'apikey': KEY, 
                        'Authorization': `Bearer ${KEY}`, 
                        'Content-Type': 'application/json', 
                        'Prefer': 'return=representation' 
                    },
                    body: JSON.stringify(datos)
                });

                if(res.ok) {
                    const data = await res.json();
                    const id = data[0].id;
                    const base = window.location.href.split('registro.html')[0];
                    const link = base + 'agendar.html?id=' + id;
                    
                    document.getElementById('resultado').classList.remove('hidden');
                    document.getElementById('resultado').innerHTML = `<strong>LINK PARA PACIENTES:</strong><br>${link}`;
                    alert("¡NODO MÉDICO ACTIVADO!");
                } else {
                    const errorData = await res.json();
                    console.error("Error de Supabase:", errorData);
                    alert("Error: Revisa que el email no esté repetido en la base.");
                }
            } catch (err) {
                console.error("Error de conexión:", err);
                alert("Fallo de conexión. Revisa el SQL de Supabase.");
            }
            btn.innerText = "Activar Nodo Médico"; 
            btn.disabled = false;
        });
    </script>
</body>
</html>
