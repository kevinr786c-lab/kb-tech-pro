<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | PANEL ASISTENTE ELITE ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        :root { --luxe-gold: #c5a059; --luxe-dark: #0f172a; --luxe-bg: #f8f9fa; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--luxe-bg); color: #1e293b; overflow: hidden; height: 100vh; display: flex; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(197, 160, 89, 0.2); border-radius: 2.5rem; transition: all 0.5s ease; }
        #sidebar { width: 280px; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); margin-right: -280px; position: fixed; right: 0; height: 100vh; z-index: 100; background: white; border-left: 1px solid rgba(197,160,89,0.2); }
        #sidebar.open { margin-right: 0; }
        .fc-button { background: var(--luxe-dark) !important; border: none !important; border-radius: 0.8rem !important; font-weight: 800; text-transform: uppercase; font-size: 8px !important; padding: 8px 10px !important; transition: 0.3s !important; color: white !important; }
        .fc-button:hover { background: var(--luxe-gold) !important; transform: translateY(-1px); }
        .fc-button-active { background: var(--luxe-gold) !important; box-shadow: 0 4px 10px rgba(197, 160, 89, 0.3) !important; }
        .fc-toolbar-title { font-weight: 900 !important; text-transform: uppercase; font-style: italic; color: var(--luxe-dark); font-size: 1rem !important; }
        .fc-event { border: none !important; border-radius: 8px !important; padding: 2px 5px !important; transition: all 0.3s ease; cursor: pointer; font-weight: 700; }
        .input-luxe { width: 100%; padding: 0.75rem; border-radius: 1rem; border: 1px solid #e2e8f0; outline: none; transition: 0.3s; font-size: 0.8rem; font-weight: 600; }
        .modal-blur { backdrop-filter: blur(15px); background: rgba(15, 23, 42, 0.4); }
        .kb-star { color: var(--luxe-gold); animation: star-glow 3s infinite ease-in-out; }
        @keyframes star-glow { 0% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(1); } }
        .event-pagado { border-left: 5px solid #22c55e !important; }
        .event-deuda { border-left: 5px solid #ef4444 !important; }
    </style>
</head>
<body class="p-4 gap-4">
    <div class="flex-1 flex flex-col gap-4 overflow-hidden">
        <header class="glass p-6 flex justify-between items-center shadow-xl">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-[#0f172a] rounded-2xl flex items-center justify-center shadow-xl"><span class="kb-star text-2xl">‚ú¶</span></div>
                <div>
                    <h1 class="text-xl font-black italic uppercase tracking-tighter text-[#0f172a]">K.B <span class="text-[#c5a059]">SYSTEM</span></h1>
                    <select id="doctorSelect" class="text-[10px] font-black uppercase text-slate-400 bg-transparent border-none p-0 outline-none cursor-pointer hover:text-[#c5a059] transition">
                        <option value="">ESCANEANDO DOCTORES...</option>
                    </select>
                </div>
            </div>
            <div class="flex-1 max-w-md mx-4">
                <input type="text" id="buscadorLocal" oninput="filtrarRadar()" placeholder="ESCANEANDO PACIENTE..." class="input-luxe text-center uppercase tracking-widest border-none bg-slate-100 focus:bg-white focus:ring-2 focus:ring-[#c5a059]">
            </div>
            <div class="flex items-center gap-3">
                <button onclick="copiarLinkAgenda()" class="text-[9px] font-black uppercase px-4 py-2 bg-[#c5a059] text-white rounded-xl shadow-lg hover:scale-105 transition flex items-center gap-1">üîó Copiar Link</button>
                <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center bg-[#0f172a] text-white rounded-xl shadow-xl hover:bg-[#c5a059] transition">‚ò∞</button>
            </div>
        </header>
        <div class="flex-1 glass p-6 overflow-hidden relative shadow-2xl">
            <div id="calendar" class="h-full"></div>
        </div>
    </div>
    <aside id="sidebar" class="p-8 flex flex-col shadow-2xl">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-sm font-black uppercase italic text-[#0f172a]">Comandos <span class="text-[#c5a059]">√âlite</span></h2>
            <button onclick="toggleSidebar()" class="text-slate-400 hover:text-rose-500">‚úï</button>
        </div>
        <div id="paciente-info" class="hidden flex-1 overflow-y-auto pr-2">
            <p class="text-[8px] font-black text-slate-400 uppercase mb-2">Historial Reciente</p>
            <div id="historial-lista" class="space-y-2"></div>
        </div>
        <div id="stats-caja" class="mb-6" style="padding: 15px; background: rgba(197, 160, 89, 0.1); border-radius: 1.5rem; border: 1px dashed var(--luxe-gold);">
            <p style="color: var(--luxe-gold); font-size: 8px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; margin: 0;">üìä Control Semanal</p>
            <h3 id="contador-semanal" style="color: var(--luxe-dark); font-size: 1.2rem; font-weight: 800; margin: 5px 0;">0 Citas</h3>
            <p id="label-inicio" style="color: #22c55e; font-size: 7px; font-weight: 800; text-transform: uppercase; margin: 0;">Inicia: Lun 16 Feb</p>
        </div>
        <div class="pt-4 border-t space-y-2">
            <button onclick="location.reload()" class="w-full text-left p-3 rounded-xl bg-slate-100 text-[10px] font-bold hover:bg-[#c5a059] transition">üîÑ REFRESCAR</button>
            <p class="text-[8px] font-black text-slate-300 text-center uppercase mt-4">K.B TECH 2026</p>
        </div>
    </aside>
    <div id="modalCita" class="fixed inset-0 hidden modal-blur flex items-center justify-center z-[9999] p-4">
        <div class="glass max-w-md w-full p-8 bg-white shadow-2xl border border-[var(--luxe-gold)]">
            <h2 id="modal-titulo" class="text-xl font-black uppercase italic text-[#0f172a] mb-6 border-b pb-2 text-center">Gesti√≥n <span class="text-[#c5a059]">Cita</span></h2>
            <div class="space-y-4">
                <input id="c-paciente" class="input-luxe bg-slate-50" placeholder="NOMBRE DE PACIENTE">
                <input id="c-telefono" class="input-luxe" placeholder="TEL√âFONO (10 D√çGITOS)">
                <div class="grid grid-cols-2 gap-2"><input type="date" id="c-fecha" class="input-luxe"><input type="time" id="c-hora" class="input-luxe"></div>
                <select id="c-estado" class="input-luxe font-bold uppercase text-[10px]">
                    <option value="pendiente">‚è≥ Pendiente</option>
                    <option value="confirmado">‚úì Confirmado</option>
                    <option value="atendiendo">üî• En Consulta</option>
                    <option value="completado">‚ú¶ Completado</option>
                    <option value="cancelado">üö´ Cancelar</option>
                </select>
                <button onclick="lanzarWhatsApp()" class="w-full py-2 bg-emerald-500 text-white rounded-xl font-black text-[10px] uppercase flex items-center justify-center gap-2 shadow-md">üì± Enviar Confirmaci√≥n Inteligente</button>
                <textarea id="c-notas" class="input-luxe h-20" placeholder="NOTAS (Ej: EMB, 1ra vez, Pendiente de pago)..."></textarea>
            </div>
            <div class="flex gap-2 mt-6">
                <button id="btn-accion" onclick="guardarCita()" class="flex-1 py-3 bg-[#0f172a] text-[#c5a059] rounded-xl font-black uppercase text-[9px]">Actualizar</button>
                <button onclick="cerrarModal()" class="px-6 py-3 text-[9px] font-black uppercase text-slate-400">Cerrar</button>
            </div>
        </div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');
    let calendar, citaActual = null, doctorActual = null, todasLasCitas = [];

    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
    
    window.filtrarRadar = () => {
        const query = document.getElementById('buscadorLocal').value.toUpperCase();
        const filtradas = todasLasCitas.filter(c => (c.Pacientes?.nombre || '').toUpperCase().includes(query));
        calendar.removeAllEvents();
        calendar.addEventSource(filtradas.map(c => procesarCitaParaCalendario(c)));
    };

    function procesarCitaParaCalendario(c) {
        const ESTADOS = { pendiente: '#f8fafc', confirmado: '#fff7ed', atendiendo: '#f0fdf4', completado: '#0f172a', cancelado: '#fef2f2' };
        const TXT = { pendiente: '#94a3b8', confirmado: '#c5a059', atendiendo: '#10b981', completado: '#c5a059', cancelado: '#ef4444' };
        const clasePago = c.pagado ? 'event-pagado' : 'event-deuda';
        const iconoPago = c.pagado ? '‚úÖ' : 'üí∞';

        return {
            id: c.id,
            title: `${iconoPago} ${c.Pacientes?.nombre || 'PACIENTE'}`,
            start: `${c.fecha}T${c.hora_inicio}`,
            backgroundColor: ESTADOS[c.estado] || '#f8fafc',
            textColor: TXT[c.estado] || '#1e293b',
            classNames: [clasePago],
            extendedProps: c
        };
    }

    async function actualizarContadorFinanciero() {
        if (!doctorActual) return;
        // L√≥gica din√°mica del Jefe: Detectamos el lunes de esta semana
        const hoy = new Date();
        const diaSemana = hoy.getDay();
        const diferencia = diaSemana === 0 ? -6 : 1 - diaSemana;
        const lunes = new Date(hoy.setDate(hoy.getDate() + diferencia));
        const lunesISO = lunes.toISOString().split('T')[0];

        const { count, error } = await supabase
            .from('Citas')
            .select('*', { count: 'exact', head: true })
            .eq('doctor_id', doctorActual)
            .gte('fecha', lunesISO)
            .not('estado', 'eq', 'cancelado');
            
        if (!error) {
            document.getElementById('contador-semanal').innerText = `${count} Citas`;
            document.getElementById('label-inicio').innerText = `INICIA: LUN ${lunes.toLocaleDateString('es-MX', {day:'2-digit', month:'short'})}`;
        }
    }

    async function cargarCitas() {
        if (!doctorActual) return [];
        const { data, error } = await supabase.from('Citas').select('*, Pacientes(*)').eq('doctor_id', doctorActual);
        if (error) return [];
        todasLasCitas = data || [];
        actualizarContadorFinanciero(); 
        return todasLasCitas.map(c => procesarCitaParaCalendario(c));
    }

    async function verHistorial(pacienteId) {
        if(!pacienteId) return;
        const { data } = await supabase.from('Citas').select('fecha, estado').eq('paciente_id', pacienteId).order('fecha', { ascending: false }).limit(5);
        const lista = document.getElementById('historial-lista');
        lista.innerHTML = (data || []).map(c => `<div class="p-2 bg-slate-50 rounded-lg border mb-2"><div class="flex justify-between text-[8px] font-black"><span>${c.fecha}</span><span class="uppercase text-[#c5a059]">${c.estado}</span></div></div>`).join('');
        document.getElementById('paciente-info').classList.remove('hidden');
        if(!document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
    }

    function initCalendar() {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            locale: 'es',
            initialView: 'timeGridDay',
            allDaySlot: false,
            slotMinTime: "08:00:00",
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'multiMonthYear,dayGridMonth,timeGridWeek,timeGridDay' },
            buttonText: { today: 'Hoy', year: 'A√±o', month: 'Mes', week: 'Semana', day: 'D√≠a' },
            events: (info, success) => cargarCitas().then(success),
            dateClick: (info) => {
                citaActual = { id: null };
                document.getElementById('modal-titulo').innerHTML = 'Agendar <span class="text-[#c5a059]">Nueva</span>';
                document.getElementById('c-paciente').value = "";
                document.getElementById('c-telefono').value = "";
                document.getElementById('c-fecha').value = info.dateStr.split('T')[0];
                document.getElementById('c-hora').value = info.dateStr.split('T')[1]?.slice(0,5) || "09:00";
                document.getElementById('c-notas').value = "";
                document.getElementById('btn-accion').innerText = "AGENDAR AHORA ‚ú¶";
                document.getElementById('modalCita').classList.remove('hidden');
            },
            eventClick: (info) => {
                citaActual = info.event.extendedProps;
                document.getElementById('modal-titulo').innerHTML = 'Gesti√≥n <span class="text-[#c5a059]">Cita</span>';
                document.getElementById('c-paciente').value = citaActual.Pacientes?.nombre || '';
                document.getElementById('c-telefono').value = citaActual.Pacientes?.telefono || '';
                document.getElementById('c-fecha').value = citaActual.fecha;
                document.getElementById('c-hora').value = citaActual.hora_inicio.slice(0,5);
                document.getElementById('c-estado').value = citaActual.estado;
                document.getElementById('c-notas').value = citaActual.notas || '';
                document.getElementById('btn-accion').innerText = "ACTUALIZAR DATOS";
                document.getElementById('modalCita').classList.remove('hidden');
                verHistorial(citaActual.paciente_id);
            }
        });
        calendar.render();
    }

    async function cargarDoctores() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;
        const { data: asig } = await supabase.from('Asistentes_Doctor').select('doctor_id').eq('asistente_id', session.user.id);
        const { data: docs } = await supabase.from('Usuarios').select('id, nombre').in('id', asig?.map(a => a.doctor_id) || []);
        const select = document.getElementById('doctorSelect');
        select.innerHTML = '<option value="">ELEGIR DOCTOR</option>' + (docs?.map(d => `<option value="${d.id}">DR. ${d.nombre.toUpperCase()}</option>`).join('') || '');
        select.onchange = () => { doctorActual = select.value; if (!calendar) initCalendar(); else calendar.refetchEvents(); };
    }

    window.guardarCita = async () => {
        const nombre = document.getElementById('c-paciente').value;
        const tel = document.getElementById('c-telefono').value.replace(/\D/g, ''); // Blindaje de seguridad
        const p = { fecha: document.getElementById('c-fecha').value, hora_inicio: document.getElementById('c-hora').value, estado: document.getElementById('c-estado').value, notas: document.getElementById('c-notas').value };
        if(!nombre || !tel) return alert("NOMBRE Y TEL√âFONO OBLIGATORIOS");
        try {
            let pacienteId;
            const { data: pExistente } = await supabase.from('Pacientes').select('id').eq('telefono', tel).maybeSingle();
            if(pExistente) { pacienteId = pExistente.id; } 
            else { const { data: nuevoP } = await supabase.from('Pacientes').insert([{ nombre, telefono: tel }]).select().single(); pacienteId = nuevoP.id; }
            if (citaActual && citaActual.id) { await supabase.from('Citas').update(p).eq('id', citaActual.id); } 
            else {
                const { data: s } = await supabase.from('Servicios').select('id').limit(1).single();
                await supabase.from('Citas').insert([{ ...p, doctor_id: doctorActual, paciente_id: pacienteId, servicio_id: s.id, duracion_cita: 30 }]);
            }
            calendar.refetchEvents(); cerrarModal();
        } catch (e) { alert("Error: " + e.message); }
    };

    window.lanzarWhatsApp = () => {
        const tel = document.getElementById('c-telefono').value.replace(/\D/g, '');
        const nombre = document.getElementById('c-paciente').value;
        const fecha = document.getElementById('c-fecha').value;
        const hora = document.getElementById('c-hora').value;
        const estado = document.getElementById('c-estado').value;
        const notas = (document.getElementById('c-notas').value || "").toLowerCase();
        if(!tel) return alert("Sin n√∫mero");

        let accion = (estado === 'confirmado') ? "confirmamos tu espacio" : "te recordamos tu cita";
        let especial = "";
        if(notas.includes("emb")) especial = " para tu control prenatal ü§∞";
        else if(notas.includes("1ra vez")) especial = " de primera vez ‚ú®";

        const urlBase = window.location.href.split('?')[0].replace(/[^\/]*$/, '');
        const linkAgenda = `${urlBase}agendar.html?docId=${doctorActual}`;

        const msg = encodeURIComponent(`Hola *${nombre}*, ${accion}${especial} el d√≠a *${fecha}* a las *${hora}* hrs. ‚ú¶\n\n¬øNos confirmas tu asistencia?\n\nSi necesitas reagendar, entra aqu√≠: ${linkAgenda}`);
        window.open(`https://wa.me/52${tel}?text=${msg}`, '_blank');
    };

    window.copiarLinkAgenda = () => {
        if (!doctorActual) return alert("ELIJA DOCTOR PRIMERO");
        const urlBase = window.location.href.split('?')[0].replace(/[^\/]*$/, '');
        const link = `${urlBase}agendar.html?docId=${doctorActual}`;
        navigator.clipboard.writeText(link).then(() => alert("LINK COPIADO ‚ú¶"));
    };

    window.cerrarModal = () => document.getElementById('modalCita').classList.add('hidden');
    cargarDoctores();
</script>
</body>
</html>
