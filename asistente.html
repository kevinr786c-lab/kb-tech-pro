<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | RADAR PRO âœ¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.08); border-radius: 2rem; }
        .input-kb { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; padding: 0.75rem; color: white; width: 100%; margin-bottom: 0.5rem; outline: none; }
        .fc-event { border: none !important; padding: 5px; border-radius: 10px !important; font-weight: 700; cursor: pointer; transition: 0.3s; }
        #toast { transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); transform: translateY(100px); opacity: 0; }
        #toast.show { transform: translateY(0); opacity: 1; }
        .modal-blur { backdrop-filter: blur(15px); background: rgba(2, 6, 23, 0.85); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 10px; }
        /* Ajuste para que el calendario se vea bien en fondo oscuro */
        .fc { --fc-border-color: rgba(255,255,255,0.05); --fc-page-bg-color: transparent; }
        .fc-timegrid-slot { height: 3em !important; }
    </style>
</head>
<body class="p-4 h-screen">

    <div id="toast" class="fixed bottom-10 right-10 z-[9999] glass px-8 py-4 border-l-4 border-indigo-500 flex items-center gap-4">
        <p id="toast-msg" class="text-[10px] font-black uppercase tracking-widest"></p>
    </div>

    <div id="modalCita" class="fixed inset-0 z-[1000] hidden modal-blur flex items-center justify-center p-4">
        <div class="glass max-w-2xl w-full p-8 shadow-2xl border-indigo-500/20 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 id="m-paciente" class="text-2xl font-black italic uppercase tracking-tighter text-indigo-400">---</h2>
                    <p id="m-servicio" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">---</p>
                </div>
                <button onclick="cerrarModal()" class="text-slate-500 hover:text-white transition">âœ•</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="space-y-4">
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5 flex justify-between items-center">
                        <div id="m-status-pill" class="text-[10px] font-black uppercase px-3 py-1 rounded-full">---</div>
                        <a id="m-whatsapp" href="#" target="_blank" class="text-emerald-400 text-xl hover:scale-110 transition">ðŸ“±</a>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="cambiarEstado('confirmado')" class="bg-sky-500/10 hover:bg-sky-500 text-sky-400 hover:text-white p-3 rounded-xl text-[9px] font-black uppercase transition border border-sky-500/20">Confirmar</button>
                        <button onclick="cambiarEstado('atendiendo')" class="bg-indigo-500/10 hover:bg-indigo-500 text-indigo-400 hover:text-white p-3 rounded-xl text-[9px] font-black uppercase transition border border-indigo-500/20">Atender</button>
                        <button onclick="cambiarEstado('completado')" class="bg-emerald-500/10 hover:bg-emerald-500 text-emerald-400 hover:text-white p-3 rounded-xl text-[9px] font-black uppercase transition border border-emerald-500/20">Cobrar</button>
                        <button onclick="cambiarEstado('no_asistio')" class="bg-amber-500/10 hover:bg-amber-500 text-amber-400 hover:text-white p-3 rounded-xl text-[9px] font-black uppercase transition border border-amber-500/20">FaltÃ³</button>
                    </div>
                    <button onclick="cambiarEstado('cancelado')" class="w-full bg-rose-500/10 hover:bg-rose-500 text-rose-500 hover:text-white p-3 rounded-xl text-[9px] font-black uppercase transition border border-rose-500/20 italic">Cancelar Cita</button>
                </div>

                <div class="flex flex-col">
                    <p class="text-[9px] font-black uppercase text-indigo-400 tracking-widest mb-2">Notas del Doctor</p>
                    <textarea id="m-notas" class="w-full h-32 bg-black/30 border border-white/10 rounded-xl p-3 text-[10px] outline-none focus:border-indigo-500 transition" placeholder="Observaciones rÃ¡pidas..."></textarea>
                </div>
            </div>

            <div class="mt-6 border-t border-white/5 pt-6">
                <p class="text-[9px] font-black uppercase text-indigo-400 tracking-widest mb-4">Historial Reciente (Ãšltimas 5)</p>
                <ul id="m-historial" class="space-y-2 text-[9px] text-slate-400 italic"></ul>
            </div>
        </div>
    </div>

    <div id="app" class="h-full flex flex-col">
        <header class="flex justify-between items-center mb-6 px-4">
            <h1 class="text-3xl font-black italic uppercase tracking-tighter">Torre de <span class="text-indigo-400">Control</span> âœ¦</h1>
            <div class="text-right">
                <p id="nombreDoc" class="text-[10px] font-black text-indigo-400 uppercase tracking-widest italic"></p>
                <p class="text-[8px] text-slate-500 font-bold uppercase tracking-[0.3em]">SincronizaciÃ³n Nodo K.B Activa</p>
            </div>
        </header>

        <div class="grid grid-cols-12 gap-6 flex-1 overflow-hidden">
            <aside class="col-span-12 lg:col-span-3 glass p-6 overflow-y-auto">
                <h3 class="text-[10px] font-black uppercase mb-6 text-indigo-400 tracking-widest italic">Inyectar MisiÃ³n</h3>
                <div class="space-y-2">
                    <input id="tel" class="input-kb" placeholder="TELÃ‰FONO" maxlength="10">
                    <input id="nom" class="input-kb" placeholder="PACIENTE">
                    <select id="servicio" class="input-kb cursor-pointer">
                        <option value="" disabled selected>Seleccione Servicio</option>
                    </select>
                    <input type="time" id="hora" class="input-kb">
                    <button id="btnAgendar" class="w-full bg-indigo-600 hover:bg-indigo-500 transition-all p-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg shadow-indigo-500/20">Agendar en Radar</button>
                </div>
            </aside>

            <section class="col-span-12 lg:col-span-9 glass p-4 overflow-hidden relative">
                <div id="calendar" class="h-full"></div>
            </section>
        </div>
    </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

// USAMOS EL ID FIJO QUE HEMOS ESTADO USANDO PARA EL DOCTOR
const doctorId = '196c57b5-68d5-4825-8607-36b5d3bc3e15';
let calendar, citaSeleccionada = null;

const ESTADOS = {
    pendiente: { color: '#64748b', txt: 'Pendiente' },
    confirmado: { color: '#0ea5e9', txt: 'Confirmado âœ…' },
    atendiendo: { color: '#6366f1', txt: 'En Consulta ðŸ©º' },
    completado: { color: '#10b981', txt: 'Completado ðŸ’°' },
    cancelado: { color: '#ef4444', txt: 'Cancelado âœ•' },
    no_asistio: { color: '#f59e0b', txt: 'No AsistiÃ³ âš ï¸' }
};

function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toast-msg').innerText = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// CARGAR EVENTOS
async function cargarEventos(info, success) {
    const { data, error } = await supabase
        .from('Citas')
        .select(`*, Pacientes(*), Servicios(*)`)
        .eq('doctor_id', doctorId)
        .neq('estado', 'cancelado');
    
    if (error) { console.error(error); return; }

    success(data.map(c => ({
        id: c.id, 
        title: `${c.Pacientes.nombre} | ${c.Servicios.nombre}`,
        start: `${c.fecha}T${c.hora_inicio}`,
        // CÃ¡lculo de fin basado en la duraciÃ³n guardada
        end: new Date(new Date(`${c.fecha}T${c.hora_inicio}`).getTime() + (c.duracion_cita) * 60000),
        backgroundColor: ESTADOS[c.estado]?.color || '#ccc',
        extendedProps: c
    })));
}

// MODAL Y EXPEDIENTE
window.abrirModal = async (cita) => {
    citaSeleccionada = cita;
    document.getElementById('m-paciente').innerText = cita.Pacientes.nombre;
    document.getElementById('m-servicio').innerText = cita.Servicios.nombre;
    
    const st = ESTADOS[cita.estado] || ESTADOS.pendiente;
    const pill = document.getElementById('m-status-pill');
    pill.innerText = st.txt; 
    pill.style.backgroundColor = st.color + '20'; 
    pill.style.color = st.color;
    
    document.getElementById('m-whatsapp').href = `https://wa.me/52${cita.Pacientes.telefono}`;
    document.getElementById('m-notas').value = cita.notas || '';

    const { data: hist } = await supabase.from('Citas')
        .select('fecha, estado')
        .eq('paciente_id', cita.paciente_id)
        .order('fecha', { ascending: false })
        .limit(5);

    document.getElementById('m-historial').innerHTML = hist.map(h => `<li>ðŸ“… ${h.fecha} â€” ${ESTADOS[h.estado]?.txt || h.estado}</li>`).join('');
    document.getElementById('modalCita').classList.remove('hidden');
};

window.cerrarModal = () => { document.getElementById('modalCita').classList.add('hidden'); };

window.cambiarEstado = async (nuevoEstado) => {
    let payload = { estado: nuevoEstado };
    if (nuevoEstado === 'completado') {
        const monto = prompt('ðŸ’° Confirmar Monto Cobrado:', citaSeleccionada.monto || 0);
        if (monto === null) return;
        payload.monto = Number(monto); payload.pagado = true;
    }
    
    const { error } = await supabase.from('Citas').update(payload).eq('id', citaSeleccionada.id);
    if (!error) {
        showToast(`SISTEMA: CITA ${nuevoEstado.toUpperCase()}`);
        cerrarModal(); 
        calendar.refetchEvents();
    }
};

document.getElementById('btnAgendar').onclick = async () => {
    const tel = document.getElementById('tel').value;
    const nom = document.getElementById('nom').value;
    const hor = document.getElementById('hora').value;
    const servSel = document.getElementById('servicio').selectedOptions[0];

    if(!tel || !nom || !hor || !servSel.value) return showToast('âš ï¸ DATOS INCOMPLETOS');

    try {
        let { data: pac } = await supabase.from('Pacientes').select('id').eq('telefono', tel).maybeSingle();
        if(!pac) {
            const { data: newPac } = await supabase.from('Pacientes').insert({ nombre: nom.toUpperCase(), telefono: tel }).select().single();
            pac = newPac;
        }

        const { error } = await supabase.from('Citas').insert({
            doctor_id: doctorId,
            paciente_id: pac.id,
            servicio_id: document.getElementById('servicio').value,
            fecha: new Date().toISOString().slice(0,10), // Agenda para hoy por defecto en admin
            hora_inicio: hor, 
            duracion_cita: parseInt(servSel.dataset.d), 
            monto: Number(servSel.dataset.p),
            estado: 'pendiente'
        });

        if(error) throw error;
        showToast('âœ… MISIÃ“N REGISTRADA EN RADAR');
        calendar.refetchEvents();
    } catch(e) { showToast(`âŒ ERROR: ${e.message}`); }
};

// INICIALIZACIÃ“N
(async () => {
    // Cargar nombre del doctor
    const { data: docData } = await supabase.from('Perfiles_Medicos').select('*, Usuarios(nombre)').eq('id', doctorId).single();
    if(docData) document.getElementById('nombreDoc').innerText = `MODO OPERATIVO: DR. ${docData.Usuarios.nombre}`;

    // Cargar servicios
    const { data: srv } = await supabase.from('Servicios').select('*').eq('doctor_id', doctorId).eq('activo', true);
    document.getElementById('servicio').innerHTML += srv.map(s => `<option value="${s.id}" data-d="${s.duracion_total}" data-p="${s.precio}">${s.nombre.toUpperCase()}</option>`).join('');
    
    // Configurar Calendario
    calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        locale: 'es',
        initialView: 'timeGridDay',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridDay,timeGridWeek' },
        slotMinTime: '07:00',
        slotMaxTime: '22:00',
        allDaySlot: false,
        nowIndicator: true,
        events: cargarEventos,
        eventClick: (info) => abrirModal(info.event.extendedProps)
    });
    calendar.render();
})();
</script>
</body>
</html>
