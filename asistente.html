<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | PANEL ASISTENTE âœ¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        :root { --gold: #c5a059; --dark: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; height: 100vh; }
        .glass { background: white; border-radius: 2rem; border: 1px solid rgba(197, 160, 89,.25); }

        /* ===== ðŸŽ¨ ADN VISUAL DE EVENTOS ===== */
        .fc-event { border: none !important; border-radius: 10px !important; padding: 4px 6px !important; font-size: 11px; font-weight: 700; cursor: pointer; transition: .25s; }
        .fc-event:hover { transform: scale(1.02); }

        /* Tipo visita (Fondos) */
        .event-primera { background: #e0f2fe !important; color: #0369a1 !important; border-left: 5px solid #0284c7 !important; }
        .event-recurrente { background: #ecfdf5 !important; color: #065f46 !important; border-left: 5px solid #10b981 !important; }

        /* Estado (Bordes) */
        .estado-confirmado { border-left: 5px solid var(--gold) !important; }
        .estado-atendiendo { border-left: 5px solid #22c55e !important; animation: pulse 2s infinite; }
        .estado-completado { background: var(--dark) !important; color: var(--gold) !important; }
        .estado-cancelado { opacity: .4; filter: grayscale(1); }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, .4); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body class="p-4">
<div class="glass h-full p-6 flex flex-col">
    <header class="flex justify-between items-center mb-4">
        <div>
            <h1 class="font-black italic text-xl">K.B <span class="text-[var(--gold)]">SYSTEM</span></h1>
            <select id="doctorSelect" class="text-xs font-bold uppercase text-slate-500 bg-transparent outline-none"></select>
        </div>
        <div class="flex gap-2">
            <button onclick="window.location.href='agendar.html?docId='+doctorActual" class="px-4 py-2 bg-[var(--gold)] text-white text-[10px] font-black rounded-xl">âœš Agendar</button>
            <button onclick="location.reload()" class="px-4 py-2 bg-[var(--dark)] text-white rounded-xl">ðŸ”„</button>
        </div>
    </header>
    <div id="calendar" class="flex-1"></div>
</div>

<div id="modalCita" class="fixed inset-0 hidden bg-black/40 backdrop-blur flex items-center justify-center z-50">
    <div class="glass bg-white p-6 w-full max-w-md shadow-2xl">
        <h2 class="font-black uppercase mb-4 border-b pb-2">Editar Cita <span id="badge-tipo" class="text-[9px] lowercase px-2"></span></h2>
        <div class="space-y-3">
            <input id="c-paciente" class="w-full p-2 rounded bg-slate-100 text-sm font-bold" readonly>
            <input id="c-telefono" class="w-full p-2 rounded bg-slate-50 text-xs italic" readonly placeholder="TelÃ©fono">
            
            <div class="grid grid-cols-2 gap-2">
                <input type="date" id="c-fecha" class="w-full p-2 rounded border text-xs">
                <input type="time" id="c-hora" class="w-full p-2 rounded border text-xs">
            </div>

            <select id="c-estado" class="w-full p-2 rounded font-bold text-xs uppercase border">
                <option value="pendiente">Pendiente</option>
                <option value="confirmado">Confirmado</option>
                <option value="atendiendo">En consulta</option>
                <option value="completado">Completado</option>
                <option value="cancelado">Cancelado</option>
            </select>
            <textarea id="c-notas" class="w-full p-2 rounded text-sm h-20 border" placeholder="Notas..."></textarea>
            
            <button onclick="lanzarWhatsApp()" class="w-full py-3 bg-emerald-500 text-white rounded-xl font-black text-[10px] uppercase flex items-center justify-center gap-2 hover:bg-emerald-600 transition">
                <span>WhatsApp Semi-Auto</span>
            </button>
        </div>
        <div class="flex gap-2 mt-6">
            <button onclick="guardarCita()" class="flex-1 bg-[var(--dark)] text-[var(--gold)] py-3 rounded-xl font-black text-xs uppercase">Guardar Cambios</button>
            <button onclick="cerrarModal()" class="text-xs uppercase text-slate-400 px-2">Cerrar</button>
        </div>
    </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

let calendar, doctorActual=null, citaActual=null;

async function cargarDoctores(){
    const {data:{session}} = await supabase.auth.getSession();
    const {data:asig} = await supabase.from('Asistentes_Doctor').select('doctor_id').eq('asistente_id', session?.user.id);
    const {data:docs} = await supabase.from('Usuarios').select('id,nombre').in('id', asig?.map(a=>a.doctor_id) || []);
    
    const sel = document.getElementById('doctorSelect');
    sel.innerHTML='<option value="">Elegir doctor</option>' + docs.map(d=>`<option value="${d.id}">DR. ${d.nombre}</option>`).join('');
    sel.onchange=()=>{ doctorActual=sel.value; if(!calendar) initCalendar(); else calendar.refetchEvents(); };
}

async function cargarCitas(info, success){
    if(!doctorActual) return success([]);
    const {data} = await supabase.from('Citas').select('*,Pacientes(*)').eq('doctor_id',doctorActual);
    success(data.map(c=>{
        const clases=[];
        clases.push(c.Pacientes?.primera_visita ? 'event-primera':'event-recurrente');
        clases.push(`estado-${c.estado}`);
        return { id:c.id, title:c.Pacientes?.nombre||'Paciente', start:`${c.fecha}T${c.hora_inicio}`, classNames:clases, extendedProps:c };
    }));
}

function initCalendar(){
    calendar=new FullCalendar.Calendar(document.getElementById('calendar'),{
        locale:'es', initialView:'timeGridDay', allDaySlot:false,
        slotMinTime:'08:00', slotMaxTime:'20:00',
        events:cargarCitas,
        eventClick:(info)=>{
            citaActual=info.event.extendedProps;
            document.getElementById('c-paciente').value=info.event.title;
            document.getElementById('c-telefono').value=citaActual.Pacientes?.telefono || '';
            document.getElementById('c-fecha').value=citaActual.fecha;
            document.getElementById('c-hora').value=citaActual.hora_inicio.slice(0,5);
            document.getElementById('c-estado').value=citaActual.estado;
            document.getElementById('c-notas').value=citaActual.notas||'';
            document.getElementById('badge-tipo').innerText = citaActual.Pacientes?.primera_visita ? 'âœ¦ primera vez' : 'âœ“ recurrente';
            document.getElementById('modalCita').classList.remove('hidden');
        }
    });
    calendar.render();
}

window.guardarCita=async()=>{
    await supabase.from('Citas').update({
        fecha: document.getElementById('c-fecha').value,
        hora_inicio: document.getElementById('c-hora').value,
        estado: document.getElementById('c-estado').value,
        notas: document.getElementById('c-notas').value
    }).eq('id',citaActual.id);
    calendar.refetchEvents();
    cerrarModal();
};

window.lanzarWhatsApp=()=>{
    const tel = document.getElementById('c-telefono').value;
    if(!tel) return alert("Sin nÃºmero");
    const msg = encodeURIComponent(`Hola *${document.getElementById('c-paciente').value}*, te confirmamos tu cita el dÃ­a *${document.getElementById('c-fecha').value}* a las *${document.getElementById('c-hora').value}* hrs. âœ¦`);
    window.open(`https://wa.me/52${tel}?text=${msg}`, '_blank');
};

window.cerrarModal=()=>document.getElementById('modalCita').classList.add('hidden');
cargarDoctores();
</script>
</body>
</html>
