<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | PANEL ASISTENTE</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        :root { --gold: #c5a059; --dark: #0f172a; }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; height: 100vh; overflow: hidden; }
        .glass { background: white; border-radius: 2rem; border: 1px solid rgba(197, 160, 89, .25); box-shadow: 0 20px 40px rgba(0,0,0,0.05); }

        /* ===== üé® ADN VISUAL DE EVENTOS ===== */
        .fc-event { border: none !important; border-radius: 10px !important; padding: 4px 6px !important; font-size: 11px; font-weight: 700; cursor: pointer; transition: .25s; }
        .fc-event:hover { transform: scale(1.02); z-index: 999; }

        /* Tipo visita */
        .event-primera { background: #e0f2fe !important; color: #0369a1 !important; border-left: 5px solid #0284c7 !important; }
        .event-recurrente { background: #ecfdf5 !important; color: #065f46 !important; border-left: 5px solid #10b981 !important; }

        /* Estado (Inyecci√≥n de Borde) */
        .estado-confirmado { border-left: 5px solid var(--gold) !important; }
        .estado-atendiendo { border-left: 5px solid #22c55e !important; animation: pulse 2s infinite; }
        .estado-completado { background: var(--dark) !important; color: var(--gold) !important; }
        .estado-cancelado { opacity: .4; filter: grayscale(1); }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, .4); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .fc-toolbar-title { font-weight: 800 !important; text-transform: uppercase; font-style: italic; font-size: 1.1rem !important; }
        .fc-button { background: var(--dark) !important; border: none !important; border-radius: 0.8rem !important; font-weight: 700; text-transform: uppercase; font-size: 10px !important; }
        .fc-button-active { background: var(--gold) !important; }
        
        .input-asistente { width: 100%; padding: 0.75rem; border-radius: 0.8rem; border: 1px solid #e2e8f0; font-size: 0.85rem; font-weight: 600; outline: none; transition: 0.3s; }
        .input-asistente:focus { border-color: var(--gold); background: #fff; }
    </style>
</head>

<body class="p-4 flex flex-col h-screen">

<div class="glass flex-1 p-6 flex flex-col overflow-hidden">
    <header class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-[var(--dark)] rounded-xl flex items-center justify-center text-[var(--gold)] font-bold">‚ú¶</div>
            <div>
                <h1 class="font-black italic text-xl tracking-tighter">K.B <span class="text-[var(--gold)]">SYSTEM</span></h1>
                <select id="doctorSelect" class="text-[10px] font-black uppercase text-slate-400 bg-transparent outline-none cursor-pointer hover:text-[var(--gold)] transition"></select>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="irAAgendar()" class="px-4 py-2 bg-[var(--gold)] text-white text-[10px] font-black uppercase rounded-xl hover:scale-105 transition">‚úö Nueva Cita</button>
            <button onclick="location.reload()" class="w-10 h-10 flex items-center justify-center bg-[var(--dark)] text-white rounded-xl hover:bg-[var(--gold)] transition">üîÑ</button>
        </div>
    </header>

    <div id="calendar" class="flex-1 overflow-auto"></div>
</div>

<div id="modalCita" class="fixed inset-0 hidden bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="glass bg-white p-8 w-full max-w-md shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="font-black uppercase italic text-lg tracking-tight">Editar <span class="text-[var(--gold)]">Radar</span></h2>
            <span id="badge-visita" class="text-[9px] font-black px-2 py-1 rounded bg-slate-100 italic"></span>
        </div>

        <div class="space-y-4">
            <div>
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-1 px-1">Paciente Identificado</p>
                <input id="c-paciente" class="input-asistente bg-slate-50 border-none" readonly>
            </div>

            <div>
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-1 px-1">Tel√©fono</p>
                <input id="c-telefono" class="input-asistente bg-slate-50 border-none" readonly>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1 px-1">Fecha</p>
                    <input type="date" id="c-fecha" class="input-asistente">
                </div>
                <div>
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1 px-1">Hora Inicio</p>
                    <input type="time" id="c-hora" class="input-asistente">
                </div>
            </div>

            <div>
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-1 px-1">Estado de la Misi√≥n</p>
                <select id="c-estado" class="input-asistente font-bold text-xs uppercase cursor-pointer">
                    <option value="pendiente">‚è≥ Pendiente</option>
                    <option value="confirmado">‚úì Confirmado</option>
                    <option value="atendiendo">üî• En consulta</option>
                    <option value="completado">‚ú¶ Completado</option>
                    <option value="cancelado">üö´ Cancelado</option>
                </select>
            </div>

            <div>
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-1 px-1">Notas de Inteligencia</p>
                <textarea id="c-notas" class="input-asistente h-24 resize-none" placeholder="Escribir observaciones..."></textarea>
            </div>
        </div>

        <div class="flex gap-3 mt-8">
            <button onclick="guardarCita()" class="flex-1 bg-[var(--dark)] text-[var(--gold)] py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-[var(--gold)] hover:text-white transition shadow-lg">Actualizar B√∫nker</button>
            <button onclick="cerrarModal()" class="px-4 py-4 text-[9px] font-black uppercase text-slate-400 hover:text-rose-500 transition">Cerrar</button>
        </div>
    </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
    'https://ctvqjnckxmqeejbfwmkj.supabase.co',
    'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w'
);

let calendar, doctorActual = null, citaActual = null;

// --- üõ∞Ô∏è CARGAR DOCTORES ---
async function cargarDoctores(){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    const { data: asig } = await supabase
        .from('Asistentes_Doctor')
        .select('doctor_id')
        .eq('asistente_id', session.user.id);

    if (!asig?.length) {
        document.getElementById('doctorSelect').innerHTML = '<option>SIN ASIGNACI√ìN</option>';
        return;
    }

    const { data: docs } = await supabase
        .from('Usuarios')
        .select('id, nombre')
        .in('id', asig.map(a => a.doctor_id));

    const sel = document.getElementById('doctorSelect');
    sel.innerHTML = '<option value="">ELEGIR JURISDICCI√ìN</option>' +
        docs.map(d => `<option value="${d.id}">DR. ${d.nombre.toUpperCase()}</option>`).join('');

    sel.onchange = () => {
        doctorActual = sel.value;
        if (!calendar) initCalendar();
        else calendar.refetchEvents();
    };
}

// --- üß† CARGAR CITAS CON ADN VISUAL ---
async function cargarCitas(info, success, failure){
    if (!doctorActual) return success([]);

    try {
        const { data, error } = await supabase
            .from('Citas')
            .select('*, Pacientes!fk_citas_pacientes_maestra(*)')
            .eq('doctor_id', doctorActual);

        if (error) throw error;

        success(data.map(c => {
            const clases = [];
            clases.push(c.Pacientes?.primera_visita ? 'event-primera' : 'event-recurrente');
            clases.push(`estado-${c.estado}`);
            
            return {
                id: c.id,
                title: c.Pacientes?.nombre || 'PACIENTE',
                start: `${c.fecha}T${c.hora_inicio}`,
                classNames: clases,
                extendedProps: c
            };
        }));
    } catch (e) { failure(e); }
}

// --- üìÖ INICIALIZAR RADAR ---
function initCalendar(){
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'es',
        initialView: 'timeGridDay',
        allDaySlot: false,
        slotMinTime: '08:00',
        slotMaxTime: '20:00',
        expandRows: true,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'timeGridDay,timeGridWeek'
        },
        events: cargarCitas,
        eventClick: (info) => {
            citaActual = info.event.extendedProps;
            
            // Llenado de Modal con todas las funciones
            document.getElementById('c-paciente').value = info.event.title;
            document.getElementById('c-telefono').value = citaActual.Pacientes?.telefono || 'SIN TEL';
            document.getElementById('c-fecha').value = citaActual.fecha;
            document.getElementById('c-hora').value = citaActual.hora_inicio.slice(0,5);
            document.getElementById('c-estado').value = citaActual.estado;
            document.getElementById('c-notas').value = citaActual.notas || '';
            
            // Badge de rango
            const badge = document.getElementById('badge-visita');
            badge.innerText = citaActual.Pacientes?.primera_visita ? "‚ú¶ PRIMERA VEZ" : "‚úì RECURRENTE";
            badge.className = `text-[9px] font-black px-2 py-1 rounded italic ${citaActual.Pacientes?.primera_visita ? 'bg-blue-100 text-blue-600' : 'bg-emerald-100 text-emerald-600'}`;

            document.getElementById('modalCita').classList.remove('hidden');
        }
    });
    calendar.render();
}

// --- üõ†Ô∏è GUARDAR CAMBIOS ---
window.guardarCita = async () => {
    const { error } = await supabase.from('Citas')
        .update({
            fecha: document.getElementById('c-fecha').value,
            hora_inicio: document.getElementById('c-hora').value,
            estado: document.getElementById('c-estado').value,
            notas: document.getElementById('c-notas').value
        })
        .eq('id', citaActual.id);

    if (error) {
        alert("FALLA EN LA SINCRONIZACI√ìN: " + error.message);
    } else {
        calendar.refetchEvents();
        cerrarModal();
    }
};

window.cerrarModal = () => document.getElementById('modalCita').classList.add('hidden');

window.irAAgendar = () => {
    if (!doctorActual) return alert("ELIJA UN DOCTOR PRIMERO");
    window.location.href = `agendar.html?docId=${doctorActual}`;
};

cargarDoctores();
</script>
</body>
</html>
