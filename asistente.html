<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | PANEL ASISTENTE ELITE ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        :root { --luxe-gold: #c5a059; --luxe-dark: #0f172a; --luxe-bg: #f8f9fa; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--luxe-bg); color: #1e293b; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(197, 160, 89, 0.2); border-radius: 2.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.05); }
        .fc { background: transparent; border: none !important; height: 100%; }
        .fc-toolbar-title { font-weight: 900 !important; text-transform: uppercase; letter-spacing: 0.1em; color: var(--luxe-dark); font-size: 1rem !important; }
        .fc-button { background: var(--luxe-dark) !important; border: none !important; border-radius: 1rem !important; font-weight: 800; text-transform: uppercase; font-size: 9px !important; }
        .fc-button-active { background: var(--luxe-gold) !important; }
        .fc-timegrid-event { border-radius: 12px !important; border: none !important; box-shadow: 0 4px 10px rgba(0,0,0,0.05) !important; }
        .input-luxe { width: 100%; padding: 0.75rem; border-radius: 1rem; border: 1px solid #e2e8f0; outline: none; transition: 0.3s; font-size: 0.8rem; }
        .modal-blur { backdrop-filter: blur(15px); background: rgba(15, 23, 42, 0.4); }
    </style>
</head>
<body class="h-screen p-4 flex flex-col">

    <div class="flex-1 glass p-6 flex flex-col overflow-hidden">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-[#0f172a] rounded-xl flex items-center justify-center shadow-lg text-white font-bold text-lg">A</div>
                <div>
                    <h1 class="text-lg font-black italic uppercase tracking-tighter text-[#0f172a]">Panel <span class="text-[#c5a059]">Asistente</span></h1>
                    <select id="doctorSelect" class="bg-transparent text-[9px] font-black uppercase tracking-widest text-slate-400 outline-none cursor-pointer hover:text-[#c5a059] transition border-none focus:ring-0">
                        <option value="">INICIALIZANDO RADAR...</option>
                    </select>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="abrirBloqueo()" class="text-[9px] font-black uppercase px-4 py-2 bg-white border border-slate-100 rounded-xl shadow-sm hover:border-rose-400 transition">üö´ Bloquear Fecha</button>
                <button onclick="window.location.href='configurar-perfil.html'" class="text-[9px] font-black uppercase px-4 py-2 bg-[#0f172a] text-white rounded-xl shadow-xl hover:bg-[#c5a059] transition">‚öôÔ∏è Ajustes</button>
            </div>
        </header>

        <div class="flex-1 overflow-hidden relative">
            <div id="calendar" class="h-full"></div>
        </div>
    </div>

    <div id="modalCita" class="fixed inset-0 hidden modal-blur flex items-center justify-center z-[9999] p-4">
        <div class="glass max-w-md w-full p-8 bg-white shadow-2xl">
            <h2 class="text-xl font-black uppercase italic text-[#0f172a] mb-6 border-b pb-2">Gestionar <span class="text-[#c5a059]">Cita</span></h2>
            <div class="space-y-3">
                <div class="text-[10px] font-bold text-slate-400 px-1 uppercase italic tracking-widest">Identidad del Paciente</div>
                <input id="c-paciente" class="input-luxe bg-slate-50" readonly>
                <input id="c-telefono" class="input-luxe bg-slate-50" readonly>
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <input type="date" id="c-fecha" class="input-luxe">
                    <input type="time" id="c-hora" class="input-luxe">
                </div>
                <select id="c-estado" class="input-luxe font-bold uppercase text-[10px]">
                    <option value="pendiente">Pendiente</option>
                    <option value="confirmado">Confirmado</option>
                    <option value="atendiendo">En Consulta</option>
                    <option value="completado">Completado</option>
                    <option value="cancelado">CANCELAR CITA</option>
                </select>
                <textarea id="c-notas" class="input-luxe h-24" placeholder="NOTAS DE LA CONSULTA..."></textarea>
            </div>
            <div class="flex justify-between mt-6 gap-2">
                <button onclick="guardarCita()" class="flex-1 py-3 bg-[#0f172a] text-[#c5a059] rounded-xl font-black uppercase text-[9px] tracking-widest hover:bg-emerald-600 hover:text-white transition">Actualizar Radar</button>
                <button onclick="cerrarModal()" class="px-6 py-3 text-[9px] font-black uppercase text-slate-400">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="modalBloqueo" class="fixed inset-0 hidden modal-blur flex items-center justify-center z-[9999] p-4">
        <div class="glass max-w-sm w-full p-8 bg-white">
            <h2 class="text-lg font-black uppercase italic text-rose-500 mb-6">Nuevo <span class="text-slate-800">Bloqueo</span></h2>
            <div class="space-y-4">
                <input type="date" id="b-fecha" class="input-luxe">
                <div class="grid grid-cols-2 gap-2">
                    <input type="time" id="b-inicio" class="input-luxe" value="08:00">
                    <input type="time" id="b-fin" class="input-luxe" value="14:00">
                </div>
                <input id="b-motivo" class="input-luxe" placeholder="MOTIVO (VACACIONES, CONGRESO)">
                <button onclick="guardarBloqueo()" class="w-full py-4 bg-rose-500 text-white rounded-xl font-black uppercase text-[9px] tracking-widest shadow-lg">Inyectar Bloqueo</button>
                <button onclick="cerrarBloqueo()" class="w-full text-[9px] font-black uppercase text-slate-400 mt-2 text-center">Cancelar</button>
            </div>
        </div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

    let calendar, citaActual = null, doctorActual = null;
    const ESTADOS = {
        pendiente: { bg:'#f8fafc', txt:'#94a3b8' },
        confirmado: { bg:'#fffdf5', txt:'#c5a059' },
        atendiendo: { bg:'#f0fdf4', txt:'#10b981' },
        completado: { bg:'#0f172a', txt:'#c5a059' },
        cancelado: { bg:'#fef2f2', txt:'#ef4444' }
    };

    async function cargarDoctores() {
        const { data, error } = await supabase.from('Usuarios').select('id, nombre').eq('rol', 'doctor');
        if (error) return console.error("Error en b√∫nker:", error);
        const select = document.getElementById('doctorSelect');
        select.innerHTML = '<option value="">SELECCIONA DOCTOR</option>' + 
            data.map(d => `<option value="${d.id}">Dr. ${d.nombre}</option>`).join('');

        select.onchange = () => {
            doctorActual = select.value;
            if (doctorActual === "") return;
            if (!calendar) initCalendar();
            else calendar.refetchEvents();
        };
    }

    async function cargarCitas(info, success, failure) {
        if (!doctorActual) return success([]);
        try {
            const { data, error } = await supabase.from('Citas')
                .select('*, Pacientes!fk_citas_pacientes_maestra(nombre, telefono), Servicios(nombre)')
                .eq('doctor_id', doctorActual)
                .neq('estado', 'cancelado');
            
            if (error) throw error;
            success((data || []).map(c => ({
                id: c.id,
                title: c.Pacientes?.nombre || 'PACIENTE',
                start: `${c.fecha}T${c.hora_inicio}`,
                end: new Date(new Date(`${c.fecha}T${c.hora_inicio}`).getTime() + (c.duracion_cita || 30) * 60000),
                backgroundColor: ESTADOS[c.estado]?.bg || '#f8fafc',
                textColor: ESTADOS[c.estado]?.txt || '#1e293b',
                extendedProps: c
            })));
        } catch (err) { failure(err); }
    }

    function initCalendar() {
        const calendarEl = document.getElementById('calendar');
        if (calendar) calendar.destroy();
        calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'es', initialView: 'timeGridWeek', allDaySlot: false,
            slotMinTime: '08:00', slotMaxTime: '20:00', editable: true, selectable: true,
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridDay,timeGridWeek' },
            events: cargarCitas,
            eventContent: (arg) => ({
                html: `<div class="p-1 h-full border-l-4 overflow-hidden" style="border-color: ${arg.event.textColor}">
                        <div class="text-[9px] font-black uppercase truncate">${arg.event.title}</div>
                        <div class="text-[7px] italic opacity-60 truncate">${arg.event.extendedProps.Servicios?.nombre || 'Consulta'}</div>
                      </div>`
            }),
            eventClick: (info) => abrirEditar(info.event.extendedProps),
            eventDrop: async (info) => {
                const { error } = await supabase.from('Citas').update({
                    fecha: info.event.startStr.slice(0,10),
                    hora_inicio: info.event.startStr.slice(11,16)
                }).eq('id', info.event.id);
                if(error) { console.error("Error al mover:", error); info.revert(); }
            }
        });
        calendar.render();
    }

    window.abrirEditar = (c) => {
        citaActual = c;
        document.getElementById('c-paciente').value = c.Pacientes?.nombre || 'PACIENTE';
        document.getElementById('c-telefono').value = c.Pacientes?.telefono || '---';
        document.getElementById('c-fecha').value = c.fecha;
        // Limpiamos la hora para el input time (asegura formato HH:mm)
        document.getElementById('c-hora').value = c.hora_inicio.slice(0, 5);
        document.getElementById('c-estado').value = c.estado;
        document.getElementById('c-notas').value = c.notas || '';
        document.getElementById('modalCita').classList.remove('hidden');
    };

    // ‚ö° CIRUG√çA: Funci√≥n de guardado con limpieza de datos
    window.guardarCita = async () => {
        if (!citaActual || !citaActual.id) return;

        const data = {
            fecha: document.getElementById('c-fecha').value,
            hora_inicio: document.getElementById('c-hora').value, // El input time ya da formato 24h
            estado: document.getElementById('c-estado').value,
            notas: document.getElementById('c-notas').value
        };

        const { error } = await supabase
            .from('Citas')
            .update(data)
            .eq('id', citaActual.id);

        if (!error) {
            console.log("‚úÖ Radar Sincronizado");
            calendar.refetchEvents();
            cerrarModal();
        } else {
            console.error("‚ùå Error en cirug√≠a:", error.message);
            alert("Error al actualizar: " + error.message);
        }
    };

    window.guardarBloqueo = async () => {
        const { error } = await supabase.from('Bloqueos').insert({
            doctor_id: doctorActual,
            fecha: document.getElementById('b-fecha').value,
            hora_inicio: document.getElementById('b-inicio').value,
            hora_fin: document.getElementById('b-fin').value,
            motivo: document.getElementById('b-motivo').value.toUpperCase()
        });
        if (!error) { calendar.refetchEvents(); cerrarBloqueo(); }
    };

    window.cerrarModal = () => document.getElementById('modalCita').classList.add('hidden');
    window.abrirBloqueo = () => document.getElementById('modalBloqueo').classList.remove('hidden');
    window.cerrarBloqueo = () => document.getElementById('modalBloqueo').classList.add('hidden');

    cargarDoctores();
</script>
</body>
</html>
