<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | CONTROL MAESTRO ‚ú¶</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        :root { --main: #6366f1; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; color: #1e293b; display: flex; min-height: 100vh; overflow: hidden; }
        
        .sidebar { width: 280px; background: #0f172a; color: white; transition: 0.3s; display: flex; flex-direction: column; }
        .nav-item { padding: 1rem 2rem; display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: 0.3s; font-weight: 600; font-size: 0.85rem; color: #94a3b8; }
        .nav-item:hover, .nav-item.active { background: rgba(99, 102, 241, 0.1); color: white; border-right: 4px solid var(--main); }
        
        .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(18px); border-radius: 2rem; border: 1px solid rgba(255,255,255,0.5); }
        .input-kb { background: #f8fafc; border: 2px solid transparent; border-radius: 1.25rem; padding: 1rem; font-weight: 600; font-size: 0.8rem; transition: 0.3s; width: 100%; }
        .input-kb:focus { border-color: var(--main); background: white; outline: none; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.1); }
        
        .modal-overlay { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        .fc-event { cursor: pointer; border: none !important; padding: 4px; border-radius: 8px !important; }
        #toast { transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10000; }
    </style>
</head>
<body class="flex">

<nav class="sidebar hidden md:flex h-screen sticky top-0">
    <div class="p-8">
        <h1 class="text-2xl font-black italic tracking-tighter">K.B <span class="text-indigo-400">COMMAND</span></h1>
        <p class="text-[8px] uppercase tracking-[0.4em] opacity-40 font-bold mt-2">B√∫nker Operativo</p>
    </div>
    
    <div class="mt-4 flex-1">
        <div class="nav-item active" onclick="location.reload()"><span>üìä</span> Dashboard</div>
        <div class="nav-item"><span>üìÖ</span> Agenda</div>
        <div class="nav-item"><span>üë•</span> Pacientes</div>
        <div class="nav-item"><span>üí∞</span> Pagos</div>
        <div id="btnConfig" class="nav-item"><span>‚öôÔ∏è</span> Configuraci√≥n</div>
    </div>

    <div class="p-8 mt-auto border-t border-slate-800">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-xs" id="userInitial">AK</div>
            <div>
                <p class="text-[10px] font-black uppercase" id="userName">Cargando...</p>
                <p class="text-[8px] text-slate-500 uppercase font-bold" id="labelRol">Iniciando...</p>
            </div>
        </div>
    </div>
</nav>

<main class="flex-1 overflow-y-auto h-screen p-4 md:p-8">
    <header class="max-w-[1600px] mx-auto mb-8 flex justify-between items-center bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-2xl">
        <div>
            <h1 class="text-3xl font-black italic tracking-tighter uppercase">Torre de <span class="text-indigo-400">Control</span> ‚ú¶</h1>
            <p class="text-[10px] uppercase tracking-[0.4em] font-bold opacity-50 italic">Log√≠stica Binacional Tijuana/EE.UU.</p>
        </div>
        <select id="filtroDoctor" class="bg-indigo-600 px-6 py-3 rounded-2xl font-bold text-xs outline-none cursor-pointer border-none uppercase">
            <option value="all">TODOS LOS DOCTORES</option>
        </select>
    </header>

    <div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-8">
        <aside class="col-span-12 lg:col-span-3 space-y-6">
            <div class="glass p-8 shadow-xl">
                <h3 class="text-[10px] font-black uppercase text-indigo-600 mb-6 tracking-widest italic">Inyectar Cita</h3>
                <div class="space-y-4">
                    <input id="tel" class="input-kb" placeholder="Tel√©fono (10 d√≠gitos)" maxlength="10">
                    <input id="nom" class="input-kb" placeholder="Nombre del Paciente">
                    <select id="doc" class="input-kb"></select>
                    <select id="ser" class="input-kb"></select>
                    <input type="time" id="hor" class="input-kb">
                    <button id="btnAgendar" class="w-full bg-slate-900 text-white p-5 rounded-[1.5rem] font-black uppercase text-[10px] tracking-widest hover:bg-indigo-600 transition-all shadow-lg active:scale-95">Agendar Misi√≥n üì°</button>
                </div>
            </div>

            <div id="panelAcciones" class="glass p-8 hidden border-2 border-indigo-100 shadow-2xl">
                <h3 class="text-[10px] font-black uppercase mb-4 text-slate-400">Control de Cita</h3>
                <div id="btnsAccion" class="flex flex-col gap-3"></div>
            </div>
        </aside>

        <section class="col-span-12 lg:col-span-9 glass p-6 shadow-xl min-h-[750px]">
            <div id="calendar"></div>
        </section>
    </div>
</main>

<div id="toast" class="fixed bottom-6 right-6 hidden bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl text-[10px] font-black uppercase tracking-widest border border-slate-700"></div>

<div id="modalCobro" class="modal-overlay fixed inset-0 z-[999] hidden flex items-center justify-center p-4">
    <div class="glass max-w-md w-full p-10 bg-white shadow-2xl">
        <h2 class="text-2xl font-black italic mb-2 uppercase tracking-tighter">Cierre de <span class="text-indigo-600">Caja</span></h2>
        <p id="infoPago" class="text-xs font-bold text-slate-400 mb-8 uppercase"></p>
        <div class="space-y-6">
            <input id="montoPago" type="number" class="input-kb text-2xl font-black text-indigo-600" step="0.01">
            <select id="metodoPago" class="input-kb font-bold">
                <option value="Efectivo">Efectivo üíµ</option>
                <option value="Tarjeta">Tarjeta üí≥</option>
                <option value="Transferencia">Transferencia üè¶</option>
            </select>
            <div class="flex gap-4">
                <button onclick="cerrarModalCobro()" class="flex-1 p-4 rounded-2xl font-bold text-xs uppercase bg-slate-100">Cancelar</button>
                <button id="btnConfirmarPago" class="flex-1 p-4 rounded-2xl font-black text-xs uppercase bg-emerald-500 text-white shadow-lg shadow-emerald-200">Registrar üí∞</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

// üîê DATOS DE SESI√ìN
const rolUsuario = localStorage.getItem('rol') || 'asistente';
const nombreUsuario = localStorage.getItem('nombre_usuario') || 'Amigo Kev';
const currentUserId = localStorage.getItem('user_id');

// UI UPDATES
document.getElementById('labelRol').innerText = `Rango: ${rolUsuario.toUpperCase()}`;
document.getElementById('userName').innerText = nombreUsuario;
document.getElementById('userInitial').innerText = nombreUsuario.slice(0,2).toUpperCase();

// ‚öôÔ∏è ENLACE A CONFIGURACI√ìN (BLINDADO)
document.getElementById('btnConfig').onclick = () => {
    // Si no hay ID, no podemos configurar nada.
    if (!currentUserId) {
        toast("‚õî ERROR: NODO DE IDENTIDAD NO DETECTADO");
        console.error("ID de usuario ausente en localStorage");
        return;
    }
    // Redirecci√≥n al archivo de perfil
    window.location.href = `configurar-perfil.html?id=${currentUserId}`;
};

function checkPermiso(accion) {
    const permisos = {
        asistente: ['crear', 'ver', 'confirmar'],
        doctor: ['ver', 'atender', 'completar'],
        admin: ['todo']
    };
    return permisos[rolUsuario]?.includes(accion) || permisos[rolUsuario]?.includes('todo');
}

function toast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 3000);
}

async function logAccion(citaId, accion) {
    try {
        await supabase.from('Logs').insert({ cita_id: citaId, accion: accion, usuario: nombreUsuario });
    } catch(e) { console.error(e); }
}

let calendar, citaActiva = null;

const db = {
    async asegurarPaciente(tel, nom) {
        let { data } = await supabase.from('Pacientes').select('*').eq('telefono', tel).maybeSingle();
        if (!data) data = (await supabase.from('Pacientes').insert({ nombre: nom, telefono: tel }).select().single()).data;
        return data;
    },
    async obtenerDoctores() { return (await supabase.from('Perfiles_Medicos').select('id, Usuarios(nombre), especialidad')).data; },
    async obtenerServicios(docId) { return (await supabase.from('Servicios').select('*').eq('doctor_id', docId).eq('activo', true)).data; },
    async registrarCita(data) { return await supabase.from('Citas').insert(data); },
    async actualizarEstado(id, estado) { 
        const res = await supabase.from('Citas').update({ estado }).eq('id', id);
        await logAccion(id, `Estado cambiado a: ${estado}`);
        return res;
    }
};

function initCalendar() {
    calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        locale: 'es', initialView: 'timeGridDay', slotMinTime: '07:00', slotMaxTime: '21:00',
        editable: true, nowIndicator: true, allDaySlot: false,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'timeGridDay,timeGridWeek,dayGridMonth'
        },
        events: async (info, success) => {
            let q = supabase.from('Citas').select('*, Pacientes(nombre, telefono), Servicios(nombre, precio)');
            if(filtroDoctor.value !== 'all') q = q.eq('doctor_id', filtroDoctor.value);
            const { data } = await q;
            success(data.map(c => ({
                id: c.id, title: `${c.Pacientes.nombre} ‚Äî ${c.Servicios.nombre}`,
                start: `${c.fecha}T${c.hora_inicio}`,
                end: new Date(new Date(`${c.fecha}T${c.hora_inicio}`).getTime() + c.duracion_total * 60000),
                backgroundColor: colorEstado(c.estado), extendedProps: c
            })));
        },
        eventDrop: async (info) => {
            if (!checkPermiso('confirmar')) { info.revert(); return toast('‚õî ACCESO DENEGADO'); }
            const nHora = info.event.start.toTimeString().slice(0,5);
            const nFecha = info.event.startStr.slice(0,10);
            await supabase.from('Citas').update({ fecha: nFecha, hora_inicio: nHora }).eq('id', info.event.id);
            await logAccion(info.event.id, 'Reagendada v√≠a ERP');
            toast('üìÖ RADAR ACTUALIZADO');
        },
        eventClick: (info) => {
            citaActiva = info.event.extendedProps;
            mostrarPanelAcciones(citaActiva);
        }
    });
    calendar.render();
}

function colorEstado(e) {
    return { pendiente:'#f59e0b', confirmado:'#0ea5e9', atendiendo:'#6366f1', completado:'#10b981', cancelado:'#ef4444' }[e] || '#94a3b8';
}

function activarRealtime() {
    supabase.channel('cambios-citas').on('postgres_changes', { event: '*', schema: 'public', table: 'Citas' }, () => {
        calendar.refetchEvents();
        toast('üîÑ AGENDA ACTUALIZADA');
    }).subscribe();
}

async function initUI() {
    const docs = await db.obtenerDoctores();
    const docSelect = document.getElementById('doc');
    const filtro = document.getElementById('filtroDoctor');
    
    docSelect.innerHTML = docs.map(d => `<option value="${d.id}">${d.Usuarios.nombre}</option>`).join('');
    filtro.innerHTML += docs.map(d => `<option value="${d.id}">${d.Usuarios.nombre}</option>`).join('');
    
    docSelect.onchange = () => cargarServicios(docSelect.value);
    filtro.onchange = () => calendar.refetchEvents();
    
    if(docs.length > 0) await cargarServicios(docs[0].id);

    document.getElementById('tel').oninput = async (e) => {
        const telVal = e.target.value;
        if (telVal.length === 10) {
            const { data } = await supabase.from('Pacientes').select('nombre').eq('telefono', telVal).maybeSingle();
            if (data) { 
                document.getElementById('nom').value = data.nombre; 
                document.getElementById('nom').classList.add('bg-green-50'); 
                toast('üéØ PACIENTE IDENTIFICADO'); 
            }
        }
    };

    document.getElementById('btnAgendar').onclick = async () => {
        if(!checkPermiso('crear')) return toast('‚õî PERMISO DENEGADO');
        const tel = document.getElementById('tel').value;
        const nombre = document.getElementById('nom').value;
        const doctor = document.getElementById('doc').value;
        const servicio = document.getElementById('ser').value;
        const hora = document.getElementById('hor').value;
        
        if(!tel || !nombre || !hora) return toast('‚ö†Ô∏è DATOS INCOMPLETOS');

        const paciente = await db.asegurarPaciente(tel, nombre);
        const servSelect = document.getElementById('ser');
        const servOpt = servSelect.selectedOptions[0];
        
        await db.registrarCita({
            doctor_id: doctor, paciente_id: paciente.id, servicio_id: servicio,
            fecha: calendar.getDate().toISOString().slice(0, 10), hora_inicio: hora,
            duracion_total: Number(servOpt.dataset.d), monto: Number(servOpt.dataset.p), estado: 'pendiente'
        });
        
        calendar.refetchEvents();
        toast('üöÄ MISI√ìN REGISTRADA');
    };
}

async function cargarServicios(docId) {
    const servs = await db.obtenerServicios(docId);
    const sSelect = document.getElementById('ser');
    sSelect.innerHTML = servs.map(s => `<option value="${s.id}" data-d="${s.duracion_total}" data-p="${s.precio}">${s.nombre} ($${s.precio})</option>`).join('');
}

function mostrarPanelAcciones(c) {
    const panel = document.getElementById('panelAcciones');
    const btns = document.getElementById('btnsAccion');
    panel.classList.remove('hidden');
    
    let html = '';
    if (checkPermiso('atender')) html += `<button onclick="updateStatus('atendiendo')" class="bg-indigo-600 text-white p-4 rounded-2xl text-[10px] font-black uppercase">Atender ‚ö°</button>`;
    if (checkPermiso('completado')) html += `<button onclick="abrirModalCobro()" class="bg-emerald-500 text-white p-4 rounded-2xl text-[10px] font-black uppercase">Cobrar üí∞</button>`;
    html += `<button onclick="window.open('https://wa.me/52${c.Pacientes.telefono}')" class="bg-green-500 text-white p-4 rounded-2xl text-[10px] font-black uppercase text-center">WhatsApp üì±</button>`;
    
    btns.innerHTML = html;
}

window.updateStatus = async (st) => {
    await db.actualizarEstado(citaActiva.id, st);
    calendar.refetchEvents();
    document.getElementById('panelAcciones').classList.add('hidden');
    toast(`‚úÖ ESTADO: ${st.toUpperCase()}`);
};

window.abrirModalCobro = () => {
    document.getElementById('modalCobro').classList.remove('hidden');
    document.getElementById('infoPago').innerText = `Paciente: ${citaActiva.Pacientes.nombre}`;
    document.getElementById('montoPago').value = citaActiva.monto || 0;
};

window.cerrarModalCobro = () => document.getElementById('modalCobro').classList.add('hidden');

document.getElementById('btnConfirmarPago').onclick = async () => {
    const monto = document.getElementById('montoPago').value;
    const metodo = document.getElementById('metodoPago').value;
    
    await supabase.from('Pagos').insert({ cita_id: citaActiva.id, monto: Number(monto), metodo: metodo });
    await supabase.from('Citas').update({ pagado: true, estado: 'completado' }).eq('id', citaActiva.id);
    await logAccion(citaActiva.id, 'Cierre de Caja');
    
    toast('üí∞ PAGO REGISTRADO CON √âXITO');
    cerrarModalCobro();
    document.getElementById('panelAcciones').classList.add('hidden');
    calendar.refetchEvents();
};

initCalendar();
initUI();
activarRealtime();
</script>
</body>
</html>
