<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | PANEL ASISTENTE ELITE ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        :root { --luxe-gold: #c5a059; --luxe-dark: #0f172a; --luxe-bg: #f8f9fa; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--luxe-bg); color: #1e293b; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(197, 160, 89, 0.2); border-radius: 2.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.05); }
        
        /* üé® ESTILO CALENDARIO K.B */
        .fc { background: transparent; border: none !important; height: 100%; }
        .fc-toolbar-title { font-weight: 900 !important; text-transform: uppercase; letter-spacing: 0.1em; color: var(--luxe-dark); font-size: 1.1rem !important; font-style: italic; }
        .fc-button { background: var(--luxe-dark) !important; border: none !important; border-radius: 1rem !important; font-weight: 800; text-transform: uppercase; font-size: 9px !important; padding: 10px 15px !important; transition: 0.3s !important; }
        .fc-button:hover { background: var(--luxe-gold) !important; transform: translateY(-2px); }
        .fc-button-active { background: var(--luxe-gold) !important; box-shadow: 0 10px 20px -5px var(--luxe-gold) !important; }
        
        /* üß¨ ESTATUS DE EVENTOS */
        .fc-event { border: none !important; border-radius: 8px !important; padding: 2px 5px !important; transition: all 0.3s ease; cursor: pointer; font-weight: 700; font-size: 10px; }
        
        .input-luxe { width: 100%; padding: 0.75rem; border-radius: 1rem; border: 1px solid #e2e8f0; outline: none; transition: 0.3s; font-size: 0.8rem; font-weight: 600; }
        .modal-blur { backdrop-filter: blur(15px); background: rgba(15, 23, 42, 0.4); }
        
        @keyframes star-glow { 0% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(1); } }
        .kb-star { color: var(--luxe-gold); animation: star-glow 3s infinite ease-in-out; }

        /* Pulso para Citas en Consulta */
        @keyframes pulse-live {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .event-atendiendo { animation: pulse-live 2s infinite; }
    </style>
</head>
<body class="p-4">

    <div class="flex-1 glass p-6 flex flex-col overflow-hidden relative">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-[#0f172a] rounded-2xl flex items-center justify-center shadow-xl">
                    <span class="kb-star text-2xl">‚ú¶</span>
                </div>
                <div>
                    <h1 class="text-xl font-black italic uppercase tracking-tighter text-[#0f172a]">K.B <span class="text-[#c5a059]">SYSTEM</span></h1>
                    <select id="doctorSelect" class="bg-transparent text-[10px] font-black uppercase tracking-widest text-slate-400 outline-none cursor-pointer hover:text-[#c5a059] transition border-none p-0">
                        <option value="">ESCANEANDO JURISDICCI√ìN...</option>
                    </select>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="irAAgendar()" class="text-[9px] font-black uppercase px-4 py-2 bg-[#c5a059] text-white rounded-xl shadow-lg hover:scale-105 transition">‚úö Nueva Cita</button>
                <button onclick="window.location.reload()" class="w-10 h-10 flex items-center justify-center bg-[#0f172a] text-white rounded-xl shadow-xl hover:bg-[#c5a059] transition">üîÑ</button>
            </div>
        </header>

        <div class="flex-1 overflow-hidden">
            <div id="calendar" class="h-full"></div>
        </div>

        <footer class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center text-[9px] font-black uppercase tracking-widest text-slate-300">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                <p class="text-emerald-500">Radar Operativo</p>
            </div>
            <p>POWERED BY <span class="text-[#c5a059]">K.B TECH SOLUTIONS</span> ‚ú¶ 2026</p>
        </footer>
    </div>

    <div id="modalCita" class="fixed inset-0 hidden modal-blur flex items-center justify-center z-[9999] p-4">
        <div class="glass max-w-md w-full p-8 bg-white shadow-2xl">
            <h2 class="text-xl font-black uppercase italic text-[#0f172a] mb-6 border-b pb-2">Estatus de <span class="text-[#c5a059]">Misi√≥n</span></h2>
            <div class="space-y-4">
                <div>
                    <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Paciente & Rango</p>
                    <input id="c-paciente" class="input-luxe bg-slate-50" readonly>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Fecha</p>
                        <input type="date" id="c-fecha" class="input-luxe" readonly>
                    </div>
                    <div>
                        <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Hora</p>
                        <input type="time" id="c-hora" class="input-luxe" readonly>
                    </div>
                </div>
                <div>
                    <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Sem√°foro de Estado</p>
                    <select id="c-estado" class="input-luxe font-bold uppercase text-[10px]">
                        <option value="pendiente">‚è≥ PENDIENTE (ESPERA)</option>
                        <option value="confirmado">‚úì CONFIRMADO (EN CAMINO)</option>
                        <option value="atendiendo">üî• EN CONSULTA (ACTIVO)</option>
                        <option value="completado">‚ú¶ COMPLETADO (FINALIZADO)</option>
                        <option value="cancelado">üö´ CANCELAR CITA</option>
                    </select>
                </div>
                <textarea id="c-notas" class="input-luxe h-20" placeholder="OBSERVACIONES M√âDICAS..."></textarea>
            </div>
            <div class="flex justify-between mt-8 gap-3">
                <button onclick="guardarCita()" class="flex-1 py-4 bg-[#0f172a] text-[#c5a059] rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-[#c5a059] hover:text-white transition">Actualizar Radar</button>
                <button onclick="cerrarModal()" class="px-4 py-4 text-[9px] font-black uppercase text-slate-400">Cerrar</button>
            </div>
        </div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

    let calendar, citaActual = null, doctorActual = null;

    // üé® SEM√ÅFORO T√ÅCTICO: COLORES POR ESTADO
    const ESTADOS = {
        pendiente: { bg:'#fef3c7', txt:'#b45309', class:'' },     // √Åmbar
        confirmado: { bg:'#dbeafe', txt:'#1d4ed8', class:'' },    // Azul
        atendiendo: { bg:'#dcfce7', txt:'#10b981', class:'event-atendiendo' }, // Verde Pulse
        completado: { bg:'#0f172a', txt:'#c5a059', class:'' },    // Dark/Gold
        cancelado: { bg:'#fef2f2', txt:'#ef4444', class:'' }      // Rojo
    };

    // üõ∞Ô∏è NAVEGACI√ìN
    window.irAAgendar = () => {
        if (!doctorActual) return alert("ERROR: SELECCIONE DOCTOR");
        window.location.href = `agendar.html?docId=${doctorActual}`;
    };

    // üß† INTELIGENCIA DE RANGO (PRIMERA VISITA VS SECUENCIA)
    async function obtenerRango(pacienteId, citaId) {
        const { count } = await supabase.from('Citas')
            .select('*', { count: 'exact', head: true })
            .eq('paciente_id', pacienteId)
            .eq('estado', 'completado')
            .lt('created_at', (await supabase.from('Citas').select('created_at').eq('id', citaId).single()).data.created_at);
        
        return count === 0 ? "‚ú¶ PRIMERA VISITA" : `‚úì SECUENCIA (#${count + 1})`;
    }

    async function cargarDoctores() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const { data: asignaciones } = await supabase.from('Asistentes_Doctor').select('doctor_id, turno').eq('asistente_id', session.user.id);
        
        if (!asignaciones?.length) return;

        const { data: docs } = await supabase.from('Usuarios').select('id, nombre').in('id', asignaciones.map(a => a.doctor_id));

        const select = document.getElementById('doctorSelect');
        select.innerHTML = '<option value="">SELECCIONE JURISDICCI√ìN</option>' + 
            docs.map(d => `<option value="${d.id}">DR. ${d.nombre.toUpperCase()}</option>`).join('');

        select.onchange = () => {
            doctorActual = select.value;
            if (doctorActual) {
                if (!calendar) initCalendar();
                else calendar.refetchEvents();
            }
        };
    }

    async function cargarCitas(info, success, failure) {
        if (!doctorActual) return success([]);
        try {
            const { data, error } = await supabase.from('Citas')
                .select('*, Pacientes!fk_citas_pacientes_maestra(*)')
                .eq('doctor_id', doctorActual);
            
            if (error) throw error;

            const eventos = data.map(c => ({
                id: c.id,
                title: c.Pacientes?.nombre || 'PACIENTE',
                start: `${c.fecha}T${c.hora_inicio}`,
                backgroundColor: ESTADOS[c.estado]?.bg || '#f8fafc',
                textColor: ESTADOS[c.estado]?.txt || '#1e293b',
                className: ESTADOS[c.estado]?.class || '',
                extendedProps: c
            }));
            success(eventos);
        } catch (err) { failure(err); }
    }

    function initCalendar() {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            locale: 'es', initialView: 'timeGridDay', allDaySlot: false,
            slotMinTime: '08:00', slotMaxTime: '20:00', height: '100%',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridDay,timeGridWeek' },
            events: cargarCitas,
            eventClick: async (info) => {
                const c = info.event.extendedProps;
                citaActual = c;
                const rango = await obtenerRango(c.paciente_id, c.id);
                
                document.getElementById('c-paciente').value = `${c.Pacientes?.nombre} (${rango})`;
                document.getElementById('c-fecha').value = c.fecha;
                document.getElementById('c-hora').value = c.hora_inicio.slice(0,5);
                document.getElementById('c-estado').value = c.estado;
                document.getElementById('c-notas').value = c.notas || '';
                document.getElementById('modalCita').classList.remove('hidden');
            }
        });
        calendar.render();
    }

    window.guardarCita = async () => {
        const payload = {
            estado: document.getElementById('c-estado').value,
            notas: document.getElementById('c-notas').value
        };
        const { error } = await supabase.from('Citas').update(payload).eq('id', citaActual.id);
        if(!error) { calendar.refetchEvents(); cerrarModal(); }
    };

    window.cerrarModal = () => document.getElementById('modalCita').classList.add('hidden');

    cargarDoctores();
</script>
</body>
</html>
