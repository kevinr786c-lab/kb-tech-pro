<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | RADAR OPERATIVO ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        :root { --main: #6366f1; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; display: flex; min-height: 100vh; overflow: hidden; }
        
        .sidebar { width: 280px; background: #0f172a; border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; }
        .nav-item { padding: 1rem 2rem; display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: 0.3s; font-weight: 600; font-size: 0.85rem; color: #94a3b8; }
        .nav-item:hover, .nav-item.active { background: rgba(99, 102, 241, 0.1); color: white; border-right: 4px solid var(--main); }
        
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border-radius: 2.5rem; border: 1px solid rgba(255,255,255,0.08); }
        .input-kb { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 1.25rem; padding: 1rem; font-weight: 600; font-size: 0.8rem; color: white; transition: 0.3s; width: 100%; }
        .input-kb:focus { border-color: var(--main); outline: none; background: rgba(255,255,255,0.1); }
        
        #calendar { background: transparent; color: white; padding: 20px; }
        .fc { --fc-border-color: rgba(255,255,255,0.05); --fc-today-bg-color: rgba(99, 102, 241, 0.1); }
        .fc-event { border: none !important; padding: 4px; border-radius: 8px !important; font-weight: 800; font-size: 0.7rem; }
        
        .modal-overlay { background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body>

<nav class="sidebar hidden md:flex h-screen sticky top-0">
    <div class="p-8">
        <h1 class="text-2xl font-black italic tracking-tighter uppercase">K.B <span class="text-indigo-400">TECH</span></h1>
        <p class="text-[8px] uppercase tracking-[0.4em] opacity-40 font-bold mt-2">B√∫nker Operativo</p>
    </div>
    
    <div class="mt-4 flex-1">
        <div class="nav-item active" onclick="location.reload()"><span>üìä</span> Radar Global</div>
        <div id="btnConfig" class="nav-item"><span>‚öôÔ∏è</span> Ajustar Nodo</div>
        <div class="nav-item text-rose-500 mt-10" onclick="logout()"><span>üö™</span> Cerrar B√∫nker</div>
    </div>

    <div class="p-8 mt-auto border-t border-white/5">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-indigo-500/20 border border-indigo-500/30 flex items-center justify-center font-bold text-indigo-400" id="userInitial">..</div>
            <div>
                <p class="text-[10px] font-black uppercase tracking-tight" id="userName">Cargando...</p>
                <p class="text-[8px] text-slate-500 uppercase font-bold" id="labelRol">Rango: --</p>
            </div>
        </div>
    </div>
</nav>

<main class="flex-1 overflow-y-auto h-screen p-4 md:p-8">
    <header class="max-w-[1600px] mx-auto mb-8 flex justify-between items-center bg-white/5 border border-white/10 p-8 rounded-[2.5rem] shadow-2xl">
        <div>
            <h1 class="text-3xl font-black italic tracking-tighter uppercase leading-none">Torre de <span class="text-indigo-400">Control</span> ‚ú¶</h1>
            <p class="text-[10px] uppercase tracking-[0.4em] font-bold opacity-50 italic mt-2">Log√≠stica Digital Tijuana / San Diego</p>
        </div>
        <select id="filtroDoctor" class="hidden bg-indigo-600 px-6 py-3 rounded-2xl font-black text-[10px] outline-none cursor-pointer border-none uppercase tracking-widest"></select>
    </header>

    <div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-8">
        <aside class="col-span-12 lg:col-span-3 space-y-6">
            <div class="glass p-8 shadow-xl">
                <h3 class="text-[10px] font-black uppercase text-indigo-400 mb-6 tracking-widest italic">Inyectar Misi√≥n (Cita)</h3>
                <div class="space-y-4">
                    <input id="tel" class="input-kb" placeholder="TEL√âFONO PACIENTE" maxlength="10">
                    <input id="nom" class="input-kb" placeholder="NOMBRE COMPLETO">
                    <select id="doc" class="input-kb hidden"></select> <select id="ser" class="input-kb"></select>
                    <input type="time" id="hor" class="input-kb">
                    <button id="btnAgendar" class="w-full bg-indigo-600 text-white p-5 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-indigo-500 transition-all shadow-lg active:scale-95">Agendar en Radar üì°</button>
                </div>
            </div>

            <div id="panelAcciones" class="glass p-8 hidden border-2 border-indigo-500/20 shadow-2xl">
                <h3 class="text-[10px] font-black uppercase mb-4 text-slate-500 tracking-tighter">Control de Unidad</h3>
                <div id="btnsAccion" class="flex flex-col gap-3"></div>
            </div>
        </aside>

        <section class="col-span-12 lg:col-span-9 glass p-4 shadow-xl min-h-[750px] relative overflow-hidden">
            <div id="calendar"></div>
        </section>
    </div>
</main>

<div id="modalCobro" class="modal-overlay fixed inset-0 z-[999] hidden flex items-center justify-center p-4">
    <div class="glass max-w-sm w-full p-10 bg-[#0f172a] border-indigo-500/30">
        <h2 class="text-2xl font-black italic mb-2 uppercase tracking-tighter">Cierre de <span class="text-indigo-400">Caja</span></h2>
        <p id="infoPago" class="text-[10px] font-bold text-slate-500 mb-8 uppercase tracking-widest"></p>
        <div class="space-y-6">
            <input id="montoPago" type="number" class="input-kb text-3xl font-black text-indigo-400 text-center">
            <select id="metodoPago" class="input-kb font-bold">
                <option value="Efectivo">Efectivo üíµ</option>
                <option value="Tarjeta">Tarjeta üí≥</option>
                <option value="Transferencia">Transferencia üè¶</option>
            </select>
            <div class="flex gap-4">
                <button onclick="cerrarModalCobro()" class="flex-1 p-4 rounded-2xl font-bold text-[10px] uppercase bg-white/5 hover:bg-white/10">Cancelar</button>
                <button id="btnConfirmarPago" class="flex-1 p-4 rounded-2xl font-black text-[10px] uppercase bg-emerald-600 text-white shadow-lg">Finalizar üí∞</button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="fixed bottom-6 right-6 hidden bg-white text-slate-900 px-6 py-4 rounded-2xl shadow-2xl text-[10px] font-black uppercase tracking-widest border border-indigo-500 z-[10000]"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

// üéí CARGAR MOCHILA
const currentUserId = localStorage.getItem('user_id');
const rolUsuario = localStorage.getItem('rol');
const nombreUsuario = localStorage.getItem('nombre_usuario');

if(!currentUserId) window.location.href = 'index.html';

document.getElementById('userName').innerText = nombreUsuario;
document.getElementById('labelRol').innerText = `RANGO: ${rolUsuario.toUpperCase()}`;
document.getElementById('userInitial').innerText = nombreUsuario.slice(0,2).toUpperCase();

window.logout = () => { localStorage.clear(); window.location.href = 'index.html'; };
document.getElementById('btnConfig').onclick = () => window.location.href = `configurar-perfil.html?id=${currentUserId}`;

function toast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 3000);
}

let calendar, citaActiva = null;

async function initCalendar() {
    calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        locale: 'es', initialView: 'timeGridDay', slotMinTime: '07:00', slotMaxTime: '21:00',
        editable: true, nowIndicator: true, allDaySlot: false,
        events: async (info, success) => {
            // SEGURIDAD: Si es Doctor, solo ve lo suyo. Si es Admin, ve todo o por filtro.
            let query = supabase.from('Citas').select('*, Pacientes(nombre, telefono), Servicios(nombre, precio)');
            
            if(rolUsuario === 'doctor') {
                query = query.eq('doctor_id', currentUserId);
            } else if(filtroDoctor.value && filtroDoctor.value !== 'all') {
                query = query.eq('doctor_id', filtroDoctor.value);
            }
            
            const { data } = await query;
            success(data.map(c => ({
                id: c.id, title: `${c.Pacientes.nombre} ‚Äî ${c.Servicios.nombre}`,
                start: `${c.fecha}T${c.hora_inicio}`,
                end: new Date(new Date(`${c.fecha}T${c.hora_inicio}`).getTime() + c.duracion_total * 60000),
                backgroundColor: colorEstado(c.estado), extendedProps: c
            })));
        },
        eventClick: (info) => {
            citaActiva = info.event.extendedProps;
            mostrarPanelAcciones(citaActiva);
        }
    });
    calendar.render();
}

function colorEstado(e) {
    return { pendiente:'#f59e0b', confirmado:'#0ea5e9', atendiendo:'#6366f1', completado:'#10b981', cancelado:'#ef4444' }[e] || '#94a3b8';
}

async function initUI() {
    // Manejo de Doctores para el Admin
    if(rolUsuario === 'admin') {
        const { data: docs } = await supabase.from('Usuarios').select('id, nombre').eq('rol', 'doctor');
        const selector = document.getElementById('filtroDoctor');
        selector.classList.remove('hidden');
        selector.innerHTML = '<option value="all">TODOS LOS DOCTORES</option>' + 
                            docs.map(d => `<option value="${d.id}">${d.nombre.toUpperCase()}</option>`).join('');
        selector.onchange = () => calendar.refetchEvents();
    }

    // Cargar Servicios del Nodo Actual
    const { data: servs } = await supabase.from('Servicios').select('*').eq('doctor_id', currentUserId).eq('activo', true);
    document.getElementById('ser').innerHTML = servs.map(s => `<option value="${s.id}" data-d="${s.duracion_total}" data-p="${s.precio}">${s.nombre} ($${s.precio})</option>`).join('');

    // Registro de Cita
    document.getElementById('btnAgendar').onclick = async () => {
        const telVal = document.getElementById('tel').value;
        const nomVal = document.getElementById('nom').value;
        const horVal = document.getElementById('hor').value;
        const servSel = document.getElementById('ser').selectedOptions[0];

        if(!telVal || !nomVal || !horVal) return toast('‚ö†Ô∏è DATOS INCOMPLETOS');

        let { data: pac } = await supabase.from('Pacientes').select('id').eq('telefono', telVal).maybeSingle();
        if(!pac) pac = (await supabase.from('Pacientes').insert({ nombre: nomVal, telefono: telVal }).select().single()).data;

        await supabase.from('Citas').insert({
            doctor_id: currentUserId, paciente_id: pac.id, servicio_id: document.getElementById('ser').value,
            fecha: calendar.getDate().toISOString().slice(0, 10), hora_inicio: horVal,
            duracion_total: Number(servSel.dataset.d), monto: Number(servSel.dataset.p), estado: 'pendiente'
        });

        calendar.refetchEvents();
        toast('üöÄ CITA EN RADAR');
    };
}

function mostrarPanelAcciones(c) {
    const panel = document.getElementById('panelAcciones');
    panel.classList.remove('hidden');
    document.getElementById('btnsAccion').innerHTML = `
        <button onclick="updateStatus('atendiendo')" class="bg-indigo-600 text-white p-4 rounded-2xl text-[10px] font-black uppercase">Atender Paciente ‚ö°</button>
        <button onclick="abrirModalCobro()" class="bg-emerald-600 text-white p-4 rounded-2xl text-[10px] font-black uppercase font-black">Finalizar y Cobrar üí∞</button>
        <button onclick="window.open('https://wa.me/52${c.Pacientes.telefono}')" class="bg-white/10 text-white p-4 rounded-2xl text-[10px] font-black uppercase">WhatsApp üì±</button>
    `;
}

window.updateStatus = async (st) => {
    await supabase.from('Citas').update({ estado: st }).eq('id', citaActiva.id);
    calendar.refetchEvents();
    document.getElementById('panelAcciones').classList.add('hidden');
};

window.abrirModalCobro = () => {
    document.getElementById('modalCobro').classList.remove('hidden');
    document.getElementById('infoPago').innerText = `Paciente: ${citaActiva.Pacientes.nombre}`;
    document.getElementById('montoPago').value = citaActiva.monto;
};

window.cerrarModalCobro = () => document.getElementById('modalCobro').classList.add('hidden');

document.getElementById('btnConfirmarPago').onclick = async () => {
    await supabase.from('Pagos').insert({ cita_id: citaActiva.id, monto: Number(document.getElementById('montoPago').value), metodo: document.getElementById('metodoPago').value });
    await supabase.from('Citas').update({ estado: 'completado', pagado: true }).eq('id', citaActiva.id);
    toast('üí∞ CAJA CERRADA EXITOSAMENTE');
    cerrarModalCobro();
    calendar.refetchEvents();
};

initCalendar();
initUI();
</script>
</body>
</html>
