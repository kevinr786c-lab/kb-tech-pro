<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>K.B SYSTEM | CONTROL ELITE ðŸ“¡</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
:root { --main:#6366f1; }

body{
    font-family:'Plus Jakarta Sans',sans-serif;
    background:#f1f5f9;
    color:#1e293b;
}

.glass{
    background:rgba(255,255,255,.9);
    backdrop-filter:blur(18px);
    border-radius:2rem;
    border:1px solid rgba(0,0,0,.05);
}

.input{
    background:#f8fafc;
    padding:1rem;
    border-radius:1.25rem;
    width:100%;
    font-weight:600;
    border:2px solid transparent;
}
.input:focus{
    outline:none;
    border-color:var(--main);
    background:white;
}

.fc-event{
    border:none!important;
    border-radius:10px!important;
    padding:4px;
    font-size:.75rem;
    cursor:pointer;
}
</style>
</head>

<body class="p-6">

<!-- HEADER -->
<header class="max-w-[1600px] mx-auto mb-6 flex justify-between items-center bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-2xl">
    <div>
        <h1 class="text-4xl font-black italic">K.B <span class="text-indigo-400">COMMAND</span> âœ¦</h1>
        <p class="text-[10px] uppercase tracking-[.4em] opacity-50">Control de Citas Profesionales</p>
    </div>

    <div class="flex items-center gap-4">
        <select id="filtroDoctor" class="bg-indigo-600 px-4 py-2 rounded-xl text-xs font-black uppercase"></select>
    </div>
</header>

<main class="max-w-[1600px] mx-auto grid grid-cols-12 gap-8">

<!-- FORM -->
<aside class="col-span-12 lg:col-span-3 space-y-6">
<div class="glass p-8 shadow-xl">
<h3 class="text-[10px] font-black uppercase tracking-widest text-indigo-600 mb-6">Nueva Cita</h3>

<input id="tel" class="input mb-3" placeholder="TelÃ©fono">
<input id="nom" class="input mb-3" placeholder="Paciente">

<select id="doc" class="input mb-3"></select>
<select id="ser" class="input mb-3"></select>

<input type="time" id="hor" class="input mb-4">

<button id="btnAgendar"
class="w-full bg-indigo-600 text-white py-4 rounded-xl font-black uppercase text-xs hover:bg-indigo-700">
Agendar ðŸ“¡
</button>
</div>

<div id="panel" class="glass p-6 hidden shadow-xl">
<h4 class="text-xs font-black uppercase mb-4">Acciones</h4>
<div id="panelBtns" class="space-y-2"></div>
</div>
</aside>

<!-- CALENDAR -->
<section class="col-span-12 lg:col-span-9 glass p-6 shadow-xl min-h-[800px]">
<div id="calendar"></div>
</section>

</main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

/* =======================
   SUPABASE
======================= */
const supabase = createClient(
 'https://ctvqjnckxmqeejbfwmkj.supabase.co',
 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w'
);

/* =======================
   DB
======================= */
const db = {
    pacientes: tel =>
        supabase.from('Pacientes').select('*').eq('telefono', tel).maybeSingle(),

    crearPaciente:(n,t)=>
        supabase.from('Pacientes').insert({nombre:n,telefono:t}).select().single(),

    doctores:()=>
        supabase.from('Perfiles_Medicos').select('id,especialidad,Usuarios(nombre)'),

    servicios:id=>
        supabase.from('Servicios').select('*').eq('doctor_id',id).eq('activo',true),

    citas:(doc)=>
        supabase.from('Citas')
        .select('*,Pacientes(nombre,telefono),Servicios(nombre)')
        .eq(doc?'doctor_id':'id',doc||1),

    mover:(id,f,h)=>
        supabase.from('Citas').update({fecha:f,hora_inicio:h}).eq('id',id),

    estado:(id,e)=>
        supabase.from('Citas').update({estado:e}).eq('id',id)
};

/* =======================
   CALENDAR
======================= */
let calendar, selectedId=null;

function color(e){
    return {pendiente:'#f59e0b',atendiendo:'#6366f1',completado:'#10b981'}[e]||'#94a3b8';
}

function initCalendar(){
calendar = new FullCalendar.Calendar(calendarEl,{
    locale:'es',
    initialView:'timeGridDay',
    editable:true,
    slotMinTime:'07:00',
    slotMaxTime:'21:00',
    headerToolbar:{left:'prev,next today',center:'title',right:'timeGridDay,timeGridWeek'},

    events:async(_,ok)=>{
        const {data}=await db.citas(filtroDoctor.value);
        ok(data.map(c=>({
            id:c.id,
            title:`${c.Pacientes.nombre} â€” ${c.Servicios.nombre}`,
            start:`${c.fecha}T${c.hora_inicio}`,
            end:new Date(new Date(`${c.fecha}T${c.hora_inicio}`).getTime()+c.duracion_total*60000),
            backgroundColor:color(c.estado),
            extendedProps:{tel:c.Pacientes.telefono}
        })));
    },

    eventDrop:async i=>{
        await db.mover(i.event.id,i.event.startStr.slice(0,10),i.event.startStr.slice(11,16));
    },

    eventClick:i=>{
        selectedId=i.event.id;
        abrirPanel(i.event);
    }
});
calendar.render();
}

/* =======================
   UI
======================= */
async function initUI(){
const {data}=await db.doctores();
doc.innerHTML=data.map(d=>`<option value="${d.id}">${d.Usuarios.nombre}</option>`).join('');
filtroDoctor.innerHTML=`<option value="">Todos</option>`+doc.innerHTML;

doc.onchange=()=>loadServicios(doc.value);
filtroDoctor.onchange=()=>calendar.refetchEvents();
await loadServicios(doc.value);

tel.oninput=async()=>{
if(tel.value.length===10){
const {data:p}=await db.pacientes(tel.value);
if(p){nom.value=p.nombre;nom.classList.add('bg-green-50')}
}else nom.classList.remove('bg-green-50');
};

btnAgendar.onclick=agendar;
}

async function loadServicios(id){
const {data}=await db.servicios(id);
ser.innerHTML=data.map(s=>`<option value="${s.id}" data-d="${s.duracion_total}">${s.nombre}</option>`).join('');
}

async function agendar(){
if(!tel.value||!nom.value||!hor.value)return alert('Datos incompletos');

let {data:p}=await db.pacientes(tel.value);
if(!p)p=(await db.crearPaciente(nom.value,tel.value)).data;

await supabase.from('Citas').insert({
doctor_id:doc.value,
paciente_id:p.id,
servicio_id:ser.value,
fecha:calendar.getDate().toISOString().slice(0,10),
hora_inicio:hor.value,
duracion_total:+ser.selectedOptions[0].dataset.d,
estado:'pendiente'
});

calendar.refetchEvents();
}

function abrirPanel(e){
panel.classList.remove('hidden');
panelBtns.innerHTML=`
<button onclick="setEstado('atendiendo')" class="w-full bg-indigo-600 text-white p-3 rounded-xl text-xs font-black">LlegÃ³</button>
<button onclick="setEstado('completado')" class="w-full bg-emerald-500 text-white p-3 rounded-xl text-xs font-black">Finalizar</button>
`;
}

window.setEstado=async e=>{
await db.estado(selectedId,e);
calendar.refetchEvents();
panel.classList.add('hidden');
};

/* =======================
   INIT
======================= */
const calendarEl=document.getElementById('calendar');
initCalendar();
initUI();
</script>
</body>
</html>
