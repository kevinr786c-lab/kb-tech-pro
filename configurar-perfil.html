<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONFIGURACI√ìN | K.B TECH ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.08); border-radius: 2.5rem; }
        .input-kb { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; padding: 0.75rem; font-weight: 700; color: white; transition: 0.3s; }
        .input-kb:focus { border-color: #6366f1; outline: none; background: rgba(255,255,255,0.1); }
        .btn-action { transition: 0.4s; font-weight: 800; letter-spacing: 0.1em; border-radius: 1.25rem; }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <div class="max-w-6xl w-full glass p-8 md:p-12 shadow-2xl border-b-4 border-indigo-500/50 relative overflow-hidden">
        <div class="absolute -top-24 -right-24 w-64 h-64 bg-indigo-600/10 blur-[100px] rounded-full"></div>
        
        <header class="mb-12 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div>
                <h1 class="text-4xl font-black italic uppercase tracking-tighter">Nodo de <span class="text-indigo-400">Control</span> ‚ú¶</h1>
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.5em] mt-2 italic">K.B Tech Solution ‚Äî Binational Logistics</p>
            </div>
            <button onclick="window.location.href='asistente.html'" class="btn-action bg-white/5 border border-white/10 px-8 py-3 text-[10px] font-black uppercase hover:bg-white/10">Regresar al Radar üõ∞Ô∏è</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <section class="lg:col-span-1 space-y-6">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div>
                    <h3 class="text-[10px] font-black uppercase text-indigo-400 tracking-widest italic">Patr√≥n Semanal</h3>
                </div>
                <div id="contenedor-semana" class="space-y-2 bg-white/5 p-4 rounded-[2rem] border border-white/5"></div>
                <button id="btnGuardarSemana" class="w-full btn-action bg-indigo-600 p-5 rounded-2xl text-[10px] uppercase shadow-lg shadow-indigo-900/20">Sincronizar Reloj ‚ö°</button>
            </section>

            <section class="space-y-6">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-2 h-2 bg-rose-500 rounded-full"></div>
                    <h3 class="text-[10px] font-black uppercase text-rose-400 tracking-widest italic">Zonas de Exclusi√≥n</h3>
                </div>
                <div class="glass p-6 border-rose-500/10 bg-rose-500/5">
                    <div class="flex flex-col gap-4 mb-6">
                        <input type="date" id="fecha-bloqueo" class="input-kb text-xs w-full">
                        <button id="btnBloquear" class="btn-action bg-rose-600 p-4 text-[9px] uppercase font-black">Bloquear Fecha</button>
                    </div>
                    <div id="lista-bloqueos" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
                </div>
            </section>

            <section class="space-y-6">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-amber-500 rounded-full"></div>
                        <h3 class="text-[10px] font-black uppercase text-amber-400 tracking-widest italic">Cat√°logo de Activos</h3>
                    </div>
                    <button id="btnAddSrv" class="bg-amber-500/20 text-amber-400 text-[8px] font-black px-4 py-2 rounded-full border border-amber-500/30 hover:bg-amber-500 hover:text-white transition">+ NUEVO</button>
                </div>
                <div class="glass p-6 border-amber-500/10 bg-amber-500/5 min-h-[300px] flex flex-col">
                    <div id="lista-servicios" class="space-y-3 flex-1"></div>
                    <button id="btnGuardarSrv" class="w-full btn-action bg-amber-500 p-5 rounded-2xl text-[10px] font-black uppercase mt-6 text-slate-900">Actualizar Precios üíé</button>
                </div>
            </section>

        </div>
    </div>

<div id="toast" class="fixed bottom-10 right-10 hidden bg-white text-slate-900 px-8 py-4 rounded-2xl shadow-2xl text-[10px] font-black uppercase tracking-widest border-l-8 border-indigo-500 z-[1000]"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

// üß¨ IDENTIDAD DEL NODO
const docId = localStorage.getItem('user_id');
if(!docId) window.location.href = 'index.html';

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 3000);
}

/* --- L√ìGICA DE HORARIOS --- */
async function cargarSemana() {
    const { data } = await supabase.from('Horarios_Doctor').select('*').eq('doctor_id', docId).order('dia_semana');
    const diasStr = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
    document.getElementById('contenedor-semana').innerHTML = diasStr.map((nombre, i) => {
        const config = data?.find(h => h.dia_semana === i+1) || { activo: false, hora_inicio: '09:00', hora_fin: '17:00' };
        return `
            <div class="flex items-center gap-4 p-4 bg-white/5 rounded-2xl border border-white/5 dia-row group hover:bg-white/10 transition" data-dia="${i+1}">
                <input type="checkbox" class="chk-activo w-4 h-4 rounded border-white/10 accent-indigo-500" ${config.activo ? 'checked' : ''}>
                <p class="text-[10px] font-black uppercase w-12 text-slate-500 group-hover:text-indigo-400 transition">${nombre.slice(0,3)}</p>
                <input type="time" class="bg-transparent text-[11px] font-bold h-ini outline-none text-white/80" value="${config.hora_inicio.slice(0,5)}">
                <span class="text-slate-700 font-bold">-</span>
                <input type="time" class="bg-transparent text-[11px] font-bold h-fin outline-none text-white/80" value="${config.hora_fin.slice(0,5)}">
            </div>
        `;
    }).join('');
}

document.getElementById('btnGuardarSemana').onclick = async () => {
    const btn = document.getElementById('btnGuardarSemana');
    btn.innerText = "SINCRONIZANDO...";
    const filas = document.querySelectorAll('.dia-row');
    for (let f of filas) {
        const rowData = {
            doctor_id: docId,
            dia_semana: parseInt(f.dataset.dia),
            hora_inicio: f.querySelector('.h-ini').value + ":00",
            hora_fin: f.querySelector('.h-fin').value + ":00",
            activo: f.querySelector('.chk-activo').checked
        };
        await supabase.from('Horarios_Doctor').upsert(rowData, { onConflict: 'doctor_id, dia_semana' });
    }
    btn.innerText = "RELOJ SINCRONIZADO ‚úÖ";
    setTimeout(() => btn.innerText = "Sincronizar Reloj ‚ö°", 2000);
    showToast('üìÖ HORARIOS ACTUALIZADOS');
};

/* --- L√ìGICA DE BLOQUEOS --- */
async function cargarBloqueos() {
    const { data } = await supabase.from('Bloqueos').select('*').eq('doctor_id', docId).gte('fecha', new Date().toISOString().slice(0,10));
    document.getElementById('lista-bloqueos').innerHTML = data ? data.map(b => `
        <div class="flex justify-between items-center bg-rose-500/5 p-4 rounded-xl border border-rose-500/10 group">
            <span class="text-[11px] font-black text-rose-400 italic tracking-wider">${b.fecha}</span>
            <button onclick="window.borrarBloqueo('${b.id}')" class="text-rose-500 hover:scale-125 transition">‚úï</button>
        </div>
    `).join('') : '';
}

document.getElementById('btnBloquear').onclick = async () => {
    const f = document.getElementById('fecha-bloqueo').value;
    if(!f) return;
    await supabase.from('Bloqueos').insert({ doctor_id: docId, fecha: f, motivo: 'Bloqueo Manual' });
    document.getElementById('fecha-bloqueo').value = '';
    cargarBloqueos();
    showToast('üèñÔ∏è FECHA BLOQUEADA');
};

window.borrarBloqueo = async (id) => {
    await supabase.from('Bloqueos').delete().eq('id', id);
    cargarBloqueos();
};

/* --- L√ìGICA DE SERVICIOS --- */
async function cargarServicios() {
    const { data } = await supabase.from('Servicios').select('*').eq('doctor_id', docId);
    document.getElementById('lista-servicios').innerHTML = '';
    if(data) data.forEach(s => agregarFilaServicio(s.nombre, s.precio, s.duracion_total));
}

function agregarFilaServicio(nombre = '', precio = '', duracion = 30) {
    const div = document.createElement('div');
    div.className = "flex flex-col gap-2 p-4 bg-white/5 rounded-2xl border border-white/5 srv-item group hover:border-amber-500/30 transition";
    div.innerHTML = `
        <div class="flex justify-between items-center">
            <input type="text" placeholder="NOMBRE SERVICIO" class="bg-transparent text-[10px] font-black srv-n outline-none text-white w-full uppercase" value="${nombre}">
            <button onclick="this.parentElement.parentElement.remove()" class="text-rose-500 opacity-0 group-hover:opacity-100 transition">‚úï</button>
        </div>
        <div class="flex gap-4 mt-2">
            <div class="flex items-center gap-2 bg-black/20 p-2 rounded-lg">
                <span class="text-[8px] font-bold text-amber-500">$</span>
                <input type="number" class="bg-transparent w-16 text-[11px] font-black srv-p outline-none" value="${precio}">
            </div>
            <div class="flex items-center gap-2 bg-black/20 p-2 rounded-lg">
                <span class="text-[8px] font-bold text-indigo-400">MIN</span>
                <input type="number" class="bg-transparent w-12 text-[11px] font-black srv-d outline-none" value="${duracion}">
            </div>
        </div>
    `;
    document.getElementById('lista-servicios').appendChild(div);
}

document.getElementById('btnAddSrv').onclick = () => agregarFilaServicio();

document.getElementById('btnGuardarSrv').onclick = async () => {
    const items = document.querySelectorAll('.srv-item');
    const batch = Array.from(items).map(i => ({
        doctor_id: docId,
        nombre: i.querySelector('.srv-n').value,
        precio: parseFloat(i.querySelector('.srv-p').value) || 0,
        duracion_total: parseInt(i.querySelector('.srv-d').value) || 30,
        activo: true
    }));
    await supabase.from('Servicios').delete().eq('doctor_id', docId);
    if(batch.length > 0) await supabase.from('Servicios').insert(batch);
    showToast('üí∞ CAT√ÅLOGO SINCRONIZADO');
};

cargarSemana(); cargarBloqueos(); cargarServicios();
</script>
</body>
</html>
