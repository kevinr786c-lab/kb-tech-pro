<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Configuraci√≥n Maestra</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 p-6">
<div class="max-w-5xl mx-auto space-y-6">

<h1 class="text-2xl font-black">Configuraci√≥n Maestra</h1>

<!-- HORARIOS -->
<section class="bg-white p-4 rounded-xl space-y-3">
<h3 class="font-bold">Horarios</h3>
<div id="semana" class="space-y-2"></div>
<button id="guardarHorarios" class="bg-black text-white px-4 py-2 rounded">Guardar</button>
</section>

<!-- BLOQUEOS -->
<section class="bg-white p-4 rounded-xl space-y-3">
<h3 class="font-bold text-red-600">Bloqueos</h3>
<input type="date" id="bFecha" class="border p-2 rounded w-full">
<div class="flex gap-2">
<input type="time" id="bIni" class="border p-2 rounded w-full">
<input type="time" id="bFin" class="border p-2 rounded w-full">
</div>
<button id="addBloqueo" class="bg-red-600 text-white px-4 py-2 rounded">Bloquear</button>
<div id="listaBloqueos" class="space-y-2"></div>
</section>

<!-- SERVICIOS -->
<section class="bg-white p-4 rounded-xl space-y-3">
<h3 class="font-bold">Servicios</h3>
<div id="servicios" class="space-y-2"></div>
<button id="addServicio" class="border px-4 py-2 rounded">+ Servicio</button>
<button id="guardarServicios" class="bg-black text-white px-4 py-2 rounded">Guardar</button>
</section>

</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://TU_PROYECTO.supabase.co',
  'TU_PUBLIC_ANON_KEY'
)

// üîë ESTE DEBE SER Usuarios.id
const doctorId = 'UUID_DEL_DOCTOR'

const dias = ['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo']

// ---------------- HORARIOS ----------------
async function cargarHorarios(){
  const { data } = await supabase
    .from('Horarios_Doctor')
    .select('*')
    .eq('doctor_id', doctorId)

  semana.innerHTML = dias.map((d,i)=>{
    const h = data?.find(x=>x.dia_semana===i+1) || {}
    return `
    <div class="flex gap-2">
      <label class="w-24">${d}</label>
      <input type="time" value="${h.hora_inicio||'09:00'}" data-dia="${i+1}" class="ini border p-1">
      <input type="time" value="${h.hora_fin||'17:00'}" class="fin border p-1">
    </div>`
  }).join('')
}

guardarHorarios.onclick = async ()=>{
  await supabase.from('Horarios_Doctor').delete().eq('doctor_id', doctorId)

  document.querySelectorAll('.ini').forEach(async (i)=>{
    await supabase.from('Horarios_Doctor').insert({
      doctor_id: doctorId,
      dia_semana: i.dataset.dia,
      hora_inicio: i.value,
      hora_fin: i.parentNode.querySelector('.fin').value
    })
  })
  alert('Horarios guardados')
}

// ---------------- BLOQUEOS ----------------
async function cargarBloqueos(){
  const { data } = await supabase
    .from('Bloqueos')
    .select('*')
    .eq('doctor_id', doctorId)

  listaBloqueos.innerHTML = data?.map(b=>`
    <div class="flex justify-between bg-red-50 p-2 rounded">
      <span>${b.fecha}</span>
      <button onclick="delBloqueo('${b.id}')">‚úï</button>
    </div>`).join('')
}

addBloqueo.onclick = async ()=>{
  await supabase.from('Bloqueos').insert({
    doctor_id: doctorId,
    fecha: bFecha.value,
    hora_inicio: bIni.value,
    hora_fin: bFin.value
  })
  cargarBloqueos()
}

window.delBloqueo = async id =>{
  await supabase.from('Bloqueos').delete().eq('id', id)
  cargarBloqueos()
}

// ---------------- SERVICIOS ----------------
function renderServicio(s={}){
  servicios.innerHTML += `
  <div class="flex gap-2">
    <input placeholder="Nombre" value="${s.nombre||''}" class="n border p-1">
    <input type="number" value="${s.duracion_min||30}" class="d border p-1 w-20">
    <input type="number" value="${s.precio||0}" class="p border p-1 w-20">
  </div>`
}

addServicio.onclick = ()=>renderServicio()

guardarServicios.onclick = async ()=>{
  document.querySelectorAll('#servicios > div').forEach(async s=>{
    await supabase.from('Servicios').insert({
      doctor_id: doctorId,
      nombre: s.querySelector('.n').value,
      duracion_min: s.querySelector('.d').value,
      precio: s.querySelector('.p').value
    })
  })
  alert('Servicios guardados')
}

// INIT
cargarHorarios()
cargarBloqueos()
</script>
</body>
</html>
