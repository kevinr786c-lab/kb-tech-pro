<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CONFIGURACI√ìN | K.B SYSTEM ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; color: #111827; }
        .card-white { background: #ffffff; border-radius: 1.5rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .input-clean { width: 100%; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid #d1d5db; background: #fff; font-size: 14px; outline: none; }
        .input-clean:focus { border-color: #111827; ring: 1px; ring-color: #111827; }
        .btn-black { background: #111827; color: white; border-radius: 0.75rem; font-weight: 700; transition: 0.3s; width: 100%; padding: 1rem; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
        .btn-black:hover { background: #374151; }
        /* Scrollbar suave para servicios */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto space-y-8">
        <header class="flex justify-between items-center bg-white p-6 card-white">
            <div>
                <h1 class="text-xl font-extrabold uppercase tracking-tight">Configuraci√≥n <span class="text-gray-400">Maestra</span></h1>
                <p id="doc-id-label" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1 italic">Sincronizando Jurisdicci√≥n...</p>
            </div>
            <button onclick="window.location.href='asistente.html'" class="text-[10px] font-black uppercase text-gray-400 hover:text-black transition">‚Üê Radar</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <section class="card-white p-6 space-y-6">
                <h3 class="text-xs font-black uppercase text-gray-900 border-l-4 border-gray-900 pl-3">Horarios Base</h3>
                <div id="contenedor-semana" class="space-y-3"></div>
                <button id="btnGuardarSemana" class="btn-black">Actualizar Horarios</button>
            </section>

            <section class="card-white p-6 space-y-6">
                <h3 class="text-xs font-black uppercase text-red-600 border-l-4 border-red-600 pl-3">Cierres de B√∫nker</h3>
                <div class="space-y-4">
                    <input type="date" id="b-fecha" class="input-clean uppercase">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="time" id="b-inicio" class="input-clean text-xs" value="00:00">
                        <input type="time" id="b-fin" class="input-clean text-xs" value="23:59">
                    </div>
                    <input type="text" id="b-motivo" placeholder="Motivo (Vacaciones/Congreso)" class="input-clean uppercase text-[10px]">
                    <button id="btnBloquear" class="btn-black !bg-red-600">Inyectar Bloqueo</button>
                </div>
                <div id="lista-bloqueos" class="space-y-2 max-h-40 overflow-y-auto custom-scroll pr-2"></div>
            </section>

            <section class="card-white p-6 space-y-6">
                <h3 class="text-xs font-black uppercase text-gray-900 border-l-4 border-gray-900 pl-3">Servicios y Tiempos</h3>
                <div id="lista-servicios" class="space-y-4 max-h-80 overflow-y-auto custom-scroll pr-2"></div>
                <div class="space-y-2">
                    <button id="btnAddSrv" class="w-full py-3 border border-dashed border-gray-300 rounded-xl text-[10px] font-bold text-gray-400 hover:bg-gray-50 transition">+ Nuevo Nodo</button>
                    <button id="btnGuardarSrv" class="btn-black">Sincronizar Cat√°logo</button>
                </div>
            </section>
        </div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://ctvqjnckxmqeejbfwmkj.supabase.co', 'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w');

    // üõ°Ô∏è DETECCI√ìN DIN√ÅMICA DE ID
    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('docId');

    if (!docId) {
        alert("ALERTA: Acceso sin ID de Doctor.");
        window.location.href = 'asistente.html';
    }

    async function init() {
        const { data: doc } = await supabase.from('Usuarios').select('nombre').eq('id', docId).single();
        if(doc) document.getElementById('doc-id-label').innerText = `IDENTIDAD: DR. ${doc.nombre.toUpperCase()}`;
        cargarSemana(); cargarBloqueos(); cargarServicios();
    }

    // --- üß¨ L√ìGICA HORARIOS (FIX ERROR 400) ---
    async function cargarSemana() {
        const { data } = await supabase.from('Horarios_Doctor').select('*').eq('doctor_id', docId);
        const dias = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
        document.getElementById('contenedor-semana').innerHTML = dias.map((d,i)=>{
            const c = data?.find(h=>h.dia_semana===i+1) || {activo:false, hora_inicio:"09:00", hora_fin:"17:00"};
            return `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100">
                <div class="flex items-center gap-3">
                    <input type="checkbox" class="chk w-4 h-4 accent-black" ${c.activo?'checked':''} data-dia="${i+1}">
                    <span class="text-[10px] font-bold uppercase ${c.activo?'text-black':'text-gray-400'}">${d}</span>
                </div>
                <div class="flex gap-1">
                    <input type="time" value="${c.hora_inicio.slice(0,5)}" class="ini bg-transparent border-none text-[10px] font-bold outline-none">
                    <input type="time" value="${c.hora_fin.slice(0,5)}" class="fin bg-transparent border-none text-[10px] font-bold outline-none">
                </div>
            </div>`;
        }).join('');
    }

    document.getElementById('btnGuardarSemana').onclick = async () => {
        const filas = document.querySelectorAll('#contenedor-semana > div');
        for(const f of filas){
            const chk = f.querySelector('.chk');
            // BLINDAJE: Enviamos datos limpios para evitar el Error 400
            await supabase.from('Horarios_Doctor').upsert({
                doctor_id: docId, 
                dia_semana: parseInt(chk.dataset.dia),
                hora_inicio: f.querySelector('.ini').value + ":00",
                hora_fin: f.querySelector('.fin').value + ":00", 
                activo: chk.checked
            }, { onConflict: 'doctor_id,dia_semana' });
        }
        alert("‚ú¶ HORARIOS SINCRONIZADOS");
        cargarSemana();
    };

    // --- üö´ L√ìGICA BLOQUEOS (FIX ERROR 409) ---
    async function cargarBloqueos() {
        const { data } = await supabase.from('Bloqueos').select('*').eq('doctor_id', docId).gte('fecha', new Date().toISOString().slice(0, 10));
        document.getElementById('lista-bloqueos').innerHTML = data?.map(b => `
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-gray-900">${b.fecha}</span>
                    <span class="text-[8px] text-gray-400 uppercase font-bold">${b.motivo || 'CERRADO'}</span>
                </div>
                <button onclick="borrarB('${b.id}')" class="text-gray-400 hover:text-red-500">‚úï</button>
            </div>
        `).join('') || '';
    }

    document.getElementById('btnBloquear').onclick = async () => {
        const fecha = document.getElementById('b-fecha').value;
        if(!fecha) return;
        
        // FIX 409: Primero borramos cualquier bloqueo existente en esa fecha para ese doctor
        await supabase.from('Bloqueos').delete().eq('doctor_id', docId).eq('fecha', fecha);

        await supabase.from('Bloqueos').insert({
            doctor_id: docId, 
            fecha: fecha,
            hora_inicio: document.getElementById('b-inicio').value + ":00",
            hora_fin: document.getElementById('b-fin').value + ":00",
            motivo: document.getElementById('b-motivo').value.toUpperCase()
        });
        cargarBloqueos();
    };

    window.borrarB = async (id) => { await supabase.from('Bloqueos').delete().eq('id', id); cargarBloqueos(); };

    // --- üíé L√ìGICA SERVICIOS (USA CROQUIS) ---
    async function cargarServicios() {
        const { data } = await supabase.from('Servicios').select('*').eq('doctor_id', docId).eq('activo', true);
        document.getElementById('lista-servicios').innerHTML = '';
        data?.forEach(s => renderServicio(s));
    }

    function renderServicio(s = {}) {
        const div = document.createElement('div');
        div.className = "srv-card bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-3";
        div.dataset.id = s.id || '';
        div.innerHTML = `
            <input type="text" class="nombre input-clean !p-2 text-[10px] font-bold uppercase" value="${s.nombre || ''}" placeholder="SERVICIO">
            <div class="grid grid-cols-3 gap-2">
                <div><label class="text-[7px] text-gray-400 ml-2 font-bold uppercase">Precio</label><input type="number" class="precio input-clean !p-2 text-xs" value="${s.precio || 0}"></div>
                <div><label class="text-[7px] text-gray-400 ml-2 font-bold uppercase">Cita</label><input type="number" class="dur input-clean !p-2 text-xs" value="${s.duracion_min || 30}"></div>
                <div><label class="text-[7px] text-gray-400 ml-2 font-bold uppercase">Espacio</label><input type="number" class="buf input-clean !p-2 text-xs" value="${s.buffer_min || 0}"></div>
            </div>
            <p class="text-[7px] text-right text-gray-400 italic uppercase">Total en Agenda: <span class="font-bold text-black">${(s.duracion_min || 0) + (s.buffer_min || 0)}</span> MIN</p>
        `;
        document.getElementById('lista-servicios').appendChild(div);
    }

    document.getElementById('btnGuardarSrv').onclick = async () => {
        const cards = document.querySelectorAll('.srv-card');
        for (const card of cards) {
            const d = parseInt(card.querySelector('.dur').value) || 0;
            const b = parseInt(card.querySelector('.buf').value) || 0;
            const payload = {
                doctor_id: docId,
                nombre: card.querySelector('.nombre').value.toUpperCase(),
                precio: parseFloat(card.querySelector('.precio').value) || 0,
                duracion_min: d,
                buffer_min: b,
                activo: true
            };
            const id = card.dataset.id;
            if (id) payload.id = id;
            await supabase.from('Servicios').upsert(payload);
        }
        alert("‚ú¶ CAT√ÅLOGO SINCRONIZADO");
        cargarServicios();
    }

    document.getElementById('btnAddSrv').onclick = () => renderServicio();
    init();
</script>
</body>
</html>
