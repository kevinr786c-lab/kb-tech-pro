<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K.B SYSTEM | CONFIGURACI√ìN PRO ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .card-elite { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .input-kb { width: 100%; padding: 0.75rem; border-radius: 0.8rem; border: 1px solid #cbd5e1; outline: none; font-size: 16px; transition: 0.2s; }
        .input-kb:focus { border-color: #0f172a; ring: 2px; ring-color: #f1f5f9; }
        .btn-black { background: #0f172a; color: white; padding: 1rem; border-radius: 1rem; font-weight: 800; text-transform: uppercase; width: 100%; transition: 0.3s; font-size: 11px; letter-spacing: 1px; }
        .btn-black:hover { background: #334155; transform: translateY(-1px); }
        .btn-black:active { transform: scale(0.98); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-6xl mx-auto space-y-6">
        <header class="card-elite p-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-xl font-black uppercase tracking-tighter italic text-slate-900">Terminal de <span class="text-[#c5a059]">Control</span></h1>
                <p id="doc-label" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1 italic">Verificando Credenciales...</p>
            </div>
            <button onclick="window.location.href='asistente.html'" class="px-6 py-2 bg-slate-100 rounded-full text-[10px] font-black uppercase text-slate-500 hover:bg-slate-200 transition">‚Üê Volver al Radar</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <section class="card-elite p-6 space-y-5">
                <h3 class="text-[11px] font-black uppercase border-l-4 border-slate-900 pl-3">Turnos Operativos</h3>
                <div id="contenedor-semana" class="space-y-2"></div>
                <button id="btnGuardarSemana" class="btn-black">Actualizar Turnos ‚ú¶</button>
            </section>

            <section class="card-elite p-6 space-y-5">
                <h3 class="text-[11px] font-black uppercase border-l-4 border-red-600 pl-3 text-red-600">Bloqueos de Agenda</h3>
                <div class="space-y-3">
                    <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Fecha de Cierre</label>
                    <input type="date" id="b-fecha" class="input-kb uppercase">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Inicio</label>
                            <input type="time" id="b-inicio" class="input-kb" value="00:00">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Fin</label>
                            <input type="time" id="b-fin" class="input-kb" value="23:59">
                        </div>
                    </div>
                    <button id="btnBloquear" class="btn-black !bg-red-600">Inyectar Bloqueo</button>
                </div>
                <div id="lista-bloqueos" class="space-y-2 max-h-48 overflow-y-auto custom-scroll pr-1"></div>
            </section>

            <section class="card-elite p-6 space-y-5">
                <h3 class="text-[11px] font-black uppercase border-l-4 border-[#c5a059] pl-3">Servicios & Tiempos</h3>
                <div id="lista-servicios" class="space-y-4 max-h-[450px] overflow-y-auto custom-scroll pr-1"></div>
                <div class="pt-2 space-y-2">
                    <button id="btnAddSrv" class="w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-[10px] font-bold text-slate-400 hover:bg-slate-50 transition">+ Nuevo Nodo</button>
                    <button id="btnGuardarSrv" class="btn-black">Guardar Cat√°logo</button>
                </div>
            </section>

        </div>
    </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
  'https://ctvqjnckxmqeejbfwmkj.supabase.co',
  'sb_publishable__JScNe1oUvVbV4Vww69CLg_6EasQg3w'
);

let docId = null;

// --- INICIO DE OPERACIONES ---
async function init() {
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    alert("Sesi√≥n no detectada. Redirigiendo...");
    window.location.href = 'login.html';
    return;
  }

  docId = user.id;

  // Cargar nombre del b√∫nker
  const { data: perfil } = await supabase.from('Usuarios').select('nombre').eq('id', docId).single();
  if (perfil) document.getElementById('doc-label').innerText = `ID: DR. ${perfil.nombre.toUpperCase()}`;

  await Promise.all([cargarSemana(), cargarBloqueos(), cargarServicios()]);
}

// --- üß¨ L√ìGICA DE HORARIOS ---
async function cargarSemana() {
  const { data } = await supabase.from('Horarios_Doctor').select('*').eq('doctor_id', docId);
  const dias = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
  
  document.getElementById('contenedor-semana').innerHTML = dias.map((d,i)=>{
    const c = data?.find(h => h.dia_semana === i+1) || {activo:false, hora_inicio:"09:00:00", hora_fin:"17:00:00"};
    return `
      <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
        <div class="flex items-center gap-3">
          <input type="checkbox" class="chk w-5 h-5 accent-black" ${c.activo?'checked':''} data-dia="${i+1}">
          <span class="text-[10px] font-bold uppercase text-slate-500">${d}</span>
        </div>
        <div class="flex gap-2 text-[10px] font-black text-slate-900">
          <input type="time" value="${c.hora_inicio.slice(0,5)}" class="ini bg-transparent border-none outline-none">
          <span class="text-slate-300">/</span>
          <input type="time" value="${c.hora_fin.slice(0,5)}" class="fin bg-transparent border-none outline-none">
        </div>
      </div>`;
  }).join('');
}

document.getElementById('btnGuardarSemana').onclick = async () => {
  if (!docId) return;
  const btn = document.getElementById('btnGuardarSemana');
  btn.innerText = "SINCRONIZANDO...";
  
  await supabase.from('Horarios_Doctor').delete().eq('doctor_id', docId);

  const filas = document.querySelectorAll('#contenedor-semana > div');
  const registros = [];

  filas.forEach(f => {
    const chk = f.querySelector('.chk');
    if(chk.checked){
      registros.push({
        doctor_id: docId,
        dia_semana: parseInt(chk.dataset.dia),
        hora_inicio: f.querySelector('.ini').value + ":00",
        hora_fin: f.querySelector('.fin').value + ":00",
        activo: true
      });
    }
  });

  if (registros.length > 0) await supabase.from('Horarios_Doctor').insert(registros);
  
  btn.innerText = "Actualizar Turnos ‚ú¶";
  alert("‚ú¶ HORARIOS ACTUALIZADOS");
  cargarSemana();
};

// --- üö´ L√ìGICA DE BLOQUEOS ---
async function cargarBloqueos() {
  const hoy = new Date().toISOString().slice(0,10);
  const { data } = await supabase.from('Bloqueos').select('*').eq('doctor_id', docId).gte('fecha', hoy).order('fecha', { ascending: true });

  document.getElementById('lista-bloqueos').innerHTML = data?.map(b => `
    <div class="flex justify-between bg-red-50 p-3 rounded-xl text-[9px] font-bold uppercase border border-red-100 mt-2">
      <span class="text-red-800">${b.fecha} | ${b.hora_inicio.slice(0,5)} - ${b.hora_fin.slice(0,5)}</span>
      <button onclick="borrarBloqueo('${b.id}')" class="font-black text-red-400 hover:text-red-700">‚úï</button>
    </div>
  `).join('') || '<p class="text-[9px] text-center text-slate-300 py-4 uppercase">Sin bloqueos</p>';
}

document.getElementById('btnBloquear').onclick = async () => {
  const fecha = document.getElementById('b-fecha').value;
  if(!fecha) return alert("Selecciona fecha");

  await supabase.from('Bloqueos').insert({
    doctor_id: docId,
    fecha: fecha,
    hora_inicio: document.getElementById('b-inicio').value + ":00",
    hora_fin: document.getElementById('b-fin').value + ":00"
  });

  alert("‚ú¶ BLOQUEO INYECTADO");
  cargarBloqueos();
};

window.borrarBloqueo = async (id) => {
  await supabase.from('Bloqueos').delete().eq('id', id);
  cargarBloqueos();
};

// --- üíé L√ìGICA DE SERVICIOS ---
function renderServicio(s = {}) {
  const div = document.createElement('div');
  div.className = "srv bg-slate-50 p-4 rounded-xl border border-slate-100 space-y-3";
  div.dataset.id = s.id || '';

  div.innerHTML = `
    <input type="text" class="nombre input-kb !p-2 text-[10px] font-bold uppercase bg-white" 
      value="${s.nombre || ''}" placeholder="SERVICIO">
    <div class="grid grid-cols-3 gap-2">
      <div><label class="text-[7px] font-black text-slate-400 ml-1 uppercase">Costo ($)</label>
        <input type="number" class="precio input-kb !p-2 text-xs" value="${s.precio || 0}"></div>
      <div><label class="text-[7px] font-black text-slate-400 ml-1 uppercase">Cita (Min)</label>
        <input type="number" class="dur input-kb !p-2 text-xs" value="${s.duracion_min || 30}"></div>
      <div><label class="text-[7px] font-black text-slate-400 ml-1 uppercase">Buffer (Min)</label>
        <input type="number" class="buf input-kb !p-2 text-xs" value="${s.buffer_min || 0}"></div>
    </div>
  `;
  document.getElementById('lista-servicios').appendChild(div);
}

async function cargarServicios() {
  const { data } = await supabase.from('Servicios').select('*').eq('doctor_id', docId).eq('activo', true);
  const cont = document.getElementById('lista-servicios');
  cont.innerHTML = '';
  data?.forEach(s => renderServicio(s));
}

document.getElementById('btnGuardarSrv').onclick = async () => {
  const items = document.querySelectorAll('.srv');
  for (const i of items) {
    const nombre = i.querySelector('.nombre').value.trim();
    if(!nombre) continue;

    const payload = {
      doctor_id: docId,
      nombre: nombre.toUpperCase(),
      precio: parseFloat(i.querySelector('.precio').value) || 0,
      duracion_min: parseInt(i.querySelector('.dur').value) || 0,
      buffer_min: parseInt(i.querySelector('.buf').value) || 0,
      activo: true
    };
    if(i.dataset.id) payload.id = i.dataset.id;
    await supabase.from('Servicios').upsert(payload);
  }
  alert("‚ú¶ SERVICIOS SINCRONIZADOS");
  cargarServicios();
};

document.getElementById('btnAddSrv').onclick = () => renderServicio();

// LANZAR INICIO
init();
</script>
</body>
</html>
